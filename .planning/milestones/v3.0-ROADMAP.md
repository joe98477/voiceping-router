# Milestone v3.0: mediasoup Library Integration

**Status:** SHIPPED 2026-02-15
**Phases:** 11-15
**Total Plans:** 10

## Overview

Wired the actual libmediasoup-android library into the existing MediasoupClient skeleton to enable real bidirectional WebRTC voice audio on Android. Replaced all stub/TODO code with real library calls for Device initialization, RecvTransport/Consumer (receive audio), SendTransport/Producer (transmit audio), and lifecycle management. Validated on physical hardware with release APK.

## Phases

### Phase 11: Library Upgrade and WebRTC Foundation
**Goal**: Establish WebRTC subsystem and resolve AudioManager ownership before audio integration
**Depends on**: Phase 10 (v2.0 complete)
**Requirements**: WEBRTC-01, WEBRTC-02, WEBRTC-03, WEBRTC-04
**Success Criteria**:
  1. App compiles with libmediasoup-android 0.21.0 dependency
  2. PeerConnectionFactory initializes with echo cancellation and noise suppression enabled
  3. AudioRouter coordinates with WebRTC's AudioDeviceModule without MODE_IN_COMMUNICATION conflicts
  4. Device loads server RTP capabilities and returns its own RTP capabilities
**Plans**: 2 plans

Plans:
- [x] 11-01-PLAN.md -- Dependency upgrade, WebRTC init, AudioRouter coordination flag
- [x] 11-02-PLAN.md -- PeerConnectionFactory with AudioDeviceModule, Device RTP capabilities

### Phase 12: Device and RecvTransport Integration
**Goal**: Wire RecvTransport and Consumer creation for receiving remote audio producers
**Depends on**: Phase 11 (WebRTC foundation established)
**Requirements**: RECV-01, RECV-02, RECV-03, RECV-04, RECV-05
**Success Criteria**:
  1. RecvTransport created with server parameters and onConnect callback bridges DTLS to signaling
  2. Consumer created from remote producer and audio playback begins automatically
  3. Per-consumer volume control adjusts playback level
  4. Consumer closes cleanly when user leaves channel
  5. Consumer statistics available for network quality indicator
**Plans**: 2 plans

Plans:
- [x] 12-01-PLAN.md -- RecvTransport creation, Consumer lifecycle, volume control, cleanup
- [x] 12-02-PLAN.md -- Consumer statistics for network quality indicator

### Phase 13: SendTransport and Producer Integration
**Goal**: Wire SendTransport and Producer creation for transmitting local microphone audio via PTT
**Depends on**: Phase 12 (RecvTransport validated)
**Requirements**: SEND-01, SEND-02, SEND-03, SEND-04, SEND-05
**Success Criteria**:
  1. SendTransport created with server parameters, onConnect and onProduce callbacks bridge to signaling
  2. AudioTrack created via PeerConnectionFactory for microphone capture
  3. Producer created with Opus PTT config when user presses PTT button
  4. Producer closed and audio capture stopped when user releases PTT button
  5. AudioCaptureManager removed from codebase
**Plans**: 2 plans

Plans:
- [x] 13-01-PLAN.md -- SendTransport creation, Producer lifecycle with AudioSource/AudioTrack and Opus config
- [x] 13-02-PLAN.md -- PttManager refactor and AudioCaptureManager deletion

### Phase 14: Cleanup Lifecycle and Reconnection Resilience
**Goal**: Implement ordered disposal and state machine for production-ready lifecycle management
**Depends on**: Phase 13 (Producer/Consumer working)
**Requirements**: LIFE-01, LIFE-02, LIFE-03, LIFE-04
**Success Criteria**:
  1. Resources disposed in correct order on disconnect
  2. transportclose events handled for both send and recv transports
  3. Reconnection uses Mutex-based state machine
  4. Rapid PTT press/release doesn't cause duplicate producers
**Plans**: 2 plans

Plans:
- [x] 14-01-PLAN.md -- Mutex-protected transport lifecycle and correct disposal ordering
- [x] 14-02-PLAN.md -- Transport error recovery handlers and ChannelRepository disconnect cleanup

### Phase 15: Release Build Validation and Device Testing
**Goal**: Verify ProGuard rules and validate end-to-end audio on physical Android device
**Depends on**: Phase 14 (Lifecycle complete)
**Requirements**: VALID-01, VALID-02, VALID-03
**Success Criteria**:
  1. ProGuard/R8 rules verified — release APK built without JNI class stripping
  2. Release APK tested on physical Android device with end-to-end audio
  3. Battery profiling shows no excessive drain (under 10%/hour with screen off)
**Plans**: 2 plans

Plans:
- [x] 15-01-PLAN.md -- ProGuard/R8 rule update and release APK build verification
- [x] 15-02-PLAN.md -- Physical device end-to-end audio testing and battery profiling

---

## Milestone Summary

**Key Decisions:**
- Use PeerConnectionFactory.initialize() not MediasoupClient.initialize() — crow-misia API differs from haiyangwu wrapper
- Device(peerConnectionFactory) constructor pattern — crow-misia 0.21.0 requires factory parameter
- runBlocking bridge for Transport callbacks — Native JNI threads need blocking bridge to suspend functions
- Per-channel RecvTransport map — Multi-channel monitoring requires independent transport lifecycle
- SendTransport singleton (no channelId) — PTT is mutually exclusive, one transport per device
- WebRTC AudioSource for PTT capture — Replaces AudioCaptureManager callback pattern
- Delete AudioCaptureManager entirely — WebRTC AudioSource handles all microphone capture
- Kotlin Mutex instead of synchronized for suspend functions in transport lifecycle
- @Volatile producingRequested flag for produce/stop race condition
- try-catch telephonyManager.callState instead of READ_PHONE_STATE permission
- Enable full R8 optimization (no -dontobfuscate) for production builds

**Issues Resolved:**
- SecurityException crash on Android 16 Samsung (READ_PHONE_STATE requirement for getCallState)
- Producer race condition causing audio-only-transmits-once (700ms blocking produce call)
- Wrong channel in onProduce when switching channels (stale sendTransportChannelId)
- HapticFeedback amplitude bug, JsonNull crashes, consumer tracking, POST_NOTIFICATIONS permission
- Audio routing with setCommunicationDevice API 31+
- Multi-channel recv transport lifecycle

**Issues Deferred:**
- Multi-server state consistency strategy for distributed Redis pub/sub
- Replace self-signed certificates with real TLS for production
- HW-02 rugged phone dedicated PTT (hardware unavailable)

**Technical Debt Incurred:**
- Consumer.getStats() returns stub "Good" quality (API undocumented in crow-misia library)
- No automated integration tests for mediasoup audio pipeline (requires physical device + server)

---

_For current project status, see .planning/ROADMAP.md_
