---
phase: 08-multi-channel-monitoring-scan-mode
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
autonomous: true

must_haves:
  truths:
    - "Bottom bar shows primary channel by default when no other channel has active speaker"
    - "Bottom bar instantly swaps to show non-primary channel when someone transmits on it (scan mode)"
    - "Bottom bar returns to primary channel 2-5 seconds after transmission ends"
    - "When multiple non-primary channels active, bottom bar shows most recently started transmission"
    - "User can tap bottom bar to lock it to current channel, tap again to unlock"
    - "Channel rows show filled/solid background for joined channels, outlined for unjoined"
    - "Long-press any joined channel to set it as primary (star badge shown)"
    - "Joining a 6th channel shows toast: Maximum 5 channels. Leave a channel to join another."
    - "PTT targets channel based on PTT target mode setting"
    - "Bottom bar channel switch is silent — no tone/beep, only incoming audio"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt"
      provides: "Scan mode logic, displayed channel derivation, PTT target"
      contains: "displayedChannelId"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt"
      provides: "Scan mode bottom bar with lock indicator and channel color"
      contains: "isLocked"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt"
      provides: "Multi-join channel rows with primary badge and filled/outlined states"
      contains: "isPrimary"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt"
      provides: "Multi-channel screen with scan mode return effect and mute-all action"
      contains: "rememberUpdatedState"
  key_links:
    - from: "ChannelListViewModel.kt"
      to: "ChannelRepository.kt"
      via: "monitoredChannels and primaryChannelId flows"
      pattern: "channelRepository\\.monitoredChannels"
    - from: "ChannelListScreen.kt"
      to: "ChannelListViewModel.kt"
      via: "displayedChannelId, scanModeEnabled, scanModeLocked state flows"
      pattern: "viewModel\\.displayedChannelId"
    - from: "BottomBar.kt"
      to: "ChannelListScreen.kt"
      via: "isPrimaryChannel and isLocked props for visual differentiation"
      pattern: "isPrimaryChannel"
---

<objective>
Implement scan mode logic in ViewModel and update all UI components for multi-channel monitoring with scan mode bottom bar.

Purpose: The ViewModel derives which channel to display in the bottom bar based on active speakers across monitored channels (scan mode). The UI must reflect multi-channel join state (filled/outlined), primary channel (star badge), scan mode lock (tap to lock/unlock), and PTT targeting. This plan delivers the core user-facing scan mode experience.

Output: Updated ViewModel with scan mode logic + updated BottomBar, ChannelRow, and ChannelListScreen.

Note on complexity: This plan has high integration surface (ViewModel + 3 UI files) but splitting further would create problematic cross-file dependencies (BottomBar/ChannelRow/ChannelListScreen must all change together since the screen passes props to the components). Task 1 (ViewModel only, ~1 file) and Task 2 (3 UI files, all tightly coupled) are the smallest reasonable split. If context exceeds ~60%, prioritize Task 1 (ViewModel) and defer Task 2 to a follow-up plan.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-multi-channel-monitoring-scan-mode/08-RESEARCH.md
@.planning/phases/08-multi-channel-monitoring-scan-mode/08-02-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
@android/app/src/main/java/com/voiceping/android/domain/model/ChannelMonitoringState.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement scan mode logic in ChannelListViewModel</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
  </files>
  <action>
    Rewrite ChannelListViewModel for multi-channel monitoring with scan mode derived state.

    **Replace single-channel state with multi-channel:**
    - Remove `_joinedChannel: MutableStateFlow<Channel?>` and its public `joinedChannel`
    - Remove single `currentSpeaker` and `lastSpeaker` delegations (now per-channel in ChannelMonitoringState)
    - Add: `val monitoredChannels: StateFlow<Map<String, ChannelMonitoringState>> = channelRepository.monitoredChannels`
    - Add: `val primaryChannelId: StateFlow<String?> = channelRepository.primaryChannelId`

    **Add scan mode state:**
    ```kotlin
    private val _scanModeLocked = MutableStateFlow(false)
    val scanModeLocked: StateFlow<Boolean> = _scanModeLocked.asStateFlow()

    private val _manuallySelectedChannelId = MutableStateFlow<String?>(null)
    ```

    **Add settings flows (stateIn pattern like existing):**
    ```kotlin
    val scanModeEnabled: StateFlow<Boolean> = settingsRepository.getScanModeEnabled()
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), true)

    val scanReturnDelay: StateFlow<Int> = settingsRepository.getScanReturnDelay()
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), 2)

    val pttTargetMode: StateFlow<PttTargetMode> = settingsRepository.getPttTargetMode()
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), PttTargetMode.ALWAYS_PRIMARY)

    val audioMixMode: StateFlow<AudioMixMode> = settingsRepository.getAudioMixMode()
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), AudioMixMode.EQUAL_VOLUME)
    ```

    **Derive displayed channel ID (core scan logic):**
    ```kotlin
    val displayedChannelId: StateFlow<String?> = combine(
        monitoredChannels,
        primaryChannelId,
        _scanModeLocked,
        _manuallySelectedChannelId,
        scanModeEnabled
    ) { channels, primary, locked, manual, scanEnabled ->
        when {
            channels.isEmpty() -> null
            locked && manual != null -> manual  // Manual lock takes priority
            !scanEnabled -> primary  // Scan disabled, show primary
            else -> {
                // Scan mode: find most recent active non-primary speaker
                val activeNonPrimary = channels.values
                    .filter { it.currentSpeaker != null && !it.isPrimary && !it.isMuted }
                    .sortedByDescending { it.speakerStartTime }

                activeNonPrimary.firstOrNull()?.channelId ?: primary
            }
        }
    }.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), null)
    ```
    Per user decision: "most recently started transmission" uses speakerStartTime sort.
    Muted channels excluded per user decision: "Muted channels show NO visual activity indicators."

    **Add toggleBottomBarLock():**
    Per user decision: tap bottom bar to lock, tap again to unlock.
    ```kotlin
    fun toggleBottomBarLock() {
        val current = displayedChannelId.value
        if (_scanModeLocked.value) {
            // Unlock: return to scan mode
            _scanModeLocked.value = false
            _manuallySelectedChannelId.value = null
        } else {
            // Lock: freeze on current channel
            _scanModeLocked.value = true
            _manuallySelectedChannelId.value = current
        }
    }
    ```

    **Add returnToPrimaryChannel():**
    Called by scan mode return timer in ChannelListScreen.
    ```kotlin
    fun returnToPrimaryChannel() {
        if (!_scanModeLocked.value) {
            // displayedChannelId will naturally resolve to primary when no active speakers
            // This is a no-op signal - the combine flow handles it
        }
    }
    ```

    **Rewrite toggleChannel(channel: Channel):**
    Multi-channel join/leave logic:
    ```kotlin
    fun toggleChannel(channel: Channel) {
        viewModelScope.launch {
            val isCurrentlyJoined = monitoredChannels.value.containsKey(channel.id)

            if (isCurrentlyJoined) {
                // Leave this channel
                val result = channelRepository.leaveChannel(channel.id)
                if (result.isFailure) {
                    Log.e(TAG, "Failed to leave channel", result.exceptionOrNull())
                }
            } else {
                // Join this channel (may fail if at 5-channel limit)
                val result = channelRepository.joinChannel(channel.id, channel.name, channel.teamName)
                if (result.isSuccess) {
                    // Check battery optimization on first channel join
                    if (!hasCheckedBatteryOptimization) {
                        checkBatteryOptimization()
                        hasCheckedBatteryOptimization = true
                    }
                } else {
                    val error = result.exceptionOrNull()?.message ?: "Failed to join channel"
                    _toastMessage.value = error  // Show toast for max 5 limit
                    Log.e(TAG, "Failed to join channel: $error")
                }
            }
        }
    }
    ```

    **Add toast message state:**
    ```kotlin
    private val _toastMessage = MutableStateFlow<String?>(null)
    val toastMessage: StateFlow<String?> = _toastMessage.asStateFlow()

    fun clearToastMessage() {
        _toastMessage.value = null
    }
    ```

    **Add setPrimaryChannel(channelId: String):**
    ```kotlin
    fun setPrimaryChannel(channelId: String) {
        channelRepository.setPrimaryChannel(channelId)
    }
    ```

    **Update onPttPressed():**
    PTT target depends on PTT target mode setting:
    ```kotlin
    fun onPttPressed() {
        if (!channelRepository.hasMicPermission()) {
            _needsMicPermission.value = true
            return
        }

        // Determine PTT target based on setting
        val targetChannelId = when (pttTargetMode.value) {
            PttTargetMode.ALWAYS_PRIMARY -> primaryChannelId.value
            PttTargetMode.DISPLAYED_CHANNEL -> displayedChannelId.value
        }

        if (targetChannelId == null) {
            Log.w(TAG, "No channel to target for PTT")
            return
        }

        pttManager.requestPtt(targetChannelId)
    }
    ```

    **Update init block:**
    - Remove the single-channel joinedChannelId observer
    - Keep settings observers for PttManager (pttMode, toggleMaxDuration)

    **Update onCleared:** Call channelRepository.disconnectAll()

    **Settings setters (delegate to settingsRepository):**
    ```kotlin
    fun setScanModeEnabled(enabled: Boolean) = viewModelScope.launch { settingsRepository.setScanModeEnabled(enabled) }
    fun setScanReturnDelay(seconds: Int) = viewModelScope.launch { settingsRepository.setScanReturnDelay(seconds) }
    fun setPttTargetMode(mode: PttTargetMode) = viewModelScope.launch { settingsRepository.setPttTargetMode(mode) }
    fun setAudioMixMode(mode: AudioMixMode) = viewModelScope.launch { settingsRepository.setAudioMixMode(mode) }
    ```

    **Add muteAllExceptPrimary() and unmuteAllChannels() delegating to ChannelRepository.**

    Use `import kotlinx.coroutines.flow.combine` for the 5-flow combine.
  </action>
  <verify>
    Confirm ChannelListViewModel.kt contains:
    - `monitoredChannels`, `primaryChannelId`, `displayedChannelId` StateFlows
    - `scanModeLocked`, `scanModeEnabled`, `scanReturnDelay`, `pttTargetMode`, `audioMixMode` StateFlows
    - `toggleBottomBarLock()` method
    - `toggleChannel()` with multi-channel join/leave
    - `onPttPressed()` using pttTargetMode
    - `_toastMessage` for max 5 limit feedback
    - `setPrimaryChannel()`, `setScanModeEnabled()`, settings setters
    - `combine` import and 5-flow combine for displayedChannelId
  </verify>
  <done>
    ViewModel derives displayedChannelId from active speakers across monitored channels (most recent wins). Lock/unlock toggles scan mode pause. PTT targets based on setting (always primary or displayed channel). Toast message for max 5 channel limit. All scan settings exposed as StateFlows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update BottomBar, ChannelRow, and ChannelListScreen for scan mode UI</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  </files>
  <action>
    **BottomBar.kt — Update for scan mode display:**

    Change signature to accept multi-channel scan mode params:
    ```kotlin
    @Composable
    fun BottomBar(
        displayedChannelName: String?,
        isPrimaryChannel: Boolean,
        isLocked: Boolean,
        currentSpeaker: User?,
        pttState: PttState,
        pttMode: PttMode,
        transmissionDuration: Long,
        onToggleLock: () -> Unit,
        onPttPressed: () -> Unit,
        onPttReleased: () -> Unit
    )
    ```

    Changes:
    - Replace `joinedChannel: Channel?` with `displayedChannelName: String?`
    - Add `isPrimaryChannel: Boolean`, `isLocked: Boolean`, `onToggleLock: () -> Unit`
    - Make entire left side clickable for lock toggle: `.clickable { onToggleLock() }` on the left Column or the Surface
    - Channel name color: primary color (cyan) when showing scanned non-primary channel, normal onSurface when primary. Per user decision: "Channel name color change to distinguish when showing a scanned (non-primary) channel vs primary"
    - Add lock indicator: when isLocked, show small lock icon or "Locked" text below channel name
    - No animation on channel switch (per user decision: "Instant swap, no animation")
    - **Silent switch:** No audio tone, beep, or sound effect when the bottom bar changes channels. Per user decision: "Silent switch — no tone/beep when bottom bar changes channels; incoming audio itself is the signal". The bottom bar is purely visual — only the per-channel RX squelch (managed by ChannelRepository in observeSpeakerChangesForChannel) plays when a speaker starts on any channel. Verify NO `SoundPool.play()`, `MediaPlayer.start()`, or `ToneGenerator` calls are triggered by the channel display change in BottomBar or displayedChannelId derivation.

    ```kotlin
    // Channel name color per user decision
    Text(
        text = displayedChannelName ?: "No channel",
        style = MaterialTheme.typography.bodyMedium,
        color = if (isPrimaryChannel) {
            MaterialTheme.colorScheme.onSurface
        } else {
            MaterialTheme.colorScheme.primary  // Cyan for scanned channel
        }
    )

    // Status text
    when {
        pttState is PttState.Transmitting -> Text("Transmitting...", color = Color(0xFFD32F2F))
        currentSpeaker != null -> Text(currentSpeaker.name, color = MaterialTheme.colorScheme.primary)
        isLocked -> Text("Locked", color = MaterialTheme.colorScheme.onSurfaceVariant)
        else -> Text("Listening...", color = MaterialTheme.colorScheme.onSurfaceVariant)
    }
    ```

    When displayedChannelName is null (no channels joined), show "No channel selected" (same as before).

    **ChannelRow.kt — Update for multi-channel visual state:**

    Change signature:
    ```kotlin
    @Composable
    fun ChannelRow(
        channel: Channel,
        isJoined: Boolean,
        isPrimary: Boolean,
        isMuted: Boolean,
        currentSpeaker: User?,
        lastSpeaker: User?,
        lastSpeakerVisible: Boolean,
        onToggle: () -> Unit,
        onLongPress: () -> Unit
    )
    ```

    Changes:
    - Add `isPrimary: Boolean`, `isMuted: Boolean`, `onLongPress: () -> Unit` params
    - Remove `channel.currentSpeaker` usage (now passed as separate param from monitored state)
    - Add `combinedClickable` for tap (onToggle) and long-press (onLongPress = set as primary):
      ```kotlin
      .combinedClickable(
          onClick = onToggle,
          onLongClick = onLongPress
      )
      ```
      Import: `import androidx.compose.foundation.combinedClickable` and `import androidx.compose.foundation.ExperimentalFoundationApi`
    - Visual state per user decision:
      - Joined: filled/solid background (`MaterialTheme.colorScheme.surfaceVariant`)
      - Unjoined: outlined or dimmed (transparent background with border `MaterialTheme.colorScheme.outline`)
      - Primary: star icon badge (`Icons.Default.Star`) in top-right corner of the row. Size 16.dp, tinted cyan.
      - Muted: dimmed appearance (lower alpha, no speaker indicators)
    - Remove Checkbox (Phase 5 artifact) — replace with filled/outlined visual distinction
    - If muted: show no speaker indicators at all per user decision
    - If muted: no border color animation, no pulse

    **ChannelListScreen.kt — Update for multi-channel + scan mode:**

    Major changes:
    1. Replace single-channel state collection with multi-channel:
       ```kotlin
       val monitoredChannels by viewModel.monitoredChannels.collectAsState()
       val primaryChannelId by viewModel.primaryChannelId.collectAsState()
       val displayedChannelId by viewModel.displayedChannelId.collectAsState()
       val scanModeEnabled by viewModel.scanModeEnabled.collectAsState()
       val scanModeLocked by viewModel.scanModeLocked.collectAsState()
       val scanReturnDelay by viewModel.scanReturnDelay.collectAsState()
       val pttTargetMode by viewModel.pttTargetMode.collectAsState()
       val audioMixMode by viewModel.audioMixMode.collectAsState()
       val toastMessage by viewModel.toastMessage.collectAsState()
       ```

    2. Derive displayed channel state for BottomBar:
       ```kotlin
       val displayedChannel = monitoredChannels[displayedChannelId]
       val displayedChannelName = displayedChannel?.channelName
       val isPrimaryDisplayed = displayedChannel?.isPrimary ?: true
       val displayedSpeaker = displayedChannel?.currentSpeaker
       ```

    3. Add scan mode return effect (delayed return to primary):
       Per research: use rememberUpdatedState to avoid effect restart.
       ```kotlin
       // Scan mode return effect
       if (scanModeEnabled && !scanModeLocked) {
           val currentPrimary by rememberUpdatedState(primaryChannelId)
           val currentDisplayed by rememberUpdatedState(displayedChannelId)

           // Find if any non-primary channel has active speaker
           val anyNonPrimaryActive = monitoredChannels.values.any {
               it.currentSpeaker != null && !it.isPrimary && !it.isMuted
           }

           LaunchedEffect(anyNonPrimaryActive) {
               if (!anyNonPrimaryActive && currentDisplayed != null && currentDisplayed != currentPrimary) {
                   delay(scanReturnDelay * 1000L)
                   viewModel.returnToPrimaryChannel()
               }
           }
       }
       ```
       Import: `import androidx.compose.runtime.rememberUpdatedState`

    4. Add toast message handling:
       ```kotlin
       val context = LocalContext.current
       LaunchedEffect(toastMessage) {
           toastMessage?.let {
               android.widget.Toast.makeText(context, it, android.widget.Toast.LENGTH_SHORT).show()
               viewModel.clearToastMessage()
           }
       }
       ```

    5. Add "Mute all except primary" button in top bar (IconButton with VolumeOff icon):
       Per user decision: quick action in the top bar.
       ```kotlin
       // In TopAppBar actions, before connection dot:
       if (monitoredChannels.size > 1) {
           IconButton(onClick = { viewModel.muteAllExceptPrimary() }) {
               Icon(Icons.Default.VolumeOff, contentDescription = "Mute all except primary")
           }
       }
       ```
       Import: `import androidx.compose.material.icons.filled.VolumeOff`

    6. Update BottomBar call site with new params:
       ```kotlin
       BottomBar(
           displayedChannelName = displayedChannelName,
           isPrimaryChannel = isPrimaryDisplayed,
           isLocked = scanModeLocked,
           currentSpeaker = displayedSpeaker,
           pttState = pttState,
           pttMode = pttMode,
           transmissionDuration = transmissionDuration,
           onToggleLock = { viewModel.toggleBottomBarLock() },
           onPttPressed = { viewModel.onPttPressed() },
           onPttReleased = { viewModel.onPttReleased() }
       )
       ```

    7. Update ChannelRow usage in LazyColumn:
       For each channel, look up its monitoring state to pass per-channel speaker info:
       ```kotlin
       items(teamChannels) { channel ->
           val monitorState = monitoredChannels[channel.id]
           val isJoined = monitorState != null
           val isPrimary = monitorState?.isPrimary ?: false
           val isMuted = monitorState?.isMuted ?: false
           val channelSpeaker = monitorState?.currentSpeaker
           val channelLastSpeaker = monitorState?.lastSpeaker

           ChannelRow(
               channel = channel,
               isJoined = isJoined,
               isPrimary = isPrimary,
               isMuted = isMuted,
               currentSpeaker = channelSpeaker,
               lastSpeaker = channelLastSpeaker,
               lastSpeakerVisible = channelLastSpeaker != null,
               onToggle = { viewModel.toggleChannel(channel) },
               onLongPress = {
                   if (isJoined) viewModel.setPrimaryChannel(channel.id)
               }
           )
       }
       ```

    8. Update ProfileDrawer call to pass new scan mode settings — add params for scan mode section. This will be wired in Plan 04 where ProfileDrawer is updated. For now, keep existing ProfileDrawer params unchanged.
  </action>
  <verify>
    Confirm:
    - BottomBar accepts scan mode params (isPrimaryChannel, isLocked, onToggleLock) and uses color logic
    - ChannelRow accepts isPrimary, isMuted, onLongPress; uses combinedClickable; shows star badge for primary; filled/outlined visual states
    - ChannelListScreen collects all multi-channel + scan mode StateFlows
    - Scan mode return effect uses rememberUpdatedState pattern
    - Toast message displays for max 5 limit
    - Mute-all button in top bar
    - ChannelRow no longer uses Checkbox
  </verify>
  <done>
    Bottom bar shows primary channel by default, instantly swaps to active scanned channel (cyan name), returns to primary after configurable delay. Tap to lock/unlock bottom bar. Channel rows show filled/outlined for joined/unjoined, star badge for primary, dimmed when muted. Long-press to set primary. Toast for max 5 limit. Mute-all-except-primary quick action in top bar. PTT targets based on setting.
  </done>
</task>

</tasks>

<verification>
1. BottomBar instantly swaps channel name (no animation) when scan mode activates
2. Channel name is cyan when showing non-primary scanned channel, normal when primary
3. Tap bottom bar to lock, tap again to unlock
4. Scan mode return delay works (2-5s configurable, uses rememberUpdatedState)
5. Channel rows show filled/outlined for joined/unjoined visual states
6. Star badge on primary channel row
7. Long-press joined channel to set as primary
8. Toast shows "Maximum 5 channels..." on 6th join attempt
9. Mute-all-except-primary button appears when 2+ channels joined
10. PTT targets correct channel based on pttTargetMode setting
11. Bottom bar channel switch is SILENT — no tone/beep/sound effect on displayedChannelId change (per-channel RX squelch is separate, handled by ChannelRepository)
</verification>

<success_criteria>
- Scan mode bottom bar works: primary by default, auto-switch to active, return after delay
- Lock/unlock pauses scan auto-switching
- Multi-channel visual states clear: joined vs unjoined, primary vs secondary, muted vs active
- PTT target follows setting (always primary or displayed channel)
- Max 5 channel limit shows user-friendly toast
</success_criteria>

<output>
After completion, create `.planning/phases/08-multi-channel-monitoring-scan-mode/08-03-SUMMARY.md`
</output>
