---
phase: 08-multi-channel-monitoring-scan-mode
plan: 04
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelVolumeDialog.kt
autonomous: true

must_haves:
  truths:
    - "Profile drawer has Scan Mode settings section with toggle, PTT target, return delay slider, audio mix mode"
    - "Per-channel volume control accessible via settings icon on channel row — slider onVolumeChanged calls viewModel.setChannelVolume()"
    - "Audio mix mode setting change triggers applyAudioMixMode via ViewModel setter"
    - "All scan mode settings persist across sessions via DataStore"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt"
      provides: "Scan mode settings section"
      contains: "Scan Mode"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelVolumeDialog.kt"
      provides: "Per-channel volume slider dialog"
      contains: "ChannelVolumeDialog"
  key_links:
    - from: "ProfileDrawer.kt"
      to: "ChannelListViewModel.kt"
      via: "callback props for scan mode settings"
      pattern: "onScanModeEnabledChanged"
    - from: "ChannelVolumeDialog.kt"
      to: "ChannelListScreen.kt"
      via: "Shown from channel row settings icon, onVolumeChanged calls viewModel.setChannelVolume()"
      pattern: "setChannelVolume"
    - from: "ProfileDrawer.kt"
      to: "ChannelListViewModel.kt"
      via: "onAudioMixModeChanged triggers setAudioMixMode which persists and triggers applyAudioMixMode via observer"
      pattern: "onAudioMixModeChanged"
---

<objective>
Add scan mode settings to ProfileDrawer and create per-channel volume control dialog.

Purpose: User needs to configure scan mode behavior (toggle, PTT target, return delay, audio mix mode) via the profile drawer per user decisions. Per-channel volume control (0-100% slider) is accessible via a small settings icon on each channel row. These settings complete the Phase 8 configuration surface.

Output: Updated ProfileDrawer with scan mode section + new ChannelVolumeDialog component.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-multi-channel-monitoring-scan-mode/08-RESEARCH.md
@.planning/phases/08-multi-channel-monitoring-scan-mode/08-02-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scan mode settings section to ProfileDrawer</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
  </files>
  <action>
    Add a "Scan Mode" settings section to ProfileDrawer, positioned between the existing "Audio Tones" section and the menu items (Switch Event, Settings, Logout).

    **Add new parameters to ProfileDrawer composable signature:**
    ```kotlin
    // Scan mode settings
    scanModeEnabled: Boolean = true,
    pttTargetMode: PttTargetMode = PttTargetMode.ALWAYS_PRIMARY,
    scanReturnDelay: Int = 2,
    audioMixMode: AudioMixMode = AudioMixMode.EQUAL_VOLUME,
    onScanModeEnabledChanged: (Boolean) -> Unit = {},
    onPttTargetModeChanged: (PttTargetMode) -> Unit = {},
    onScanReturnDelayChanged: (Int) -> Unit = {},
    onAudioMixModeChanged: (AudioMixMode) -> Unit = {},
    ```

    Import PttTargetMode and AudioMixMode from domain.model.

    **Add Scan Mode section after Audio Tones divider:**

    ```
    Spacer + HorizontalDivider

    "Scan Mode" title (same style as "PTT Settings" — titleSmall, primary color)

    1. Scan Mode Toggle (Switch)
       Label: "Auto-switch channels"
       Description text: "Bottom bar follows active speaker"
       Toggle: scanModeEnabled
       Callback: onScanModeEnabledChanged

    2. PTT Target (Radio buttons, only visible when scan mode enabled)
       Label: "PTT Target"
       Option A: "Always primary" (PttTargetMode.ALWAYS_PRIMARY)
       Option B: "Displayed channel" (PttTargetMode.DISPLAYED_CHANNEL)
       Same radio button pattern as PTT Mode section.

    3. Return Delay Slider (only visible when scan mode enabled)
       Label: "Return delay: ${scanReturnDelay}s"
       Slider: 2f..5f, steps = 2 (for 2, 3, 4, 5 second values)
       Callback: onScanReturnDelayChanged(it.roundToInt())

    4. Audio Mix Mode (Radio buttons)
       Label: "Audio Mix"
       Option A: "Equal volume" (AudioMixMode.EQUAL_VOLUME)
       Option B: "Primary priority" (AudioMixMode.PRIMARY_PRIORITY)
       Description for Primary priority: "Non-primary channels play quieter"
    ```

    Follow the exact same visual patterns (padding, spacing, typography) as existing PTT Settings and Audio Output sections. Use the same RadioButton + Row + selectable pattern.

    The scan mode toggle and return delay use same patterns as existing Toggle mode duration slider. PTT target and audio mix use same pattern as PTT mode radio buttons.
  </action>
  <verify>
    Confirm ProfileDrawer.kt contains:
    - "Scan Mode" section title
    - scanModeEnabled Switch
    - PTT target radio buttons (ALWAYS_PRIMARY, DISPLAYED_CHANNEL)
    - Return delay slider (2-5 seconds)
    - Audio mix mode radio buttons (EQUAL_VOLUME, PRIMARY_PRIORITY)
    - All new parameters in function signature
    - Imports for PttTargetMode and AudioMixMode
  </verify>
  <done>
    ProfileDrawer has complete Scan Mode settings section with toggle, PTT target selection, return delay slider, and audio mix mode selection. All follow existing visual patterns. Settings are connected via callback props.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create per-channel volume dialog and wire to ChannelRow and ChannelListScreen</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelVolumeDialog.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  </files>
  <action>
    Per user decision: "Per-channel volume control (0-100% slider) accessible via small settings icon on each channel row — not in the foreground UI"

    **Create ChannelVolumeDialog.kt:**
    A simple AlertDialog with a volume slider (0-100%) and Mute/Unmute toggle for a specific channel.

    ```kotlin
    @Composable
    fun ChannelVolumeDialog(
        channelName: String,
        volume: Float,          // 0.0-1.0
        isMuted: Boolean,
        onVolumeChanged: (Float) -> Unit,
        onMuteToggled: () -> Unit,
        onDismiss: () -> Unit
    ) {
        AlertDialog(
            onDismissRequest = onDismiss,
            title = { Text(channelName) },
            text = {
                Column {
                    // Volume slider
                    Text("Volume: ${(volume * 100).roundToInt()}%")
                    Slider(
                        value = volume,
                        onValueChange = onVolumeChanged,
                        enabled = !isMuted,
                        valueRange = 0f..1f,
                        modifier = Modifier.fillMaxWidth()
                    )

                    Spacer(modifier = Modifier.height(8.dp))

                    // Mute toggle
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(if (isMuted) "Muted" else "Active")
                        Switch(
                            checked = !isMuted,
                            onCheckedChange = { onMuteToggled() }
                        )
                    }
                }
            },
            confirmButton = {
                TextButton(onClick = onDismiss) {
                    Text("Done")
                }
            }
        )
    }
    ```

    Package: `com.voiceping.android.presentation.channels.components`
    Imports: AlertDialog, Column, Row, Slider, Switch, Text, TextButton from Compose material3.

    **Update ChannelRow.kt:**
    Add a small settings icon (MoreVert or Settings) at the end of joined channel rows that opens the volume dialog.

    Add `onSettingsClick: () -> Unit = {}` parameter to ChannelRow.

    In the Row, after the channel name Column, before the end — only show for joined channels:
    ```kotlin
    if (isJoined) {
        IconButton(
            onClick = onSettingsClick,
            modifier = Modifier.size(32.dp)
        ) {
            Icon(
                Icons.Default.MoreVert,
                contentDescription = "Channel settings",
                modifier = Modifier.size(18.dp),
                tint = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
    ```
    Import: `import androidx.compose.material.icons.filled.MoreVert`

    **Update ChannelListScreen.kt:**
    Add state for the volume dialog:
    ```kotlin
    var volumeDialogChannelId by remember { mutableStateOf<String?>(null) }
    ```

    When volumeDialogChannelId is not null, show ChannelVolumeDialog:
    ```kotlin
    volumeDialogChannelId?.let { channelId ->
        val channelState = monitoredChannels[channelId]
        if (channelState != null) {
            ChannelVolumeDialog(
                channelName = channelState.channelName,
                volume = channelState.volume,
                isMuted = channelState.isMuted,
                onVolumeChanged = { viewModel.setChannelVolume(channelId, it) },
                onMuteToggled = {
                    if (channelState.isMuted) viewModel.unmuteChannel(channelId)
                    else viewModel.muteChannel(channelId)
                },
                onDismiss = { volumeDialogChannelId = null }
            )
        }
    }
    ```

    Wire ChannelRow's onSettingsClick:
    ```kotlin
    onSettingsClick = { volumeDialogChannelId = channel.id }
    ```

    Also wire the ProfileDrawer scan mode settings to the ViewModel:
    Update ProfileDrawer call in ChannelListScreen to pass new scan mode props:
    ```kotlin
    ProfileDrawer(
        // ... existing props ...
        scanModeEnabled = scanModeEnabled,
        pttTargetMode = pttTargetMode,
        scanReturnDelay = scanReturnDelay,
        audioMixMode = audioMixMode,
        onScanModeEnabledChanged = { viewModel.setScanModeEnabled(it) },
        onPttTargetModeChanged = { viewModel.setPttTargetMode(it) },
        onScanReturnDelayChanged = { viewModel.setScanReturnDelay(it) },
        onAudioMixModeChanged = { viewModel.setAudioMixMode(it) },
        // ... existing content lambda ...
    )
    ```

    Add `muteChannel`, `unmuteChannel`, and `setChannelVolume` methods to ChannelListViewModel (delegation to repository):
    These may already exist from Plan 03 via muteAllExceptPrimary delegation. If not, add:
    ```kotlin
    fun muteChannel(channelId: String) = viewModelScope.launch { channelRepository.muteChannel(channelId) }
    fun unmuteChannel(channelId: String) = viewModelScope.launch { channelRepository.unmuteChannel(channelId) }
    fun setChannelVolume(channelId: String, volume: Float) = viewModelScope.launch { channelRepository.setChannelVolume(channelId, volume) }
    ```

    The `setChannelVolume` method delegates to ChannelRepository which calls `mediasoupClient.setConsumerVolume()` (added in Plan 08-02). The Consumer volume property (0.0-1.0 range) is confirmed in research: "Audio volume control: WebRTC Consumer has volume setter (0.0-1.0 range)". The mute toggle uses consumer close pattern for bandwidth savings (different from volume=0).
  </action>
  <verify>
    Confirm:
    - ChannelVolumeDialog.kt exists with volume slider (0-100%) and mute toggle
    - ChannelRow has settings icon (MoreVert) for joined channels with onSettingsClick callback
    - ChannelListScreen has volumeDialogChannelId state and shows dialog when set
    - ChannelVolumeDialog onVolumeChanged calls `viewModel.setChannelVolume(channelId, it)` (NO TODO)
    - ViewModel has `setChannelVolume(channelId, volume)` delegating to ChannelRepository
    - ProfileDrawer receives scan mode props and wired to ViewModel setters
    - AudioMixMode change via ProfileDrawer triggers `viewModel.setAudioMixMode()` which persists to DataStore and triggers `applyAudioMixMode` via ChannelRepository's observer
    - Mute toggle in dialog works (delegates to muteChannel/unmuteChannel)
  </verify>
  <done>
    Per-channel volume dialog accessible via settings icon on joined channel rows. Dialog shows volume slider (wired to setChannelVolume -> Consumer volume) and mute toggle (wired to muteChannel/unmuteChannel -> Consumer close). ProfileDrawer scan mode settings wired to ViewModel. AudioMixMode setting change propagates through DataStore -> ChannelRepository observer -> applyAudioMixMode -> consumer volume adjustment.
  </done>
</task>

</tasks>

<verification>
1. ProfileDrawer "Scan Mode" section visible with all 4 settings
2. Scan mode toggle enables/disables auto-switching
3. PTT target radio buttons select between ALWAYS_PRIMARY and DISPLAYED_CHANNEL
4. Return delay slider adjusts from 2-5 seconds
5. Audio mix mode radio buttons select between EQUAL_VOLUME and PRIMARY_PRIORITY
6. Audio mix mode change triggers applyAudioMixMode (via DataStore -> ChannelRepository observer)
7. ChannelRow shows settings icon (MoreVert) for joined channels only
8. Tapping settings icon opens ChannelVolumeDialog
9. Volume slider onVolumeChanged calls viewModel.setChannelVolume (NO TODO placeholder)
10. Mute toggle in dialog closes consumers (bandwidth savings)
11. All settings persist across app restart via DataStore
</verification>

<success_criteria>
- ProfileDrawer has complete Scan Mode settings section matching user decisions
- Per-channel volume slider wired end-to-end: dialog -> ViewModel.setChannelVolume -> ChannelRepository.setChannelVolume -> MediasoupClient.setConsumerVolume
- Audio mix mode wired end-to-end: ProfileDrawer -> ViewModel.setAudioMixMode -> DataStore -> ChannelRepository observer -> applyAudioMixMode
- All settings connected to ViewModel and persisted via DataStore
- Mute toggle actually closes consumers (not just volume 0)
</success_criteria>

<output>
After completion, create `.planning/phases/08-multi-channel-monitoring-scan-mode/08-04-SUMMARY.md`
</output>
