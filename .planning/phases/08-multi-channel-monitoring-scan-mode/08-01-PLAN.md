---
phase: 08-multi-channel-monitoring-scan-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/src/main/java/com/voiceping/android/domain/model/ChannelMonitoringState.kt
  - android/app/src/main/java/com/voiceping/android/domain/model/ScanModeState.kt
  - android/app/src/main/java/com/voiceping/android/domain/model/PttTargetMode.kt
  - android/app/src/main/java/com/voiceping/android/domain/model/AudioMixMode.kt
  - android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt
autonomous: true

must_haves:
  truths:
    - "Domain models exist for multi-channel monitoring state, scan mode, PTT target, and audio mix"
    - "SettingsRepository persists scan mode settings (enabled, return delay, PTT target, audio mix mode, monitored channels, primary channel) via DataStore"
    - "All settings have sensible defaults matching user decisions (scan mode ON, 2.5s delay, always-primary PTT, equal volume)"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/ChannelMonitoringState.kt"
      provides: "Per-channel monitoring state data class"
      contains: "data class ChannelMonitoringState"
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/ScanModeState.kt"
      provides: "Scan mode display state"
      contains: "data class ScanModeState"
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/PttTargetMode.kt"
      provides: "PTT target enum"
      contains: "enum class PttTargetMode"
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/AudioMixMode.kt"
      provides: "Audio mix mode enum"
      contains: "enum class AudioMixMode"
    - path: "android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt"
      provides: "Scan mode settings persistence"
      contains: "stringSetPreferencesKey"
  key_links:
    - from: "SettingsRepository.kt"
      to: "PttTargetMode.kt"
      via: "stringPreferencesKey storing enum name"
      pattern: "PttTargetMode\\.valueOf"
    - from: "SettingsRepository.kt"
      to: "AudioMixMode.kt"
      via: "stringPreferencesKey storing enum name"
      pattern: "AudioMixMode\\.valueOf"
---

<objective>
Create domain models and DataStore settings foundation for multi-channel monitoring and scan mode.

Purpose: All subsequent plans need these shared models (ChannelMonitoringState, ScanModeState, PttTargetMode, AudioMixMode) and persisted settings (scan toggle, return delay, PTT target, audio mix, monitored channels, primary channel). This foundation must exist before ChannelRepository conversion or ViewModel scan logic.

Output: 4 new domain model files + extended SettingsRepository with scan mode settings.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-multi-channel-monitoring-scan-mode/08-RESEARCH.md
@android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt
@android/app/src/main/java/com/voiceping/android/domain/model/Channel.kt
@android/app/src/main/java/com/voiceping/android/domain/model/User.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain models for multi-channel monitoring and scan mode</name>
  <files>
    android/app/src/main/java/com/voiceping/android/domain/model/ChannelMonitoringState.kt
    android/app/src/main/java/com/voiceping/android/domain/model/ScanModeState.kt
    android/app/src/main/java/com/voiceping/android/domain/model/PttTargetMode.kt
    android/app/src/main/java/com/voiceping/android/domain/model/AudioMixMode.kt
  </files>
  <action>
    Create 4 domain model files in the existing domain/model package:

    **ChannelMonitoringState.kt:**
    ```kotlin
    data class ChannelMonitoringState(
        val channelId: String,
        val channelName: String,
        val teamName: String,
        val isPrimary: Boolean,
        val isMuted: Boolean = false,
        val currentSpeaker: User? = null,
        val lastSpeaker: User? = null,
        val speakerStartTime: Long = 0L,  // System.currentTimeMillis() when speaker started
        val consumerId: String? = null,     // mediasoup consumer ID for this channel
        val volume: Float = 1.0f           // 0.0-1.0 range for per-channel volume
    )
    ```
    Import User from same package.
    The `speakerStartTime` field is critical for "most recently started transmission" logic per user decision.
    The `consumerId` tracks the active producer ID for consumer management.

    **ScanModeState.kt:**
    ```kotlin
    data class ScanModeState(
        val enabled: Boolean = true,
        val displayedChannelId: String? = null,
        val isLocked: Boolean = false,
        val returnDelaySeconds: Int = 2
    )
    ```
    - `enabled` defaults true per user decision ("default: ON when 2+ channels joined")
    - `isLocked` tracks manual channel lock (user taps bottom bar)
    - `displayedChannelId` is what the bottom bar currently shows

    **PttTargetMode.kt:**
    ```kotlin
    enum class PttTargetMode {
        ALWAYS_PRIMARY,
        DISPLAYED_CHANNEL
    }
    ```
    Per user decision: "Always primary" vs "Displayed channel" setting in profile drawer.

    **AudioMixMode.kt:**
    ```kotlin
    enum class AudioMixMode {
        EQUAL_VOLUME,
        PRIMARY_PRIORITY
    }
    ```
    Per user decision: "Equal volume" vs "Primary priority" setting in profile drawer.
  </action>
  <verify>
    Confirm all 4 files exist with correct package declaration `com.voiceping.android.domain.model` and contain the expected class/enum names.
  </verify>
  <done>
    ChannelMonitoringState has channelId, channelName, teamName, isPrimary, isMuted, currentSpeaker, lastSpeaker, speakerStartTime, consumerId, volume fields.
    ScanModeState has enabled, displayedChannelId, isLocked, returnDelaySeconds fields.
    PttTargetMode has ALWAYS_PRIMARY and DISPLAYED_CHANNEL values.
    AudioMixMode has EQUAL_VOLUME and PRIMARY_PRIORITY values.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend SettingsRepository with scan mode and multi-channel persistence</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt
  </files>
  <action>
    Extend the existing SettingsRepository with new DataStore keys and methods for scan mode settings.

    **Add imports:**
    ```kotlin
    import androidx.datastore.preferences.core.stringSetPreferencesKey
    import com.voiceping.android.domain.model.PttTargetMode
    import com.voiceping.android.domain.model.AudioMixMode
    ```

    **Add new keys to the Keys object:**
    ```kotlin
    val MONITORED_CHANNEL_IDS = stringSetPreferencesKey("monitored_channel_ids")
    val PRIMARY_CHANNEL_ID = stringPreferencesKey("primary_channel_id")
    val SCAN_MODE_ENABLED = booleanPreferencesKey("scan_mode_enabled")
    val SCAN_RETURN_DELAY = intPreferencesKey("scan_return_delay")
    val PTT_TARGET_MODE = stringPreferencesKey("ptt_target_mode")
    val AUDIO_MIX_MODE = stringPreferencesKey("audio_mix_mode")
    ```

    **Add getter/setter pairs for each setting:**

    1. `setMonitoredChannels(channelIds: Set<String>)` / `getMonitoredChannels(): Flow<Set<String>>` — uses stringSetPreferencesKey, default emptySet()
    2. `setPrimaryChannel(channelId: String)` / `getPrimaryChannel(): Flow<String?>` — default null
    3. `setScanModeEnabled(enabled: Boolean)` / `getScanModeEnabled(): Flow<Boolean>` — default true (per user decision: ON when 2+ channels)
    4. `setScanReturnDelay(seconds: Int)` / `getScanReturnDelay(): Flow<Int>` — default 2 seconds (discretion: 2.5 rounds to 2 for int, use 2 as default within 2-3s user range)
    5. `setPttTargetMode(mode: PttTargetMode)` / `getPttTargetMode(): Flow<PttTargetMode>` — default ALWAYS_PRIMARY, store as mode.name, parse with valueOf + try/catch fallback
    6. `setAudioMixMode(mode: AudioMixMode)` / `getAudioMixMode(): Flow<AudioMixMode>` — default EQUAL_VOLUME, store as mode.name, parse with valueOf + try/catch fallback

    Follow the exact same pattern as existing getPttMode()/setPttMode() for enum persistence (store name, parse with valueOf, catch IllegalArgumentException and return default).

    Also add a `clearMonitoredChannels()` method that removes both MONITORED_CHANNEL_IDS and PRIMARY_CHANNEL_ID keys (used on logout/disconnect).
  </action>
  <verify>
    Confirm SettingsRepository.kt contains all 6 new key definitions in Keys object, all 12 getter/setter methods (6 pairs), and the clearMonitoredChannels method. Verify stringSetPreferencesKey import exists.
  </verify>
  <done>
    SettingsRepository persists monitored channel IDs (Set&lt;String&gt;), primary channel ID, scan mode enabled, scan return delay, PTT target mode, and audio mix mode via DataStore. All defaults match user decisions. Settings persist across sessions.
  </done>
</task>

</tasks>

<verification>
1. All 4 domain model files exist in android/app/src/main/java/com/voiceping/android/domain/model/
2. SettingsRepository has 6 new DataStore keys and 6 getter/setter pairs
3. stringSetPreferencesKey used for monitored channel IDs (not JSON serialization)
4. Default values: scan mode ON, return delay 2s, PTT target ALWAYS_PRIMARY, audio mix EQUAL_VOLUME
5. Enums use name/valueOf pattern matching existing PTT mode persistence
</verification>

<success_criteria>
- Domain models compile with correct types and all fields present
- SettingsRepository compiles with all new methods accessible
- No existing PTT settings broken (all existing Keys preserved)
- stringSetPreferencesKey used for Set<String> persistence (not manual JSON)
</success_criteria>

<output>
After completion, create `.planning/phases/08-multi-channel-monitoring-scan-mode/08-01-SUMMARY.md`
</output>
