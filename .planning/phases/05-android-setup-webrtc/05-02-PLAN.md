---
phase: 05-android-setup-webrtc
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/storage/TokenManager.kt
  - android/app/src/main/java/com/voiceping/android/data/storage/PreferencesManager.kt
  - android/app/src/main/java/com/voiceping/android/data/api/AuthApi.kt
  - android/app/src/main/java/com/voiceping/android/data/network/dto/LoginRequest.kt
  - android/app/src/main/java/com/voiceping/android/data/network/dto/LoginResponse.kt
  - android/app/src/main/java/com/voiceping/android/data/repository/AuthRepository.kt
  - android/app/src/main/java/com/voiceping/android/domain/usecase/LoginUseCase.kt
  - android/app/src/main/java/com/voiceping/android/di/AuthModule.kt
  - android/app/src/main/java/com/voiceping/android/presentation/login/LoginScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/login/LoginViewModel.kt
  - android/app/src/main/java/com/voiceping/android/presentation/loading/LoadingScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/navigation/NavGraph.kt
autonomous: true

must_haves:
  truths:
    - "User can enter email and password on login screen and tap Login button"
    - "Login validation errors display inline under the input fields (not toast)"
    - "JWT token is stored securely in EncryptedSharedPreferences after successful login"
    - "App auto-logs in on relaunch if stored credentials exist and token is not expired"
    - "Silent token refresh retries 2-3 times before forcing logout"
    - "Loading/connecting screen shows between login success and channel list"
    - "Branded splash screen has dark background with logo and fields that slide up"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/data/storage/TokenManager.kt"
      provides: "Secure JWT storage with EncryptedSharedPreferences"
      contains: "EncryptedSharedPreferences"
    - path: "android/app/src/main/java/com/voiceping/android/data/repository/AuthRepository.kt"
      provides: "Login, token refresh, credential persistence"
      contains: "refreshToken"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/login/LoginScreen.kt"
      provides: "Login UI with inline errors and branded design"
      contains: "OutlinedTextField"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/login/LoginViewModel.kt"
      provides: "Login state management with auto-login check"
      contains: "checkAutoLogin"
  key_links:
    - from: "LoginScreen.kt"
      to: "LoginViewModel.kt"
      via: "hiltViewModel() injection"
      pattern: "hiltViewModel"
    - from: "LoginViewModel.kt"
      to: "AuthRepository.kt"
      via: "LoginUseCase injection"
      pattern: "LoginUseCase"
    - from: "AuthRepository.kt"
      to: "TokenManager.kt"
      via: "Hilt constructor injection"
      pattern: "TokenManager"
---

<objective>
Implement the complete authentication and login flow. Build TokenManager with EncryptedSharedPreferences for secure JWT storage, AuthApi (Retrofit) for the login endpoint, AuthRepository with silent token refresh, LoginScreen with branded splash design and inline validation errors, and auto-login detection on app launch. Add a loading/connecting screen shown between login and channel list.

Purpose: Users can authenticate and the app persists sessions securely, matching the locked decision for field workers who should never think about session persistence.
Output: Working login flow from UI to secure token storage, with auto-login on relaunch.
</objective>

<execution_context>
@C:\Users\jotha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jotha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-android-setup-webrtc/05-RESEARCH.md
@.planning/phases/05-android-setup-webrtc/05-01-SUMMARY.md

Reference research Pattern 2 (Secure JWT Storage) and Code Example 1 (Login with JWT Storage) extensively.

Server login endpoint: POST /api/auth/login with { email, password }
Returns: { token, expiresIn, userId, userName, eventId, channelIds, globalRole, eventRole }

The server URL should be configurable — store in BuildConfig or a config file. For development, default to a placeholder URL that the user will configure.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create secure storage and auth data layer</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/storage/TokenManager.kt
    android/app/src/main/java/com/voiceping/android/data/storage/PreferencesManager.kt
    android/app/src/main/java/com/voiceping/android/data/api/AuthApi.kt
    android/app/src/main/java/com/voiceping/android/data/network/dto/LoginRequest.kt
    android/app/src/main/java/com/voiceping/android/data/network/dto/LoginResponse.kt
    android/app/src/main/java/com/voiceping/android/data/repository/AuthRepository.kt
    android/app/src/main/java/com/voiceping/android/domain/usecase/LoginUseCase.kt
    android/app/src/main/java/com/voiceping/android/di/AuthModule.kt
  </files>
  <action>
    **TokenManager.kt:** EncryptedSharedPreferences wrapper per research Pattern 2.
    - MasterKey with AES256_GCM scheme
    - Store JWT token, token timestamp, email, password (for silent refresh)
    - Methods: saveToken(token), getToken(), isTokenExpired() (1-hour TTL = 3600000ms), needsRefresh() (55-minute threshold = 3300000ms), saveCredentials(email, password), getStoredCredentials(), clearAll()
    - Annotate with @Inject constructor, inject @ApplicationContext
    - Provide as @Singleton via Hilt

    **PreferencesManager.kt:** Regular SharedPreferences for non-sensitive data.
    - Store last selected eventId (String?)
    - Methods: saveLastEventId(eventId), getLastEventId(), clearLastEventId()
    - Use standard SharedPreferences (not encrypted — eventId is not sensitive)
    - Annotate with @Inject constructor

    **LoginRequest.kt:** data class with email (String), password (String)
    **LoginResponse.kt:** data class with token (String), expiresIn (Int), userId (String), userName (String), eventId (String?), channelIds (List<String>?), globalRole (String), eventRole (String?)

    **AuthApi.kt:** Retrofit interface
    - @POST("api/auth/login") suspend fun login(@Body request: LoginRequest): LoginResponse
    - Note: the base URL will be configured in AuthModule

    **AuthRepository.kt:** Implements login flow per research.
    - login(email, password): Call AuthApi.login(), on success save token + credentials via TokenManager, return User domain model
    - refreshToken(): Get stored credentials, call login endpoint, save new token. Return Result<String>.
    - refreshTokenWithRetry(): Attempt refreshToken() up to 3 times with 1-second delays between attempts. If all fail, call clearAll() on TokenManager and return failure with message "Session expired. Please login again."
    - logout(): Clear TokenManager, return success
    - hasValidSession(): Check if token exists and is not expired
    - Use Dispatchers.IO for all network calls

    **LoginUseCase.kt:** Simple use case wrapping AuthRepository.login(). Takes email, password, returns Result<User>.

    **AuthModule.kt:** Hilt @Module @InstallIn(SingletonComponent::class)
    - Provide Retrofit instance with base URL from BuildConfig.SERVER_URL (add buildConfigField in build.gradle.kts, default "https://10.0.2.2:3000" for emulator localhost access)
    - Provide AuthApi from Retrofit
    - Provide TokenManager as singleton
    - Provide PreferencesManager as singleton
    - Provide AuthRepository as singleton

    Also update app/build.gradle.kts to add:
    ```
    buildFeatures {
        buildConfig = true
    }
    defaultConfig {
        buildConfigField("String", "SERVER_URL", "\"https://10.0.2.2:3000\"")
    }
    ```
  </action>
  <verify>
    All files compile. TokenManager uses EncryptedSharedPreferences with MasterKey. AuthApi has @POST annotation for login endpoint. AuthRepository has login(), refreshToken(), refreshTokenWithRetry(), logout(), hasValidSession() methods. Hilt module provides all dependencies.
  </verify>
  <done>
    Secure JWT storage works with EncryptedSharedPreferences. Auth data layer provides login, token refresh with 3-retry logic, and credential persistence. Server URL is configurable via BuildConfig.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Login UI, auto-login, loading screen, and navigation wiring</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/login/LoginScreen.kt
    android/app/src/main/java/com/voiceping/android/presentation/login/LoginViewModel.kt
    android/app/src/main/java/com/voiceping/android/presentation/loading/LoadingScreen.kt
    android/app/src/main/java/com/voiceping/android/presentation/navigation/NavGraph.kt
  </files>
  <action>
    **LoginViewModel.kt:** @HiltViewModel per research Code Example 1.
    - Inject LoginUseCase and TokenManager
    - UiState: sealed class with Idle, Loading, Success(user: User), Error(emailError: String?, passwordError: String?, generalError: String?)
    - login(email, password): Validate locally first (email not empty, password not empty), set field-specific errors. If valid, call loginUseCase, emit Success or Error.
    - checkAutoLogin(): Return true if tokenManager.getToken() != null && !tokenManager.isTokenExpired(). This determines whether to skip login screen.
    - Error state has separate emailError, passwordError, generalError fields for inline display under each field (per user decision: "Login validation errors shown inline under fields").

    **LoginScreen.kt:** Branded splash design per user decision.
    - Dark background (MaterialTheme.colorScheme.background)
    - VoicePing logo centered at top (use ic_logo drawable, tinted with primary/cyan)
    - Email OutlinedTextField — show emailError text below in error color if present
    - Password OutlinedTextField with PasswordVisualTransformation — show passwordError text below if present
    - generalError text (for server errors like "Invalid credentials") shown below password field
    - Login Button — shows CircularProgressIndicator when loading, disabled during loading
    - Fields should have animation: use AnimatedVisibility or similar for fields sliding up effect (the "fields slide up" part of branded splash). A simple approach: animate the Column with a vertical slide-in when screen first appears.
    - On Success: navigate to loading screen (NavGraph handles this)

    **LoadingScreen.kt:** Brief connecting screen per user decision.
    - Dark background, centered VoicePing logo, "Connecting..." text below with CircularProgressIndicator
    - This screen shows while WebSocket connection establishes (will be wired in Plan 05)
    - For now: show for 1-2 seconds then navigate to events/channels route (the actual WebSocket connection logic comes in Plan 05)

    **NavGraph.kt:** Update from Plan 01 placeholders to real screens.
    - Determine start destination: If auto-login valid, go to "loading". If no valid session, go to "login".
    - Route "login" -> LoginScreen(onLoginSuccess = { navController.navigate("loading") { popUpTo("login") { inclusive = true } } })
    - Route "loading" -> LoadingScreen(onConnected = { navController.navigate("events_or_channels") })
    - Route "events" -> placeholder (Plan 04)
    - Route "channels" -> placeholder (Plan 04)
    - The LoadingScreen should check PreferencesManager for saved eventId: if exists, navigate to "channels/{eventId}", else navigate to "events"
    - Use `navController.navigate("...") { popUpTo("loading") { inclusive = true } }` to prevent back-navigation to loading screen
  </action>
  <verify>
    LoginScreen renders with dark theme, logo, email/password fields, and login button. Validation errors show inline under the respective fields. LoginViewModel handles auto-login check. LoadingScreen shows centered logo with "Connecting..." text. NavGraph routes between login -> loading -> events/channels correctly.
  </verify>
  <done>
    Complete login flow: branded splash with slide-up fields, inline validation errors, auto-login on relaunch skips login screen, loading screen bridges to channel list. Navigation handles all auth state transitions.
  </done>
</task>

</tasks>

<verification>
1. TokenManager uses EncryptedSharedPreferences with AES256_GCM MasterKey
2. Credentials stored for silent refresh (email + password)
3. Token expiry check at 1-hour TTL, refresh threshold at 55 minutes
4. refreshTokenWithRetry() attempts 3 times before force logout
5. LoginScreen shows inline errors (not toast/snackbar)
6. Auto-login skips login screen when valid token exists
7. LoadingScreen shows brief connecting state between login and channels
8. Navigation: login -> loading -> events/channels with no back-stack issues
9. All Hilt injections are properly wired
</verification>

<success_criteria>
- Login screen has branded dark design with logo and slide-up fields
- Inline validation errors display under email and password fields
- JWT securely stored in EncryptedSharedPreferences
- Auto-login works on app relaunch with stored credentials
- Silent refresh retries 3 times then forces logout with clear message
- Loading screen transitions user from login to channel list
</success_criteria>

<output>
After completion, create `.planning/phases/05-android-setup-webrtc/05-02-SUMMARY.md`
</output>
