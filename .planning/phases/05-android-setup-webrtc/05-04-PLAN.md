---
phase: 05-android-setup-webrtc
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/api/EventApi.kt
  - android/app/src/main/java/com/voiceping/android/data/network/dto/EventResponse.kt
  - android/app/src/main/java/com/voiceping/android/data/network/dto/ChannelResponse.kt
  - android/app/src/main/java/com/voiceping/android/data/repository/EventRepository.kt
  - android/app/src/main/java/com/voiceping/android/domain/usecase/GetEventsUseCase.kt
  - android/app/src/main/java/com/voiceping/android/presentation/events/EventPickerScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/events/EventPickerViewModel.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/TeamHeader.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
  - android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
  - android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt
  - android/app/src/main/java/com/voiceping/android/presentation/navigation/NavGraph.kt
  - android/app/src/main/java/com/voiceping/android/di/EventModule.kt
autonomous: true

must_haves:
  truths:
    - "User sees flat list of events and can tap to select one"
    - "App auto-skips event picker if saved event exists and goes straight to channel list"
    - "User sees channels grouped by team with team header labels"
    - "Each channel row shows channel name, user count, and active speaker indicator"
    - "Bottom bar shows current joined channel name and speaker name when transmitting"
    - "Profile drawer slides from right with user info, Switch Event, Settings, Logout"
    - "Connection status dot shows on profile icon (green=connected, etc.)"
    - "Disconnection banner appears at top saying Connecting... and auto-closes on reconnect"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/presentation/events/EventPickerScreen.kt"
      provides: "Event selection screen with flat list"
      contains: "LazyColumn"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt"
      provides: "Channel list with team grouping and app shell"
      contains: "groupBy"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt"
      provides: "Persistent mini-player bottom bar"
      contains: "joinedChannel"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt"
      provides: "Right-side slide-out panel with menu items"
      contains: "ModalDrawerSheet"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt"
      provides: "Top disconnection banner"
      contains: "Connecting"
  key_links:
    - from: "EventPickerScreen.kt"
      to: "NavGraph.kt"
      via: "onEventSelected navigates to channels/{eventId}"
      pattern: "navigate.*channels"
    - from: "ChannelListScreen.kt"
      to: "ChannelListViewModel.kt"
      via: "hiltViewModel() injection with state observation"
      pattern: "hiltViewModel"
    - from: "ChannelListViewModel.kt"
      to: "SignalingClient.kt"
      via: "connectionState StateFlow observation"
      pattern: "connectionState"
---

<objective>
Build all UI screens: EventPickerScreen with flat event list and auto-skip logic, ChannelListScreen with team-grouped channels, BottomBar (mini-player style), ProfileDrawer (right slide-out), ConnectionBanner (top disconnection indicator), and connection status dot. Wire navigation between all screens.

Purpose: Users can select events, see channels grouped by team, and interact with the app shell (profile, bottom bar, connection indicators) matching all locked UI decisions.
Output: Complete UI layer with all screens navigable, ready for channel join/audio wiring in Plan 05.
</objective>

<execution_context>
@C:\Users\jotha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jotha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-android-setup-webrtc/05-RESEARCH.md
@.planning/phases/05-android-setup-webrtc/05-02-SUMMARY.md
@.planning/phases/05-android-setup-webrtc/05-03-SUMMARY.md

Reference research Code Example 2 (Channel List with Team Grouping) extensively. Match the locked UI decisions from CONTEXT.md exactly.

Server REST endpoints (existing control-plane):
- GET /api/events — returns array of events user has access to
- GET /api/events/:eventId/channels — returns channels with team info

For the channel list: after login, the app gets event/channel data via REST API. The WebSocket signaling (CHANNEL_LIST, CHANNEL_STATE) provides real-time updates.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EventPickerScreen, EventRepository, and event data layer</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/api/EventApi.kt
    android/app/src/main/java/com/voiceping/android/data/network/dto/EventResponse.kt
    android/app/src/main/java/com/voiceping/android/data/network/dto/ChannelResponse.kt
    android/app/src/main/java/com/voiceping/android/data/repository/EventRepository.kt
    android/app/src/main/java/com/voiceping/android/domain/usecase/GetEventsUseCase.kt
    android/app/src/main/java/com/voiceping/android/presentation/events/EventPickerScreen.kt
    android/app/src/main/java/com/voiceping/android/presentation/events/EventPickerViewModel.kt
    android/app/src/main/java/com/voiceping/android/di/EventModule.kt
  </files>
  <action>
    **EventResponse.kt:** data class matching server response: id (String), name (String), description (String?), createdAt (String?)
    **ChannelResponse.kt:** data class: id (String), name (String), teamId (String), teamName (String). Also a wrapper for the full channel list response structure.

    **EventApi.kt:** Retrofit interface
    - @GET("api/events") suspend fun getEvents(@Header("Authorization") token: String): List<EventResponse>
    - @GET("api/events/{eventId}/channels") suspend fun getChannels(@Header("Authorization") token: String, @Path("eventId") eventId: String): List<ChannelResponse>
    - Note: Pass JWT as "Bearer $token" in Authorization header for REST API calls (different from WebSocket subprotocol approach)

    **EventRepository.kt:** @Singleton with @Inject constructor. Inject EventApi, TokenManager.
    - getEvents(): Fetch events via REST API. Map EventResponse to domain Event model. Return Result<List<Event>>.
    - getChannelsForEvent(eventId: String): Fetch channels via REST API. Map ChannelResponse to domain Channel model. Group by teamId, include teamName. Return Result<List<Channel>>.
    - Authorization: Get token from TokenManager, pass as "Bearer $token" header.

    **GetEventsUseCase.kt:** Wraps eventRepository.getEvents().

    **EventPickerViewModel.kt:** @HiltViewModel. Inject GetEventsUseCase, PreferencesManager.
    - UiState: sealed class with Loading, Success(events: List<Event>), Error(message: String), Empty
    - loadEvents(): Fetch events, emit appropriate state.
    - selectEvent(event: Event): Save eventId to PreferencesManager, signal navigation to channels.
    - _selectedEvent: SharedFlow<Event> — emitted once when user taps event (UI observes this to navigate)

    **EventPickerScreen.kt:** Per user decision "simple flat list of events user has access to, tap to select."
    - TopAppBar with title "Select Event"
    - LazyColumn with list of events
    - Each event row: Card or ListItem with event name, description subtitle (if present). Clickable — calls viewModel.selectEvent(event).
    - Loading state: centered CircularProgressIndicator
    - Error state: centered error message with retry button
    - Empty state: "No events available" message
    - Dark theme styling throughout (use MaterialTheme.colorScheme)

    **EventModule.kt:** Hilt @Module @InstallIn(SingletonComponent::class)
    - Provide EventApi from existing Retrofit instance (from AuthModule). If Retrofit is already provided in AuthModule, share it — or create a separate Retrofit provider that uses the same OkHttpClient.

    IMPORTANT: If AuthModule already provides Retrofit, ensure there's no duplicate binding. Either move Retrofit to AppModule as a shared provider, or use @Named qualifiers. The simplest approach: move the Retrofit @Provides to AppModule (from Plan 01) and have both AuthModule and EventModule use it.
  </action>
  <verify>
    EventPickerScreen shows flat list of events. Tapping an event saves eventId to PreferencesManager and triggers navigation. Loading, error, and empty states are handled. EventApi calls use Bearer token authorization.
  </verify>
  <done>
    Event picker shows flat list of events, saves selection to preferences, and navigates to channel list. Auto-skip logic works via PreferencesManager check in NavGraph/LoadingScreen.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChannelListScreen, BottomBar, ProfileDrawer, ConnectionBanner, and navigation wiring</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/TeamHeader.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
    android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
    android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt
    android/app/src/main/java/com/voiceping/android/presentation/navigation/NavGraph.kt
  </files>
  <action>
    **ChannelListViewModel.kt:** @HiltViewModel. Inject EventRepository, SignalingClient, TokenManager, PreferencesManager, SavedStateHandle.
    - Get eventId from SavedStateHandle (passed via navigation argument) or PreferencesManager
    - _channels: MutableStateFlow<List<Channel>>(emptyList()) — exposed as StateFlow
    - _joinedChannel: MutableStateFlow<Channel?>(null) — exposed as StateFlow
    - _currentSpeaker: MutableStateFlow<User?>(null) — exposed as StateFlow (wired to mediasoup in Plan 05)
    - connectionState: observe SignalingClient.connectionState
    - _user: MutableStateFlow<User?>(null) — current logged-in user info
    - loadChannels(eventId): Fetch via EventRepository.getChannelsForEvent(). Update _channels.
    - toggleChannel(channel): If already joined, leave (set _joinedChannel to null). If different channel, deselect previous and select new (set _joinedChannel). Phase 5: single channel only — selecting another deselects previous. Actual join/leave signaling wired in Plan 05.
    - switchEvent(): Clear _joinedChannel, navigate to events screen
    - logout(): Clear tokens, navigate to login screen

    **ChannelRow.kt:** Composable per research Code Example 2.
    - Row with: channel name (bodyLarge), active speaker indicator (pulsing dot + speaker name in primary color), user count (bodySmall, onSurfaceVariant)
    - Pulsing animation: rememberInfiniteTransition with animateFloat for alpha (1f to 0.3f, tween 1000ms, RepeatMode.Reverse). Cyan pulsing dot (8dp circle).
    - Checkbox on right side: checked = isJoined. onCheckedChange = onToggle callback.
    - Entire row is clickable (same as toggling checkbox)
    - Speaker indicator only visible when channel.currentSpeaker != null (AnimatedVisibility)

    **TeamHeader.kt:** Composable per research.
    - Text with team name, titleSmall style, onSurfaceVariant color
    - Background: surfaceVariant color
    - Padding: horizontal 16dp, vertical 8dp
    - Full width

    **BottomBar.kt:** Persistent mini-player style per user decision.
    - Surface with 64dp height, surfaceVariant color, tonalElevation 3dp
    - Row: channel name (bodyMedium), speaker name when transmitting (bodySmall, primary color, preceded by speaker icon)
    - If no channel joined: "No channel selected" text in onSurfaceVariant
    - If channel joined but no speaker: channel name + "Listening..." subtitle
    - If channel joined and speaker active: channel name + speaker name with speaker icon

    **ProfileDrawer.kt:** Right-side slide-out panel per user decision.
    - Use ModalNavigationDrawer with drawerContent = ModalDrawerSheet
    - Drawer alignment: END (slides from right). Note: Compose ModalNavigationDrawer defaults to start. For right-side, use `drawerState` with custom configuration or wrap content to apply RTL layout direction for the drawer only. Alternative: Use a custom Side Sheet implementation with AnimatedVisibility + slideInHorizontally from the right.
    - Content:
      1. User info section: name (titleMedium), email (bodySmall, onSurfaceVariant), small avatar icon
      2. Divider
      3. NavigationDrawerItem: "Switch Event" with swap icon
      4. NavigationDrawerItem: "Settings" with gear icon (placeholder for now)
      5. Divider
      6. NavigationDrawerItem: "Logout" with exit icon, in error color
      7. Spacer(weight=1)
      8. Text: app version "VoicePing v1.0.0" (bodySmall, onSurfaceVariant, centered)
    - Width: 280dp
    - Animation: slide from right edge

    **ConnectionBanner.kt:** Top disconnection banner per user decision.
    - AnimatedVisibility: show when connectionState is CONNECTING or FAILED
    - When CONNECTING: yellow/amber background, "Connecting..." text with small progress indicator
    - When FAILED: error color background, "Connection failed. Retrying..." text
    - When CONNECTED: hide (AnimatedVisibility collapses)
    - Position: at top of screen, full width, above content

    **ChannelListScreen.kt:** Main screen assembling all components per research Code Example 2.
    - Scaffold with:
      - topBar: TopAppBar with title "Channels", actions = { connection status dot overlaid on profile IconButton }
      - Connection status dot: 10dp circle positioned at bottom-left of profile icon. Green when CONNECTED, yellow when CONNECTING, red when FAILED/DISCONNECTED.
      - Profile icon: IconButton with Person icon. On click: open ProfileDrawer.
      - bottomBar: BottomBar composable
    - Content: ConnectionBanner at top (AnimatedVisibility), then LazyColumn with team-grouped channels.
    - LazyColumn: group channels by teamName, for each team render TeamHeader then ChannelRow items.
    - Wrap Scaffold in the ProfileDrawer (so drawer overlays the entire screen).

    **NavGraph.kt:** Update with final navigation structure.
    - "login" -> LoginScreen
    - "loading" -> LoadingScreen (checks saved event, routes to events or channels/{eventId})
    - "events" -> EventPickerScreen (onEventSelected: navigate to channels/{eventId})
    - "channels/{eventId}" -> ChannelListScreen (receives eventId as argument)
    - Event switching: from ProfileDrawer -> navigate to "events" with popUpTo("channels") inclusive
    - Logout: navigate to "login" with popUpTo(0) to clear entire back stack
    - Back press from channels: exit app (no back to events unless explicitly switching)
  </action>
  <verify>
    ChannelListScreen shows channels grouped by team headers. ChannelRow has checkbox toggle, pulsing speaker indicator, user count. BottomBar shows joined channel and speaker. ProfileDrawer slides from right with all menu items. ConnectionBanner appears/disappears based on connection state. NavGraph connects all screens with proper back-stack management.
  </verify>
  <done>
    Complete UI layer: event picker with auto-skip, channel list with team grouping, mini-player bottom bar, right-side profile drawer with logout/switch event, connection banner, and status indicator. All locked UI decisions implemented.
  </done>
</task>

</tasks>

<verification>
1. Event picker shows flat list, tap selects and navigates to channel list
2. Auto-skip event picker when saved event exists (checks PreferencesManager)
3. Channels grouped by team with header labels (e.g., "Security Team")
4. Channel row: name, pulsing speaker indicator (cyan dot animation), user count
5. Checkbox toggle pattern: single channel only (selecting new deselects previous)
6. Bottom bar: channel name + speaker name when transmitting, "No channel selected" when empty
7. Profile drawer slides from right with: user info, Switch Event, Settings, Logout, version
8. Connection status dot on profile icon: green/yellow/red
9. Disconnection banner: "Connecting..." (amber), "Connection failed" (red), auto-hides on reconnect
10. Navigation: login -> loading -> events/channels, event switching, logout clears back stack
</verification>

<success_criteria>
- All locked UI decisions from CONTEXT.md are implemented exactly
- Screen flow: login -> loading -> event picker (or auto-skip) -> channel list
- Channel list shows team-grouped channels with toggle, speaker indicators, user count
- App shell: bottom bar, profile drawer, connection indicators all functional
</success_criteria>

<output>
After completion, create `.planning/phases/05-android-setup-webrtc/05-04-SUMMARY.md`
</output>
