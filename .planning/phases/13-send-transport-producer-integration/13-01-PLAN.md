---
phase: 13-send-transport-producer-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt
autonomous: true

must_haves:
  truths:
    - "SendTransport created as singleton with onConnect and onProduce callbacks bridging to signaling"
    - "AudioSource and AudioTrack created from PeerConnectionFactory for microphone capture"
    - "Producer created with Opus PTT config (mono, DTX, FEC, 48kHz, 20ms ptime)"
    - "Producer closed and AudioSource/AudioTrack disposed on stopProducing (correct disposal order)"
    - "sendAudioData method removed (no longer needed with WebRTC AudioSource)"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt"
      provides: "SendTransport, Producer, AudioSource, AudioTrack lifecycle"
      contains: "SendTransport"
  key_links:
    - from: "MediasoupClient.createSendTransport()"
      to: "SignalingClient.request(CREATE_TRANSPORT)"
      via: "suspend function call"
      pattern: "signalingClient\\.request.*CREATE_TRANSPORT.*send"
    - from: "SendTransport.Listener.onProduce()"
      to: "SignalingClient.request(PRODUCE)"
      via: "runBlocking bridge"
      pattern: "runBlocking.*PRODUCE"
    - from: "MediasoupClient.startProducing()"
      to: "transport.produce()"
      via: "AudioTrack passed to produce"
      pattern: "transport\\.produce"
    - from: "MediasoupClient.stopProducing()"
      to: "Producer.close() + AudioTrack.dispose() + AudioSource.dispose()"
      via: "ordered disposal"
      pattern: "audioProducer.*close.*audioTrack.*dispose.*audioSource.*dispose"
---

<objective>
Implement SendTransport creation and Producer lifecycle in MediasoupClient for PTT audio transmission.

Purpose: Replace stubbed SendTransport/Producer code with real libmediasoup-android library calls, enabling the app to transmit microphone audio via WebRTC when PTT is pressed.

Output: MediasoupClient.kt with working createSendTransport(), startProducing(), and stopProducing() methods using real library types.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-send-transport-producer-integration/13-RESEARCH.md
@android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SendTransport creation with onConnect and onProduce callbacks</name>
  <files>android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt</files>
  <action>
Replace the stubbed createSendTransport() method in MediasoupClient.kt with a real implementation using libmediasoup-android.

Key changes to MediasoupClient.kt:

1. **Add imports:**
   - `io.github.crow_misia.mediasoup.SendTransport`
   - `io.github.crow_misia.mediasoup.Producer`
   - `org.webrtc.AudioSource` (rename the existing `org.webrtc.AudioTrack` import stays)
   - `org.webrtc.MediaConstraints`

2. **Change field types from Any? to real types:**
   - `private var sendTransport: Any? = null` -> `private var sendTransport: SendTransport? = null`
   - `private var audioProducer: Any? = null` -> `private var audioProducer: Producer? = null`
   - Add: `private var audioSource: AudioSource? = null`
   - Add: `private var pttAudioTrack: org.webrtc.AudioTrack? = null` (use full qualified name to avoid clash with the existing `org.webrtc.AudioTrack` import used for consumer volume)

3. **Change createSendTransport() signature from `suspend fun createSendTransport(channelId: String)` to `suspend fun createSendTransport()` (no channelId -- singleton pattern, not per-channel).**

4. **Replace the commented-out body of createSendTransport() with real implementation:**
   - Add guard: `if (sendTransport != null) { Log.d(TAG, "SendTransport already exists"); return@withContext }`
   - Request transport from server: `signalingClient.request(SignalingType.CREATE_TRANSPORT, mapOf("direction" to "send"))` -- note: no channelId for send transport (singleton)
   - Parse transportId, iceParameters, iceCandidates, dtlsParameters from response using existing toJsonString() helper
   - Create SendTransport via `device.createSendTransport()` with:
     - `SendTransport.Listener` implementing:
       - `onConnect(transport, dtlsParameters)`: Use `runBlocking { signalingClient.request(SignalingType.CONNECT_TRANSPORT, ...) }` -- same pattern as RecvTransport in this file
       - `onProduce(transport, kind, rtpParameters, appData)`: Use `runBlocking { ... }` to call `signalingClient.request(SignalingType.PRODUCE, mapOf("kind" to kind, "rtpParameters" to rtpParameters))`, return `produceResponse.data?.get("id") as? String ?: throw IllegalStateException("No producer id")`
       - `onConnectionStateChange(transport, connectionState)`: Log state, on "failed"/"disconnected" close audioProducer and set to null
     - Parameters: id, iceParameters, iceCandidates, dtlsParameters (pass `null` for iceServers, peerConnectionOptions, appData)
   - Store result in `sendTransport`

5. **Do NOT change RecvTransport, consumeAudio, or other receive-side methods** -- those are already working from Phase 12.
  </action>
  <verify>Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL with no errors related to SendTransport or Producer types.</verify>
  <done>createSendTransport() creates a real SendTransport singleton with onConnect/onProduce callbacks that bridge to signaling via runBlocking. Field types are SendTransport and Producer (not Any?).</done>
</task>

<task type="auto">
  <name>Task 2: Implement Producer lifecycle with AudioSource/AudioTrack and Opus config</name>
  <files>android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt</files>
  <action>
Replace the stubbed startProducing() and stopProducing() methods and remove sendAudioData().

Key changes:

1. **Replace startProducing() body with real implementation:**
   - Guard: `val transport = sendTransport ?: throw IllegalStateException("SendTransport not created")`
   - Create AudioSource: `audioSource = peerConnectionFactory.createAudioSource(MediaConstraints())`
   - Create AudioTrack: `pttAudioTrack = peerConnectionFactory.createAudioTrack("audio-ptt", audioSource)`
   - Define Opus PTT codec options as Map: `mapOf("opusStereo" to false, "opusDtx" to true, "opusFec" to true, "opusMaxPlaybackRate" to 48000, "opusPtime" to 20)`
   - Create Producer: `audioProducer = transport.produce(listener = object : Producer.Listener { onTransportClose: set audioProducer = null, call cleanupAudioResources() }, track = pttAudioTrack, encodings = null, codecOptions = toJsonString(codecOptions), codec = null, appData = null)`
   - Wrap in try/catch, call cleanupAudioResources() on failure

2. **Replace stopProducing() body with real implementation:**
   - `audioProducer?.close()` then `audioProducer = null`
   - Call `cleanupAudioResources()`
   - Wrap in try/catch, ensure cleanupAudioResources() called even on error

3. **Add private cleanupAudioResources() method:**
   - Dispose in correct order (CRITICAL for native memory): `pttAudioTrack?.dispose()` then `pttAudioTrack = null`, then `audioSource?.dispose()` then `audioSource = null`
   - Log disposal

4. **Delete sendAudioData() method entirely** -- WebRTC AudioSource captures audio internally, no manual buffer forwarding needed.

5. **Update cleanup() method:**
   - Replace the commented-out `(it as Producer).close()` block with: `audioProducer?.close(); audioProducer = null; cleanupAudioResources()`
   - Replace the commented-out `(it as SendTransport).close()` block with: `sendTransport?.close(); sendTransport = null`

6. **Update class KDoc** to remove references to "skeleton" and "TODO". Update the audio flow comment to reflect WebRTC AudioSource pattern instead of AudioCaptureManager callback loop.
  </action>
  <verify>Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL. Also verify no remaining TODO comments related to SendTransport/Producer by running grep.</verify>
  <done>startProducing() creates AudioSource + AudioTrack + Producer with Opus PTT config. stopProducing() closes Producer and disposes native resources in correct order. sendAudioData() removed. cleanup() uses real library calls. No stub/TODO comments remain for send-side code.</done>
</task>

</tasks>

<verification>
1. `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` passes
2. MediasoupClient.kt has `SendTransport` type (not `Any?`) for sendTransport field
3. MediasoupClient.kt has `Producer` type (not `Any?`) for audioProducer field
4. createSendTransport() has no channelId parameter (singleton pattern)
5. onProduce callback returns String (producer ID from server)
6. startProducing() creates AudioSource, AudioTrack, and Producer with Opus config
7. stopProducing() calls Producer.close(), AudioTrack.dispose(), AudioSource.dispose() in order
8. sendAudioData() method no longer exists
9. No TODO comments remain for send-side transport/producer code
</verification>

<success_criteria>
- Build succeeds with real SendTransport and Producer types
- SendTransport is singleton (no channelId param, guard against duplicate creation)
- Producer uses Opus PTT config: mono, DTX, FEC, 48kHz, 20ms ptime
- Native resources (AudioSource, AudioTrack) disposed in correct order on stop
- sendAudioData() removed from codebase
</success_criteria>

<output>
After completion, create `.planning/phases/13-send-transport-producer-integration/13-01-SUMMARY.md`
</output>
