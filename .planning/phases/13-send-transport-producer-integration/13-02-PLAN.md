---
phase: 13-send-transport-producer-integration
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/AudioCaptureManager.kt
autonomous: true

must_haves:
  truths:
    - "PttManager calls mediasoupClient.startProducing() on PTT grant (no AudioCaptureManager)"
    - "PttManager calls mediasoupClient.stopProducing() on PTT release (no audioCaptureManager.stopCapture())"
    - "AudioCaptureManager.kt deleted from codebase"
    - "createSendTransport() called without channelId parameter (singleton pattern)"
    - "forceReleasePtt() also uses mediasoupClient.stopProducing() instead of audioCaptureManager"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt"
      provides: "PTT flow wired to Producer lifecycle"
      contains: "mediasoupClient.startProducing"
  key_links:
    - from: "PttManager.requestPtt()"
      to: "MediasoupClient.createSendTransport() + startProducing()"
      via: "suspend calls in coroutine scope"
      pattern: "mediasoupClient\\.createSendTransport.*mediasoupClient\\.startProducing"
    - from: "PttManager.releasePtt()"
      to: "MediasoupClient.stopProducing()"
      via: "direct call in coroutine scope"
      pattern: "mediasoupClient\\.stopProducing"
---

<objective>
Refactor PttManager to use MediasoupClient Producer lifecycle instead of AudioCaptureManager, then delete AudioCaptureManager.

Purpose: Complete the send-side integration by wiring PTT button directly to Producer create/close, eliminating 168 LOC of redundant custom audio capture code that WebRTC's AudioSource now handles internally.

Output: PttManager.kt refactored without AudioCaptureManager dependency, AudioCaptureManager.kt deleted.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-send-transport-producer-integration/13-RESEARCH.md
@.planning/phases/13-send-transport-producer-integration/13-01-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt
@android/app/src/main/java/com/voiceping/android/data/audio/AudioCaptureManager.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor PttManager to use Producer lifecycle instead of AudioCaptureManager</name>
  <files>android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt</files>
  <action>
Refactor PttManager.kt to remove all AudioCaptureManager usage and wire PTT directly to MediasoupClient Producer lifecycle.

Key changes:

1. **Remove AudioCaptureManager from constructor injection:**
   - Delete: `private val audioCaptureManager: AudioCaptureManager,`
   - Delete: `import com.voiceping.android.data.audio.AudioCaptureManager`
   - Also remove `audioRouter` parameter if it's unused after this change (check if audioRouter is used anywhere else in PttManager -- it is NOT used in any method body, only injected). Remove it and its import.

2. **Refactor requestPtt() method (PTT granted flow):**
   - DELETE Step 4 (audio capture callback): Remove the `audioCaptureManager.onAudioData = { ... }` block entirely. WebRTC AudioSource captures internally.
   - CHANGE Step 5: `mediasoupClient.createSendTransport(channelId)` -> `mediasoupClient.createSendTransport()` (no channelId -- singleton pattern from Plan 01)
   - Step 6 (startProducing) stays the same
   - DELETE Step 7 (start capture): Remove `audioCaptureManager.startCapture()`. WebRTC AudioSource starts capture when Producer is created.
   - Renumber remaining steps (was 9 steps, now 6 steps)

3. **Refactor releasePtt() method (PTT release flow):**
   - DELETE: `audioCaptureManager.stopCapture()` line. Producer.close() handles AudioRecord release.
   - Keep: `mediasoupClient.stopProducing()` (already there)
   - Update comment: Remove "(stopCapture joins thread for up to 1s)" since no thread join anymore

4. **Refactor forceReleasePtt() method:**
   - DELETE: `audioCaptureManager.stopCapture()` line (same as releasePtt)
   - Keep: `mediasoupClient.stopProducing()` (already there)

5. **Update class KDoc:**
   - Change flow description from "AudioRecord -> AudioCaptureManager callback -> MediasoupClient.sendAudioData()" to "WebRTC AudioSource (internal capture) -> Producer -> RTP"
   - Remove mentions of AudioCaptureManager from comments
   - Update step numbering in requestPtt/releasePtt KDoc to reflect simplified flow:
     - requestPtt: 1) Server grants PTT, 2) Start foreground service, 3) Create SendTransport (idempotent), 4) Start producing (creates AudioSource + AudioTrack + Producer), 5) Notify callback
     - releasePtt: 1) Cancel timer, 2) Notify callback, 3) Reset state, 4) Stop producing + stop service + notify server
  </action>
  <verify>Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL. Verify no references to AudioCaptureManager remain in PttManager.kt.</verify>
  <done>PttManager no longer depends on AudioCaptureManager. requestPtt() calls createSendTransport() (no channelId) then startProducing(). releasePtt() and forceReleasePtt() call stopProducing() only (no stopCapture). Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Delete AudioCaptureManager.kt</name>
  <files>android/app/src/main/java/com/voiceping/android/data/audio/AudioCaptureManager.kt</files>
  <action>
Delete AudioCaptureManager.kt entirely. This file is 168 LOC of custom AudioRecord management that is now handled internally by WebRTC's AudioSource (created in MediasoupClient.startProducing()).

Steps:
1. Delete the file: `android/app/src/main/java/com/voiceping/android/data/audio/AudioCaptureManager.kt`
2. Verify no other files reference AudioCaptureManager by searching the codebase. After Task 1, PttManager no longer imports it. The only other reference should be Hilt's generated files (which will regenerate on next build).
3. If any other file references AudioCaptureManager (unlikely but check), remove those references too.

What was in AudioCaptureManager that is now handled by WebRTC:
- AudioRecord creation (48kHz mono VOICE_COMMUNICATION) -> WebRTC AudioSource via JavaAudioDeviceModule
- Buffer read loop with URGENT_AUDIO thread priority -> WebRTC native capture thread
- AcousticEchoCanceler setup -> JavaAudioDeviceModule hardware AEC (configured in Phase 11)
- onAudioData callback -> Not needed, AudioSource feeds Producer internally
- Resource cleanup -> AudioSource.dispose() / AudioTrack.dispose() in MediasoupClient
  </action>
  <verify>Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL. Verify AudioCaptureManager.kt no longer exists and no compilation errors reference it.</verify>
  <done>AudioCaptureManager.kt deleted. No references remain in codebase. Build passes. SEND-05 requirement satisfied.</done>
</task>

</tasks>

<verification>
1. `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` passes
2. PttManager.kt has no import/reference to AudioCaptureManager
3. PttManager.kt calls `mediasoupClient.createSendTransport()` without channelId
4. PttManager.kt does NOT call audioCaptureManager.startCapture() or stopCapture()
5. PttManager.kt does NOT call mediasoupClient.sendAudioData()
6. AudioCaptureManager.kt file does not exist
7. forceReleasePtt() uses mediasoupClient.stopProducing() (not audioCaptureManager)
8. No file in the codebase imports or references AudioCaptureManager
</verification>

<success_criteria>
- PttManager wired directly to Producer lifecycle (no AudioCaptureManager intermediary)
- AudioCaptureManager.kt deleted (168 LOC removed)
- Build succeeds with no AudioCaptureManager references
- PTT flow simplified: requestPtt -> createSendTransport + startProducing, releasePtt -> stopProducing
</success_criteria>

<output>
After completion, create `.planning/phases/13-send-transport-producer-integration/13-02-SUMMARY.md`
</output>
