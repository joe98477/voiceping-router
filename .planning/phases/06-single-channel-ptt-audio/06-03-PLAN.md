---
phase: 06-single-channel-ptt-audio
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/PttButton.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
autonomous: true

must_haves:
  truths:
    - "User sees PTT button in bottom bar that responds to press-and-hold and toggle modes"
    - "User sees red pulsing PTT button with elapsed time counter when transmitting"
    - "User sees subtle loading pulse on PTT button during server confirmation wait"
    - "User sees dimmed/grayed PTT button with current speaker name when channel is busy"
    - "User sees speaker name with pulsing cyan animation in channel list when someone is speaking"
    - "User sees highlighted cyan border/glow on active channel in channel list"
    - "User sees brief 2-3 second last speaker fade in channel list after transmission ends"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/PttButton.kt"
      provides: "PTT button composable with press-and-hold, toggle, pulse animations, elapsed time"
      contains: "PttButton"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt"
      provides: "Updated bottom bar integrating PTT button with channel info and busy state"
      contains: "PttButton"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt"
      provides: "Updated channel row with speaker indicators, cyan glow, and last speaker fade"
      contains: "animateColorAsState"
  key_links:
    - from: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/PttButton.kt"
      to: "android/app/src/main/java/com/voiceping/android/domain/model/PttState.kt"
      via: "Renders different visual states based on PttState sealed class"
      pattern: "PttState\\."
    - from: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt"
      to: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/PttButton.kt"
      via: "Embeds PttButton in bottom bar layout"
      pattern: "PttButton"
    - from: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt"
      to: "android/app/src/main/java/com/voiceping/android/domain/model/User.kt"
      via: "Displays speaker name and animations based on currentSpeaker"
      pattern: "currentSpeaker"
---

<objective>
Build the PTT button composable with press-and-hold/toggle modes, pulse animations, and elapsed time counter. Update the bottom bar to integrate PTT button with busy state. Update channel rows with speaker indicators, cyan glow, and last speaker fade animation.

Purpose: This is the visual layer that turns the PTT engine (Plan 02) into a tangible user interaction. The PTT button in the bottom bar is the primary interaction point for the entire app. Speaker indicators in the channel list provide at-a-glance awareness.

Output: PttButton composable, updated BottomBar with PTT, updated ChannelRow with speaker animations.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-single-channel-ptt-audio/06-CONTEXT.md
@.planning/phases/06-single-channel-ptt-audio/06-RESEARCH.md
@.planning/phases/06-single-channel-ptt-audio/06-01-SUMMARY.md
@.planning/phases/06-single-channel-ptt-audio/06-02-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
@android/app/src/main/java/com/voiceping/android/domain/model/PttState.kt
@android/app/src/main/java/com/voiceping/android/domain/model/PttMode.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PttButton composable and update BottomBar</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/PttButton.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
  </files>
  <action>
    1. Create PttButton.kt in presentation/channels/components/:

       @Composable fun PttButton(pttState, pttMode, transmissionDuration, isBusy, onPttPressed, onPttReleased, modifier):

       **Visual states per user decisions:**
       - Idle: Cyan primary color (MaterialTheme.colorScheme.primary), Mic icon, enabled
       - Requesting: Subtle gray loading pulse animation (NOT red, NOT transmitting visual -- user decided "subtle loading pulse during brief server confirmation wait")
       - Transmitting: Red pulsing (Color(0xFFD32F2F)), elapsed time text ("{duration}s"), scale+alpha pulse animation
       - Denied: Brief dark red flash (Color(0xFFB71C1C)), 500ms then back to idle (handled by PttManager state)
       - Busy (isBusy=true, pttState=Idle): Dimmed/grayed out, not clickable (user decided "PTT button dimmed/grayed out when busy")

       **Animations:**
       - Transmitting pulse: rememberInfiniteTransition, animateFloat scale 1.0->1.15 with 1000ms tween EaseInOut, alpha 1.0->0.6 reverse
       - Requesting pulse: More subtle, animateFloat alpha 0.5->1.0 with 600ms, no scale change
       - Color: red for own transmission, cyan for others speaking per user decision

       **Interaction modes:**
       - PRESS_AND_HOLD: pointerInput with detectTapGestures { onPress { onPttPressed(); tryAwaitRelease(); onPttReleased() } }
       - TOGGLE: clickable { if transmitting -> onPttReleased() else -> onPttPressed() }

       **Layout:** Box 72.dp CircleShape with background color, centered content (Icon or Text)

    2. Update BottomBar.kt (MODIFY existing file -- read first):

       **Add new parameters:** pttState: PttState, pttMode: PttMode, transmissionDuration: Long, onPttPressed: () -> Unit, onPttReleased: () -> Unit

       **Layout changes:**
       - Keep existing Column with channel name on the left
       - Add PttButton on the right side of the Row (Arrangement.SpaceBetween already exists)
       - When channel is busy (currentSpeaker != null AND user is not transmitting):
         * PTT button shows dimmed/grayed state
         * Bottom bar shows current speaker name in cyan text
       - When user is transmitting:
         * PTT button shows red pulse + elapsed time
         * Bottom bar left text shows "Transmitting..." in red
       - When idle:
         * PTT button shows normal cyan
         * "Listening..." text as before
       - When no channel joined: No PTT button shown, keep "No channel selected" text
       - Increase BottomBar height from 64.dp to 80.dp to accommodate PTT button (72dp button + padding)

       **Pulse color distinction per user decision:**
       - Red pulse: user's own transmission
       - Cyan indicator: others speaking (handled by currentSpeaker display)
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (PttButton composable and updated BottomBar compile)
  </verify>
  <done>
    PttButton supports both press-and-hold and toggle modes. Transmitting state shows red pulse (scale 1.0-1.15, alpha 1.0-0.6, 1s cycle) with elapsed time counter. Requesting state shows subtle gray loading pulse. Busy state shows dimmed button. BottomBar integrates PttButton on right side with channel info on left. Height increased to 80dp.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ChannelRow with speaker indicators, cyan glow, and last speaker fade</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
  </files>
  <action>
    Read existing ChannelRow.kt first, then enhance with:

    **Add new parameters:** currentSpeaker: User? (already exists or add), isActiveChannel: Boolean (this channel has active speaker)

    **Speaker indicator per user decisions:**
    - When currentSpeaker != null for this channel:
      * Replace idle text (channel member count or description) with speaker name in cyan text
      * Add pulsing/glowing animation on the speaker name text: animateFloat alpha 0.6->1.0 with 800ms infinite transition
      * Apply highlighted cyan border/glow to the entire channel row: Border(2.dp, cyanColor) with animateColorAsState
    - When no speaker:
      * Show normal idle state (no border glow)

    **Last speaker fade per user decision ("2-3 second last speaker fade showing name, then transition to idle"):**
    - Add lastSpeaker: User? parameter and lastSpeakerVisible: Boolean parameter
    - When lastSpeakerVisible is true and lastSpeaker != null:
      * Show last speaker name in fading text (AnimatedVisibility with fadeOut, 2500ms duration)
      * After fade completes, caller resets lastSpeaker to null
    - The 2-3 second delay + fade will be managed by the ViewModel (Plan 04 will add the timer logic)
    - ChannelRow just renders the fade animation when told to

    **Cyan border glow animation:**
    - Use animateColorAsState to smoothly transition border color from transparent to cyan when isActiveChannel changes
    - Border: Modifier.border(2.dp, borderColor, shape = RoundedCornerShape(8.dp))
    - When active: borderColor = Color(0xFF00BCD4) (app's cyan accent)
    - When inactive: borderColor = Color.Transparent

    **No elapsed time for incoming speakers per user decision:** "No elapsed time for incoming speakers -- just name display"
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (updated ChannelRow compiles with new animation parameters)
  </verify>
  <done>
    ChannelRow shows speaker name replacing idle text with pulsing cyan animation when someone is speaking. Active channel gets cyan border/glow. Last speaker name fades out over 2-3 seconds after transmission ends. No elapsed time shown for incoming speakers (just name). All animations use Compose animation APIs.
  </done>
</task>

</tasks>

<verification>
1. ./gradlew assembleDebug compiles successfully
2. PttButton has two interaction modes: press-and-hold (pointerInput) and toggle (clickable)
3. PttButton shows red pulse only during PttState.Transmitting (not during Requesting per user decision)
4. PttButton shows subtle loading pulse during PttState.Requesting
5. PttButton shows elapsed time text during Transmitting
6. PttButton is dimmed when isBusy=true
7. BottomBar embeds PttButton on right side, channel info on left
8. ChannelRow shows speaker name in cyan when active speaker exists
9. ChannelRow has cyan border glow for active channel
10. ChannelRow has fadeOut animation for last speaker
</verification>

<success_criteria>
PTT button renders all 4 visual states correctly (Idle, Requesting, Transmitting, Denied) with appropriate animations. Bottom bar integrates PTT button with channel info. Channel rows show speaker indicators with pulsing animation and cyan border glow. Last speaker fades out over 2-3 seconds. All UI elements follow locked user decisions exactly.
</success_criteria>

<output>
After completion, create `.planning/phases/06-single-channel-ptt-audio/06-03-SUMMARY.md`
</output>
