---
phase: 06-single-channel-ptt-audio
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/build.gradle.kts
  - android/app/src/main/java/com/voiceping/android/domain/model/PttState.kt
  - android/app/src/main/java/com/voiceping/android/domain/model/PttMode.kt
  - android/app/src/main/java/com/voiceping/android/domain/model/AudioRoute.kt
  - android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt
autonomous: true

must_haves:
  truths:
    - "PTT mode preference persists across app restarts (DataStore)"
    - "Audio tone toggles persist across app restarts (DataStore)"
    - "Audio route preference persists across app restarts (DataStore)"
    - "TonePlayer can generate distinct PTT start, roger beep, squelch, and error tones"
    - "HapticFeedback can produce distinct PTT press and error vibration patterns"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/PttState.kt"
      provides: "PTT state machine sealed class (Idle, Requesting, Transmitting, Denied)"
      contains: "sealed class PttState"
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/PttMode.kt"
      provides: "PTT mode enum (PRESS_AND_HOLD, TOGGLE)"
      contains: "enum class PttMode"
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/AudioRoute.kt"
      provides: "Audio route enum (SPEAKER, EARPIECE, BLUETOOTH)"
      contains: "enum class AudioRoute"
    - path: "android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt"
      provides: "DataStore-backed settings for PTT mode, audio route, tone toggles, toggle max duration"
      contains: "preferencesDataStore"
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt"
      provides: "ToneGenerator-based audio feedback for PTT events"
      contains: "ToneGenerator"
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt"
      provides: "VibrationEffect-based haptic feedback for PTT events"
      contains: "VibrationEffect"
  key_links:
    - from: "android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt"
      to: "android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt"
      via: "Reads tone toggle settings before playing"
      pattern: "settingsRepository.*Enabled"
    - from: "android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt"
      to: "android/app/src/main/java/com/voiceping/android/domain/model/PttMode.kt"
      via: "Stores and retrieves PttMode enum"
      pattern: "PttMode"
---

<objective>
Create PTT domain models, settings persistence with Jetpack DataStore, audio tone generator, and haptic feedback -- the foundation layer that PTT state machine (Plan 02) and UI (Plan 03) both depend on.

Purpose: PTT modes, audio routes, and tone/haptic preferences must be persisted and configurable before the PTT interaction and UI layers can use them. This plan creates the data layer that all other Phase 6 plans consume.

Output: PttState sealed class, PttMode/AudioRoute enums, SettingsRepository (DataStore), TonePlayer (ToneGenerator), HapticFeedback (VibrationEffect), DataStore dependency in Gradle.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-single-channel-ptt-audio/06-CONTEXT.md
@.planning/phases/06-single-channel-ptt-audio/06-RESEARCH.md
@android/app/build.gradle.kts
@android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
@android/app/src/main/java/com/voiceping/android/domain/model/User.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PTT domain models and SettingsRepository with DataStore</name>
  <files>
    android/app/build.gradle.kts
    android/app/src/main/java/com/voiceping/android/domain/model/PttState.kt
    android/app/src/main/java/com/voiceping/android/domain/model/PttMode.kt
    android/app/src/main/java/com/voiceping/android/domain/model/AudioRoute.kt
    android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt
  </files>
  <action>
    1. Add Jetpack DataStore dependency to android/app/build.gradle.kts:
       implementation("androidx.datastore:datastore-preferences:1.1.1")

    2. Create PttState.kt sealed class in domain/model/:
       - PttState.Idle (default resting state)
       - PttState.Requesting (waiting for server confirmation -- shows subtle loading pulse)
       - PttState.Transmitting (server confirmed, mic active -- shows red pulse + elapsed time)
       - PttState.Denied (channel busy -- shows error state briefly)

    3. Create PttMode.kt enum in domain/model/:
       - PRESS_AND_HOLD (default per user decision)
       - TOGGLE

    4. Create AudioRoute.kt enum in domain/model/:
       - SPEAKER (default per user decision: loudspeaker when no headset)
       - EARPIECE
       - BLUETOOTH

    5. Create SettingsRepository.kt in data/storage/:
       - Use @Singleton @Inject constructor with @ApplicationContext
       - Private preferencesDataStore named "ptt_settings"
       - Keys: PTT_MODE (string), AUDIO_ROUTE (string), PTT_START_TONE (boolean), ROGER_BEEP (boolean), RX_SQUELCH (boolean), TOGGLE_MAX_DURATION (int)
       - For each setting: suspend set*() function using context.dataStore.edit{}, Flow-returning get*() function using context.dataStore.data.map{}
       - Defaults per user decisions: PTT_MODE=PRESS_AND_HOLD, AUDIO_ROUTE=SPEAKER, PTT_START_TONE=true, ROGER_BEEP=true (default on per decision), RX_SQUELCH=false, TOGGLE_MAX_DURATION=60
       - Add getCachedPttStartToneEnabled(), getCachedRogerBeepEnabled(), getCachedRxSquelchEnabled() methods that return Boolean synchronously using runBlocking { data.first() } -- these are called from audio thread where Flow collection is not practical
       - Note: runBlocking here is acceptable because DataStore caches after first read, so subsequent calls are near-instant
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (DataStore dependency resolves, all new files compile, no import errors)
  </verify>
  <done>
    PttState sealed class has 4 states (Idle, Requesting, Transmitting, Denied). PttMode and AudioRoute enums exist. SettingsRepository persists all PTT settings via DataStore with correct defaults (PRESS_AND_HOLD, SPEAKER, start tone on, roger beep on, squelch off, 60s toggle max).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TonePlayer and HapticFeedback for PTT audio/tactile feedback</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt
    android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt
  </files>
  <action>
    1. Create TonePlayer.kt in data/audio/:
       - @Singleton @Inject constructor with SettingsRepository dependency
       - Private ToneGenerator instance initialized with STREAM_VOICE_CALL at 50% volume
       - playPttStartTone(): Check settingsRepository.getCachedPttStartToneEnabled(), if enabled play TONE_DTMF_1 for 100ms (short high chirp -- Claude's discretion for tone design)
       - playRogerBeep(): Check settingsRepository.getCachedRogerBeepEnabled(), if enabled play TONE_DTMF_0 for 150ms (short low chirp)
       - playRxSquelchOpen(): Check settingsRepository.getCachedRxSquelchEnabled(), if enabled play TONE_PROP_NACK for 80ms (brief squelch)
       - playRxSquelchClose(): Check settingsRepository.getCachedRxSquelchEnabled(), if enabled play TONE_PROP_NACK for 60ms (squelch tail)
       - playErrorTone(): Always plays (no toggle) -- TONE_PROP_BEEP2 for 200ms (distinct error double beep for PTT denied)
       - cleanup(): Release ToneGenerator
       - All methods are fire-and-forget, catch exceptions internally (never crash caller)

    2. Create HapticFeedback.kt in data/audio/:
       - @Singleton @Inject constructor with @ApplicationContext
       - Private Vibrator instance from VIBRATOR_SERVICE
       - vibratePttPress(): VibrationEffect.createOneShot(50, VibrationEffect.DEFAULT_AMPLITUDE) -- short firm click for PTT press confirmation
       - vibrateError(): VibrationEffect.createWaveform(longArrayOf(0, 100, 50, 100), -1) -- distinct buzz-pause-buzz pattern for denied PTT per user decision ("distinct error tone + buzz pattern")
       - vibrateRelease(): VibrationEffect.createOneShot(30, VibrationEffect.DEFAULT_AMPLITUDE / 2) -- subtle release confirmation
       - All methods check vibrator.hasVibrator() before vibrating
       - All methods catch exceptions internally
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (TonePlayer and HapticFeedback compile with correct imports)
  </verify>
  <done>
    TonePlayer generates 5 distinct tones (PTT start chirp, roger beep, RX squelch open, RX squelch close, error). TonePlayer checks SettingsRepository toggle before playing configurable tones. HapticFeedback produces 3 distinct vibration patterns (press, error, release). Both classes are @Singleton with @Inject constructor for Hilt injection.
  </done>
</task>

</tasks>

<verification>
1. ./gradlew assembleDebug compiles successfully with DataStore dependency
2. PttState has exactly 4 sealed subclasses: Idle, Requesting, Transmitting, Denied
3. PttMode has PRESS_AND_HOLD and TOGGLE values
4. AudioRoute has SPEAKER, EARPIECE, BLUETOOTH values
5. SettingsRepository uses DataStore (not SharedPreferences)
6. TonePlayer checks settings toggle before playing configurable tones
7. HapticFeedback uses VibrationEffect (API 26+ compatible)
</verification>

<success_criteria>
All domain models (PttState, PttMode, AudioRoute), SettingsRepository, TonePlayer, and HapticFeedback compile and are injectable via Hilt. Settings defaults match user decisions (PRESS_AND_HOLD, SPEAKER, roger beep on, squelch off).
</success_criteria>

<output>
After completion, create `.planning/phases/06-single-channel-ptt-audio/06-01-SUMMARY.md`
</output>
