---
phase: 06-single-channel-ptt-audio
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
autonomous: true

must_haves:
  truths:
    - "User can press PTT button in bottom bar to request transmission on joined channel"
    - "User hears PTT start tone and feels haptic feedback when transmission starts"
    - "User hears roger beep when transmission ends"
    - "User hears RX squelch when someone starts or stops speaking (if enabled in settings)"
    - "User hears error tone and feels error haptic when PTT is denied"
    - "User can toggle between earpiece and speaker in settings drawer"
    - "User can switch between press-and-hold and toggle PTT modes in settings"
    - "User can toggle PTT start tone, roger beep, and RX squelch independently in settings"
    - "User sees last speaker name fade out over 2-3 seconds after transmission ends"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt"
      provides: "Enhanced with PTT integration, tone/haptic callbacks, last speaker fade timer"
      contains: "PttManager"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt"
      provides: "Exposes PTT state, settings flows, and PTT actions to UI"
      contains: "pttState"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt"
      provides: "Wires ViewModel state to BottomBar, ChannelRow, and PttButton"
      contains: "pttState"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt"
      provides: "Settings section with PTT mode, audio output, and tone toggles"
      contains: "SettingsRepository"
  key_links:
    - from: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt"
      to: "android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt"
      via: "Calls requestPtt/releasePtt and observes pttState"
      pattern: "pttManager\\.requestPtt|releasePtt"
    - from: "android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt"
      to: "android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt"
      via: "Plays RX squelch on speaker change events"
      pattern: "tonePlayer\\.playRxSquelch"
    - from: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt"
      to: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt"
      via: "Passes pttState, pttMode, callbacks to BottomBar composable"
      pattern: "BottomBar.*pttState"
    - from: "android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt"
      to: "android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt"
      via: "Reads and writes PTT settings"
      pattern: "settingsRepository"
---

<objective>
Wire all Phase 6 components together: connect PttManager to ChannelRepository and ViewModel, integrate tone/haptic feedback into PTT lifecycle, add RX squelch to speaker change events, add settings UI to ProfileDrawer, and update ChannelListScreen to pass all new state to UI components.

Purpose: Plans 01-03 created the individual components (settings, engine, UI). This plan connects them into a working end-to-end system where pressing PTT in the bottom bar flows through: ViewModel -> PttManager -> server -> AudioCapture -> mediasoup, with audio/haptic feedback at each step, and settings controlling behavior.

Output: Fully integrated PTT flow with settings UI, tone/haptic feedback, and speaker indicator wiring.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-single-channel-ptt-audio/06-CONTEXT.md
@.planning/phases/06-single-channel-ptt-audio/06-RESEARCH.md
@.planning/phases/06-single-channel-ptt-audio/06-01-SUMMARY.md
@.planning/phases/06-single-channel-ptt-audio/06-02-SUMMARY.md
@.planning/phases/06-single-channel-ptt-audio/06-03-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
@android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
@android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt
@android/app/src/main/java/com/voiceping/android/data/storage/SettingsRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire PttManager into ChannelRepository with tone/haptic feedback and last speaker fade</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt
  </files>
  <action>
    Read existing ChannelRepository.kt first, then enhance:

    1. Add new constructor dependencies: PttManager, TonePlayer, HapticFeedback

    2. Wire PttManager callbacks for tone/haptic feedback:
       - In init block (or a setup method called during initialization):
         * pttManager.onPttGranted = { tonePlayer.playPttStartTone(); hapticFeedback.vibratePttPress() }
         * pttManager.onPttDenied = { tonePlayer.playErrorTone(); hapticFeedback.vibrateError() }
         * pttManager.onPttReleased = { tonePlayer.playRogerBeep(); hapticFeedback.vibrateRelease() }
       - This connects Plan 01 (tones/haptics) to Plan 02 (PttManager) without PttManager knowing about them

    3. Add RX squelch to observeSpeakerChanges():
       - When new speaker starts (speakerUserId != null): call tonePlayer.playRxSquelchOpen()
       - When speaker stops (speakerUserId == null): call tonePlayer.playRxSquelchClose()
       - Squelch only plays for INCOMING speakers, not when user themselves starts/stops PTT
       - Guard: do NOT play squelch if pttManager.pttState.value == PttState.Transmitting (user is the speaker)

    4. Add last speaker fade logic:
       - New field: private val _lastSpeaker = MutableStateFlow<User?>(null)
       - Public lastSpeaker: StateFlow<User?> = _lastSpeaker.asStateFlow()
       - New field: private var lastSpeakerFadeJob: Job? = null
       - In observeSpeakerChanges(), when speaker stops (speakerUserId == null):
         a. Copy current speaker name to _lastSpeaker.value before clearing _currentSpeaker
         b. Cancel any existing lastSpeakerFadeJob
         c. Launch lastSpeakerFadeJob that delays 2500ms then sets _lastSpeaker.value = null
       - When new speaker starts: cancel lastSpeakerFadeJob, clear _lastSpeaker.value (new speaker takes over immediately)

    5. Expose PttManager state for ViewModel:
       - val pttState: StateFlow<PttState> = pttManager.pttState (delegate to PttManager)

    6. Add mic permission check utility:
       - fun hasMicPermission(): Boolean -- checks ContextCompat.checkSelfPermission(context, Manifest.permission.RECORD_AUDIO) == GRANTED
       - PttManager doesn't check permission itself (Claude's discretion: permission flow handled at ViewModel/UI level)
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (enhanced ChannelRepository compiles with all new dependencies)
  </verify>
  <done>
    ChannelRepository wires PttManager callbacks to TonePlayer/HapticFeedback. RX squelch plays on incoming speaker start/stop (not on own transmission). Last speaker fades after 2.5 seconds. PTT state exposed via delegation. Mic permission check utility available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ChannelListViewModel, ChannelListScreen, and add settings to ProfileDrawer</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
    android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
  </files>
  <action>
    1. Update ChannelListViewModel.kt (read first):
       - Add constructor dependencies: PttManager, SettingsRepository, AudioRouter
       - Expose new state flows:
         * val pttState: StateFlow<PttState> = channelRepository.pttState
         * val pttMode: StateFlow<PttMode> from settingsRepository.getPttMode() converted to StateFlow via stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), PttMode.PRESS_AND_HOLD)
         * val audioRoute: StateFlow<AudioRoute> from settingsRepository.getAudioRoute() similarly
         * val lastSpeaker: StateFlow<User?> = channelRepository.lastSpeaker
         * val toggleMaxDuration: StateFlow<Int> from settingsRepository.getToggleMaxDuration() similarly
         * val pttStartToneEnabled, rogerBeepEnabled, rxSquelchEnabled: StateFlow<Boolean> from settingsRepository flows
       - Add PTT action methods:
         * fun onPttPressed(): Guard with mic permission check (channelRepository.hasMicPermission()), if no permission set a needs-permission flag for UI. If has permission, call pttManager.requestPtt(joinedChannel.value?.id ?: return)
         * fun onPttReleased(): call pttManager.releasePtt()
       - Add settings action methods:
         * fun setPttMode(mode: PttMode): viewModelScope.launch { settingsRepository.setPttMode(mode) }
         * fun setAudioRoute(route: AudioRoute): viewModelScope.launch { settingsRepository.setAudioRoute(route); audioRouter.setAudioRoute(route) }
         * fun setPttStartToneEnabled(enabled: Boolean), setRogerBeepEnabled(enabled: Boolean), setRxSquelchEnabled(enabled: Boolean): delegate to settingsRepository
         * fun setToggleMaxDuration(seconds: Int): delegate to settingsRepository
       - Add transmission duration: fun getTransmissionDuration(): Long = pttManager.getTransmissionDurationSeconds() (called from composable on timer tick)
       - Add mic permission request tracking: private val _needsMicPermission = MutableStateFlow(false), val needsMicPermission: StateFlow<Boolean>
       - fun onMicPermissionResult(granted: Boolean): if granted, retry onPttPressed(); if denied, log warning

    2. Update ChannelListScreen.kt (read first):
       - Collect new state flows from ViewModel: pttState, pttMode, lastSpeaker, needsMicPermission
       - Add mic permission launcher: rememberLauncherForActivityResult(RequestPermission()) { granted -> viewModel.onMicPermissionResult(granted) }
       - LaunchedEffect on needsMicPermission: when true, launch permission request
       - Pass to BottomBar: pttState, pttMode, transmissionDuration (use LaunchedEffect with 1-second ticker to update duration during transmitting), onPttPressed = viewModel::onPttPressed, onPttReleased = viewModel::onPttReleased
       - Pass to ChannelRow: lastSpeaker state for fade animation
       - Transmission duration ticker: When pttState == Transmitting, launch LaunchedEffect that emits every 1 second (delay(1000)) and updates a local remember mutableIntStateOf for elapsed seconds display
       - isBusy logic for PttButton: isBusy = currentSpeaker != null && pttState == PttState.Idle (someone else speaking and we're not transmitting)

    3. Update ProfileDrawer.kt (read first):
       - Add settings section below existing profile info:
       - "PTT Settings" section header
         * PTT Mode: Two RadioButtons for PRESS_AND_HOLD / TOGGLE with labels
         * When TOGGLE selected: Slider for max duration (30-120 seconds, step 5)
       - "Audio Output" section header
         * RadioButtons for Speaker / Earpiece (Bluetooth auto-routes per user decision, no manual BT selection needed)
       - "Audio Tones" section header
         * Switch rows for: "PTT Start Tone", "Roger Beep", "RX Squelch"
       - All settings changes call ViewModel methods which delegate to SettingsRepository
       - Settings are in the drawer per user decision: "Earpiece/speaker toggle located in settings drawer/side panel (not in main UI)"
       - Add new parameters to ProfileDrawer: pttMode, audioRoute, pttStartToneEnabled, rogerBeepEnabled, rxSquelchEnabled, toggleMaxDuration, and corresponding on*Changed callbacks
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (all modified files compile with new parameters and wiring)
  </verify>
  <done>
    ChannelListViewModel exposes PTT state, settings, and actions. ChannelListScreen passes all state to BottomBar (with PttButton), ChannelRow (with speaker indicators), and ProfileDrawer (with settings). Mic permission requested on first PTT press. Settings in ProfileDrawer match user decisions: PTT mode, audio output, three tone toggles. Elapsed time counter ticks every second during transmission.
  </done>
</task>

<task type="auto">
  <name>Task 3: Toggle mode max duration enforcement and final integration verification</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
  </files>
  <action>
    1. Add toggle mode max duration enforcement to PttManager.kt:
       - Add field: var maxToggleDuration: Int = 60 (set by ViewModel from settings)
       - Add field: private var maxDurationJob: Job? = null
       - In requestPtt(), after entering Transmitting state, if current PTT mode is TOGGLE:
         a. Launch maxDurationJob coroutine: delay(maxToggleDuration * 1000L), then call releasePtt()
         b. This auto-releases after max duration
       - In releasePtt(): cancel maxDurationJob, set to null
       - Add field: var currentPttMode: PttMode = PttMode.PRESS_AND_HOLD (set by ViewModel from settings)
       - Note: PttMode is needed here to know whether to start max duration timer

    2. Wire toggle max duration in ChannelListViewModel:
       - In init block, observe settingsRepository.getToggleMaxDuration() and update pttManager.maxToggleDuration
       - In init block, observe settingsRepository.getPttMode() and update pttManager.currentPttMode

    3. Final integration self-check (verify all connections exist by reading the files):
       - ChannelListScreen passes pttState to BottomBar
       - BottomBar passes pttState to PttButton
       - PttButton onPress calls ViewModel.onPttPressed
       - ViewModel.onPttPressed calls PttManager.requestPtt
       - PttManager.requestPtt sends PTT_START via SignalingClient
       - On grant: PttManager starts AudioCaptureService, AudioCaptureManager, MediasoupClient produce
       - On release: reverse order cleanup
       - ChannelRepository.observeSpeakerChanges plays RX squelch tones
       - ProfileDrawer settings write to SettingsRepository
       - SettingsRepository flows update ViewModel state
       - ViewModel state flows update UI composables
  </action>
  <verify>
    Build compiles: cd android && ./gradlew assembleDebug (final integration compiles)
  </verify>
  <done>
    Toggle mode auto-releases after max duration (default 60s, configurable 30-120s in settings). PttManager knows current PTT mode for duration enforcement. All Phase 6 components are wired end-to-end: settings -> ViewModel -> PttManager -> SignalingClient -> AudioCapture -> mediasoup, with tone/haptic feedback at each step.
  </done>
</task>

</tasks>

<verification>
1. ./gradlew assembleDebug compiles successfully
2. Full PTT flow wired: Press button -> ViewModel -> PttManager -> server request -> audio capture -> mediasoup produce
3. Release flow: Release button -> stop capture -> stop produce -> stop foreground service -> notify server
4. Tone feedback: PTT start chirp, roger beep, RX squelch open/close, error tone -- all at correct lifecycle points
5. Haptic feedback: Press vibration, error buzz, release vibration
6. Settings: PTT mode, audio output, tone toggles all persist and apply immediately
7. Toggle mode: Auto-releases after configurable max duration
8. Mic permission: Requested on first PTT press, not on app launch
9. Last speaker: Fades after 2.5 seconds in channel list
10. RX squelch: Only plays for incoming speakers, not for own transmission
</verification>

<success_criteria>
Complete end-to-end PTT flow works: user presses PTT button -> hears start tone + haptic -> sees requesting state -> server grants -> sees red pulse + elapsed time -> audio captured and sent to server -> user releases -> hears roger beep -> state returns to idle. When channel busy: sees denied state + error tone + error haptic. Settings in ProfileDrawer control PTT mode, audio output, and tone toggles. Toggle mode enforces max duration.
</success_criteria>

<output>
After completion, create `.planning/phases/06-single-channel-ptt-audio/06-04-SUMMARY.md`
</output>
