---
phase: 11-library-upgrade-and-webrtc-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/build.gradle.kts
  - android/app/src/main/java/com/voiceping/android/VoicePingApplication.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
autonomous: true

must_haves:
  truths:
    - "App compiles with libmediasoup-android 0.21.0 dependency (upgraded from 0.7.0)"
    - "WebRTC native libraries load on app startup via MediasoupClient.initialize(context)"
    - "AudioRouter no longer sets MODE_IN_COMMUNICATION when modeControlEnabled is false"
  artifacts:
    - path: "android/app/build.gradle.kts"
      provides: "libmediasoup-android 0.21.0 dependency"
      contains: "libmediasoup-android:0.21.0"
    - path: "android/app/src/main/java/com/voiceping/android/VoicePingApplication.kt"
      provides: "WebRTC subsystem initialization on app launch"
      contains: "MediasoupClient.initialize"
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt"
      provides: "AudioManager mode control coordination flag"
      contains: "modeControlEnabled"
  key_links:
    - from: "VoicePingApplication.kt"
      to: "io.github.crow_misia.mediasoup.MediasoupClient"
      via: "initialize(applicationContext) in onCreate()"
      pattern: "MediasoupClient\\.initialize"
    - from: "AudioRouter.kt"
      to: "AudioManager.MODE_IN_COMMUNICATION"
      via: "modeControlEnabled guard"
      pattern: "modeControlEnabled"
---

<objective>
Upgrade libmediasoup-android from 0.7.0 to 0.21.0, initialize WebRTC native libraries on app startup, and refactor AudioRouter to support WebRTC AudioManager ownership coordination.

Purpose: Establish the foundation for WebRTC subsystem integration. The library upgrade brings WebRTC M130 with native binaries. WebRTC init must happen in Application.onCreate() before any Device creation. AudioRouter must yield MODE_IN_COMMUNICATION control to WebRTC's AudioDeviceModule to prevent dual-control conflicts.

Output: App compiles with upgraded library, WebRTC subsystem initializes on launch, AudioRouter ready for coordination.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-library-upgrade-and-webrtc-foundation/11-RESEARCH.md
@android/app/build.gradle.kts
@android/app/src/main/java/com/voiceping/android/VoicePingApplication.kt
@android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade library dependency and initialize WebRTC subsystem</name>
  <files>
    android/app/build.gradle.kts
    android/app/src/main/java/com/voiceping/android/VoicePingApplication.kt
  </files>
  <action>
1. In `android/app/build.gradle.kts`, change the mediasoup dependency version from 0.7.0 to 0.21.0:
   - Change: `implementation("io.github.crow-misia.libmediasoup-android:libmediasoup-android:0.7.0")`
   - To: `implementation("io.github.crow-misia.libmediasoup-android:libmediasoup-android:0.21.0")`

2. In `VoicePingApplication.kt`, add WebRTC native library initialization in onCreate():
   - Add import: `import io.github.crow_misia.mediasoup.MediasoupClient` (NOTE: this is the LIBRARY's MediasoupClient class, NOT our app's data/network/MediasoupClient.kt)
   - Add import: `import android.util.Log`
   - In onCreate() after super.onCreate(), add:
     ```
     MediasoupClient.initialize(applicationContext)
     Log.d(TAG, "WebRTC subsystem initialized")
     ```
   - Add companion object with `private const val TAG = "VoicePingApp"`
   - This MUST run before any Device creation or app crashes with UnsatisfiedLinkError
   - The library's MediasoupClient.initialize() loads native .so files for WebRTC

IMPORTANT: The import `io.github.crow_misia.mediasoup.MediasoupClient` refers to the LIBRARY class that initializes WebRTC. Our app's `com.voiceping.android.data.network.MediasoupClient` is a DIFFERENT class. There is no naming conflict because they are in different packages.
  </action>
  <verify>
Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL with no errors. The upgraded library should resolve and compile cleanly.
  </verify>
  <done>
build.gradle.kts references libmediasoup-android 0.21.0 (not 0.7.0). VoicePingApplication.onCreate() calls `io.github.crow_misia.mediasoup.MediasoupClient.initialize(applicationContext)`. `compileDebugKotlin` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor AudioRouter with WebRTC coordination flag</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
  </files>
  <action>
Refactor AudioRouter to add a `modeControlEnabled` flag that prevents dual MODE_IN_COMMUNICATION control when WebRTC is active.

1. Add a private mutable field:
   `private var modeControlEnabled = true`

2. Add a public method to disable mode control:
   ```kotlin
   /**
    * Disable AudioManager mode control (called after WebRTC PeerConnectionFactory init).
    * WebRTC's AudioDeviceModule will own MODE_IN_COMMUNICATION.
    * AudioRouter continues to handle routing (speakerphone, Bluetooth device selection).
    */
   fun disableModeControl() {
       modeControlEnabled = false
       Log.d(TAG, "AudioManager mode control disabled (WebRTC owns MODE_IN_COMMUNICATION)")
   }
   ```

3. Guard ALL `audioManager.mode = AudioManager.MODE_IN_COMMUNICATION` lines behind the flag.
   There are 5 locations that set MODE_IN_COMMUNICATION:
   - `setEarpieceMode()` — wrap in `if (modeControlEnabled)`
   - `setSpeakerMode()` — wrap in `if (modeControlEnabled)`
   - `setBluetoothMode()` — wrap in `if (modeControlEnabled)`
   - `setWiredHeadsetMode()` — wrap in `if (modeControlEnabled)`
   - `resetAudioMode()` — keep as-is (MODE_NORMAL is safe, used when leaving channel)

   Example for setEarpieceMode():
   ```kotlin
   fun setEarpieceMode() {
       Log.d(TAG, "Setting audio mode: earpiece")
       if (modeControlEnabled) {
           audioManager.mode = AudioManager.MODE_IN_COMMUNICATION
       }
       audioManager.isSpeakerphoneOn = false
   }
   ```

   Apply same pattern to setSpeakerMode(), setBluetoothMode(), setWiredHeadsetMode().

4. Do NOT change: requestAudioFocus(), releaseAudioFocus(), resetAudioMode(), clearCommunicationDevice(), getAudioManager(), isInPhoneCall(). These remain unchanged.

IMPORTANT: The default is `modeControlEnabled = true` so existing behavior is preserved until Plan 02 calls `disableModeControl()` after PeerConnectionFactory initialization. This ensures backward compatibility.
  </action>
  <verify>
Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL. Verify the file contains `modeControlEnabled` field and `disableModeControl()` method by searching the file.
  </verify>
  <done>
AudioRouter.kt has `private var modeControlEnabled = true` field and `fun disableModeControl()` method. All 4 methods that set MODE_IN_COMMUNICATION (setEarpieceMode, setSpeakerMode, setBluetoothMode, setWiredHeadsetMode) guard the mode assignment behind `if (modeControlEnabled)`. resetAudioMode() still sets MODE_NORMAL unconditionally. App compiles successfully.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` — BUILD SUCCESSFUL
2. `grep "0.21.0" android/app/build.gradle.kts` — confirms version upgrade
3. `grep "MediasoupClient.initialize" android/app/src/main/java/com/voiceping/android/VoicePingApplication.kt` — confirms WebRTC init
4. `grep "modeControlEnabled" android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt` — confirms coordination flag
5. `grep -c "MODE_IN_COMMUNICATION" android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt` — should be 4 (in guarded blocks)
</verification>

<success_criteria>
- libmediasoup-android upgraded from 0.7.0 to 0.21.0 in build.gradle.kts
- VoicePingApplication.onCreate() initializes WebRTC native libraries
- AudioRouter has modeControlEnabled flag with disableModeControl() method
- All MODE_IN_COMMUNICATION assignments guarded (except resetAudioMode)
- compileDebugKotlin succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-library-upgrade-and-webrtc-foundation/11-01-SUMMARY.md`
</output>
