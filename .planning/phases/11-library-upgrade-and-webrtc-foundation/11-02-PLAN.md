---
phase: 11-library-upgrade-and-webrtc-foundation
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt
autonomous: true

must_haves:
  truths:
    - "PeerConnectionFactory initializes with hardware echo cancellation and noise suppression enabled"
    - "AudioRouter mode control is disabled after PeerConnectionFactory creation (WebRTC owns MODE_IN_COMMUNICATION)"
    - "Device loads server router RTP capabilities and validates Opus codec support"
    - "Device RTP capabilities are accessible via getRtpCapabilities() for future consume requests"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt"
      provides: "PeerConnectionFactory, AudioDeviceModule, Device with RTP capabilities"
      contains: "PeerConnectionFactory"
    - path: "android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt"
      provides: "Device RTP capabilities accessor"
      contains: "getRtpCapabilities"
  key_links:
    - from: "MediasoupClient.kt"
      to: "JavaAudioDeviceModule"
      via: "builder with AEC and NS enabled"
      pattern: "setUseHardwareAcousticEchoCanceler\\(true\\)"
    - from: "MediasoupClient.kt"
      to: "AudioRouter.disableModeControl()"
      via: "called after PeerConnectionFactory creation"
      pattern: "audioRouter\\.disableModeControl"
    - from: "MediasoupClient.kt"
      to: "Device.load()"
      via: "loads router RTP capabilities in initialize()"
      pattern: "device\\.load"
    - from: "MediasoupClient.kt"
      to: "device.rtpCapabilities"
      via: "getRtpCapabilities() accessor"
      pattern: "getRtpCapabilities"
---

<objective>
Wire PeerConnectionFactory with custom AudioDeviceModule (echo cancellation + noise suppression), coordinate AudioManager ownership with AudioRouter, and implement Device RTP capabilities loading with Opus validation.

Purpose: This is the core WebRTC integration. PeerConnectionFactory is the engine that creates AudioSource/AudioTrack for microphone capture (Phase 13) and manages audio playback (Phase 12). Device.load() establishes codec compatibility between client and server, required before any transport creation. AudioRouter coordination prevents the critical dual-control bug where both WebRTC and the app fight over AudioManager.MODE_IN_COMMUNICATION.

Output: MediasoupClient.kt with real library types replacing placeholder `Any?`, PeerConnectionFactory initialized, Device loaded with validated RTP capabilities.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-library-upgrade-and-webrtc-foundation/11-RESEARCH.md
@.planning/phases/11-library-upgrade-and-webrtc-foundation/11-01-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt
@android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
@android/app/src/main/java/com/voiceping/android/data/network/SignalingClient.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize PeerConnectionFactory with AudioDeviceModule and coordinate AudioRouter</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt
  </files>
  <action>
Replace the placeholder MediasoupClient.kt with real library integration. This task focuses on PeerConnectionFactory + AudioDeviceModule setup and AudioRouter coordination. The Device/RTP work is in Task 2.

1. **Update imports** — Replace placeholder imports with actual library types:
   ```kotlin
   import io.github.crow_misia.mediasoup.Device
   import org.webrtc.PeerConnectionFactory
   import org.webrtc.audio.JavaAudioDeviceModule
   ```
   Keep existing imports for Context, Log, Gson, SignalingClient, coroutine types, Hilt annotations.

2. **Add AudioRouter dependency injection** — Add AudioRouter as constructor parameter:
   ```kotlin
   @Singleton
   class MediasoupClient @Inject constructor(
       private val signalingClient: SignalingClient,
       private val audioRouter: AudioRouter,  // NEW: for coordination
       @ApplicationContext private val context: Context
   )
   ```
   Add import: `import com.voiceping.android.data.audio.AudioRouter`

3. **Replace `Any?` fields with real library types:**
   - Change `private var device: Any? = null` to `private val device: Device by lazy { Device() }`
   - Add `private lateinit var audioDeviceModule: JavaAudioDeviceModule`
   - Add `private lateinit var peerConnectionFactory: PeerConnectionFactory`
   - Keep `recvTransport`, `sendTransport`, `consumers`, `audioProducer` as `Any?` for now (Phase 12/13 will type them)

4. **Add initializeWebRTC() method** — Create PeerConnectionFactory with custom AudioDeviceModule:
   ```kotlin
   /**
    * Initialize PeerConnectionFactory with custom AudioDeviceModule.
    * MUST be called before Device.load() and any transport creation.
    *
    * Configures:
    * - Hardware acoustic echo cancellation (AEC) — prevents speaker audio feeding back into mic
    * - Hardware noise suppression (NS) — filters background noise for clear PTT transmission
    * - Error callbacks for AudioRecord/AudioTrack lifecycle monitoring
    *
    * After initialization, disables AudioRouter's MODE_IN_COMMUNICATION control
    * because WebRTC's AudioDeviceModule now owns that responsibility.
    */
   fun initializeWebRTC() {
       audioDeviceModule = JavaAudioDeviceModule.builder(context)
           .setUseHardwareAcousticEchoCanceler(true)
           .setUseHardwareNoiseSuppressor(true)
           .setAudioRecordErrorCallback(object : JavaAudioDeviceModule.AudioRecordErrorCallback {
               override fun onWebRtcAudioRecordInitError(errorMessage: String) {
                   Log.e(TAG, "AudioRecord init error: $errorMessage")
               }
               override fun onWebRtcAudioRecordStartError(
                   errorCode: JavaAudioDeviceModule.AudioRecordStartErrorCode,
                   errorMessage: String
               ) {
                   Log.e(TAG, "AudioRecord start error: $errorCode - $errorMessage")
               }
               override fun onWebRtcAudioRecordError(errorMessage: String) {
                   Log.e(TAG, "AudioRecord error: $errorMessage")
               }
           })
           .setAudioTrackErrorCallback(object : JavaAudioDeviceModule.AudioTrackErrorCallback {
               override fun onWebRtcAudioTrackInitError(errorMessage: String) {
                   Log.e(TAG, "AudioTrack init error: $errorMessage")
               }
               override fun onWebRtcAudioTrackStartError(
                   errorCode: JavaAudioDeviceModule.AudioTrackStartErrorCode,
                   errorMessage: String
               ) {
                   Log.e(TAG, "AudioTrack start error: $errorCode - $errorMessage")
               }
               override fun onWebRtcAudioTrackError(errorMessage: String) {
                   Log.e(TAG, "AudioTrack error: $errorMessage")
               }
           })
           .createAudioDeviceModule()

       peerConnectionFactory = PeerConnectionFactory.builder()
           .setAudioDeviceModule(audioDeviceModule)
           .createPeerConnectionFactory()

       // Coordinate with AudioRouter: WebRTC now owns MODE_IN_COMMUNICATION
       audioRouter.disableModeControl()

       Log.d(TAG, "PeerConnectionFactory initialized with AEC and NS enabled")
   }
   ```

5. **Call initializeWebRTC() at start of initialize() suspend function** — Before requesting RTP capabilities. Add `initializeWebRTC()` as the first line inside the try block of `initialize()`, before the existing signaling request. This ensures PeerConnectionFactory exists before Device.load().

CRITICAL NOTES:
- The `AudioRouter` import uses the existing app class, NOT a new dependency. Hilt auto-resolves it from the existing @Singleton binding.
- `PeerConnectionFactory.builder()` requires the library's WebRTC classes bundled in libmediasoup-android 0.21.0. These are available because Plan 01 upgraded the dependency.
- `audioRouter.disableModeControl()` calls the method added in Plan 01's Task 2.
  </action>
  <verify>
Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -30` and confirm BUILD SUCCESSFUL. Verify the file contains PeerConnectionFactory, JavaAudioDeviceModule, and audioRouter.disableModeControl() calls.
  </verify>
  <done>
MediasoupClient.kt has `private lateinit var peerConnectionFactory: PeerConnectionFactory` and `private lateinit var audioDeviceModule: JavaAudioDeviceModule`. initializeWebRTC() creates AudioDeviceModule with hardware AEC and NS enabled, creates PeerConnectionFactory, and calls audioRouter.disableModeControl(). AudioRouter is injected as constructor parameter. compileDebugKotlin succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Device RTP capabilities loading with Opus validation</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt
  </files>
  <action>
Complete the initialize() method with real Device.load() and add getRtpCapabilities() accessor.

1. **Update initialize() to use real Device.load()** — Replace the TODO placeholder in the initialize() suspend function:

   After `initializeWebRTC()` (added in Task 1), the existing code already requests router RTP capabilities from the server. Replace the TODO block with real library calls:
   ```kotlin
   // Step 2: Load capabilities into Device (blocks IO thread 50-200ms)
   // Validates device can handle router's codecs
   device.load(rtpCapabilities, null)

   // Step 3: Validate Opus codec support (required for audio-only app)
   val deviceCaps = device.rtpCapabilities
   val hasOpus = deviceCaps.codecs.any {
       it.mimeType.equals("audio/opus", ignoreCase = true)
   }

   if (!hasOpus) {
       throw IllegalStateException("Device does not support Opus codec — cannot proceed with audio")
   }

   Log.d(TAG, "Device loaded with Opus codec support validated")
   ```

   Remove these lines that are being replaced:
   ```
   // TODO: Integrate actual libmediasoup-android library
   // device = Device()
   // device?.load(rtpCapabilities)
   // Placeholder: Mark as initialized once library is integrated
   ```

   Keep the existing `_isInitialized.value = true` line after the new code.

2. **Add getRtpCapabilities() public method** — For future server consume requests (Phases 12-13):
   ```kotlin
   /**
    * Get device RTP capabilities for server consume requests.
    * Server needs this to create consumers compatible with device's codecs.
    *
    * @return JSON string of device's RTP capabilities
    * @throws IllegalStateException if device not initialized
    */
   fun getRtpCapabilities(): String {
       if (!_isInitialized.value) {
           throw IllegalStateException("Device not initialized, call initialize() first")
       }
       return toJsonString(device.rtpCapabilities)
   }
   ```

3. **Verify the complete initialize() flow is:**
   a. initializeWebRTC() — creates PeerConnectionFactory, disables AudioRouter mode control
   b. Request router RTP capabilities from server via signaling
   c. device.load(rtpCapabilities, null) — load caps into Device
   d. Validate Opus codec presence in device capabilities
   e. Set _isInitialized to true

NOTE on `device.load(rtpCapabilities, null)`: The first param is JSON string of router RTP capabilities. The second param is `peerConnectionOptions` which can be null (uses defaults). The existing code already parses `rtpCapabilities` as JSON string via `toJsonString()` — use that same variable.

NOTE on `device.rtpCapabilities`: This is a property on the crow-misia Device class that returns the device's own RTP capabilities (codecs it supports, RTP header extensions). The `.codecs` property is a list with `.mimeType` field on each entry.
  </action>
  <verify>
Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin 2>&1 | tail -20` and confirm BUILD SUCCESSFUL. Verify MediasoupClient.kt contains `device.load(`, `device.rtpCapabilities`, `getRtpCapabilities()`, and `audio/opus` validation.
  </verify>
  <done>
initialize() calls device.load(rtpCapabilities, null) with real library Device. Opus codec validation checks device.rtpCapabilities.codecs for "audio/opus" mimeType. getRtpCapabilities() returns JSON-serialized device capabilities. No TODO placeholders remain in initialize(). compileDebugKotlin succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` — BUILD SUCCESSFUL
2. `grep "PeerConnectionFactory" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms factory exists
3. `grep "setUseHardwareAcousticEchoCanceler" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms AEC enabled
4. `grep "setUseHardwareNoiseSuppressor" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms NS enabled
5. `grep "audioRouter.disableModeControl" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms coordination
6. `grep "device.load" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms Device loads capabilities
7. `grep "audio/opus" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms Opus validation
8. `grep "getRtpCapabilities" android/app/src/main/java/com/voiceping/android/data/network/MediasoupClient.kt` — confirms accessor exists
</verification>

<success_criteria>
- PeerConnectionFactory created with custom JavaAudioDeviceModule (AEC + NS enabled)
- AudioRouter.disableModeControl() called after PeerConnectionFactory init
- Device.load() called with server router RTP capabilities
- Opus codec validated in device capabilities after load
- getRtpCapabilities() method returns device RTP capabilities as JSON string
- No TODO placeholders remain in initialize() method
- compileDebugKotlin succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-library-upgrade-and-webrtc-foundation/11-02-SUMMARY.md`
</output>
