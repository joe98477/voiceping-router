---
phase: 09-hardware-ptt-bluetooth
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
  - android/app/src/main/java/com/voiceping/android/presentation/settings/ButtonDetectionScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
autonomous: true

must_haves:
  truths:
    - "User can configure which volume key triggers PTT (up, down, both, or disabled) in settings"
    - "User can detect Bluetooth headset button via press-to-detect screen"
    - "User can enable/disable Bluetooth PTT button in settings"
    - "User can enable/disable boot auto-start in settings"
    - "Top bar shows small icon indicating current audio output device"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt"
      provides: "Hardware Buttons settings section with volume key config, BT PTT toggle, boot auto-start toggle"
      contains: "Hardware Buttons"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/settings/ButtonDetectionScreen.kt"
      provides: "Press-to-detect screen for Bluetooth button learning"
      contains: "Press any button"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt"
      provides: "Audio output device icon in TopAppBar and button detection dialog"
      contains: "currentOutputDevice"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt"
      provides: "Hardware settings state flows and setters for UI"
      contains: "volumeKeyPttConfig"
  key_links:
    - from: "ProfileDrawer.kt"
      to: "ChannelListViewModel.kt"
      via: "settings callbacks propagate to SettingsRepository via ViewModel"
      pattern: "onVolumeKeyPttConfigChanged|onBootAutoStartChanged"
    - from: "ChannelListScreen.kt"
      to: "AudioDeviceManager.kt"
      via: "collects currentOutputDevice for icon display via ViewModel"
      pattern: "currentOutputDevice"
    - from: "ButtonDetectionScreen.kt"
      to: "MediaButtonHandler.kt"
      via: "starts detection mode and receives detected keycode"
      pattern: "startDetectionMode|onButtonDetected"
---

<objective>
Create the settings UI for hardware button configuration, implement the press-to-detect screen for Bluetooth button learning, and add the audio output device indicator icon to the top bar.

Purpose: Provides the user interface for all hardware PTT configuration per user decisions: dedicated "Hardware Buttons" section in settings, press-to-detect screen for BT button learning, boot auto-start toggle, and audio device indicator.

Output: Extended ProfileDrawer with hardware settings, ButtonDetectionScreen composable, audio device icon in TopAppBar, and all ViewModel wiring.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hardware-ptt-bluetooth/09-RESEARCH.md
@.planning/phases/09-hardware-ptt-bluetooth/09-CONTEXT.md
@.planning/phases/09-hardware-ptt-bluetooth/09-01-SUMMARY.md
@.planning/phases/09-hardware-ptt-bluetooth/09-02-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Hardware Buttons settings section to ProfileDrawer and create ButtonDetectionScreen</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/shell/ProfileDrawer.kt
    android/app/src/main/java/com/voiceping/android/presentation/settings/ButtonDetectionScreen.kt
  </files>
  <action>
    1. **Add new parameters to ProfileDrawer** for hardware button settings:
       ```kotlin
       // Hardware button settings
       volumeKeyPttConfig: VolumeKeyPttConfig = VolumeKeyPttConfig.DISABLED,
       bluetoothPttEnabled: Boolean = false,
       bluetoothPttButtonKeycode: Int = 85, // KEYCODE_MEDIA_PLAY_PAUSE
       bootAutoStartEnabled: Boolean = false,
       onVolumeKeyPttConfigChanged: (VolumeKeyPttConfig) -> Unit = {},
       onBluetoothPttEnabledChanged: (Boolean) -> Unit = {},
       onDetectBluetoothButton: () -> Unit = {},
       onBootAutoStartChanged: (Boolean) -> Unit = {},
       ```

    2. **Add "Hardware Buttons" section to ProfileDrawer** — position it between "Audio Tones" and "Scan Mode" sections (per user decision: dedicated section, separate from PTT mode/tones):

       ```
       // --- Hardware Buttons Section ---
       Spacer + HorizontalDivider

       "Hardware Buttons" title (titleSmall, primary color — same pattern as other sections)

       // Volume Key PTT subsection
       "Volume Key PTT" bodyMedium label
       Column with RadioButtons:
         - "Disabled" (VolumeKeyPttConfig.DISABLED) — selected by default
         - "Volume Up" (VolumeKeyPttConfig.VOLUME_UP)
         - "Volume Down" (VolumeKeyPttConfig.VOLUME_DOWN)
         - "Both Keys" (VolumeKeyPttConfig.BOTH)
       Small helper text: "Long-press activates PTT, short tap adjusts volume"

       Spacer(8.dp)

       // Bluetooth PTT subsection
       "Bluetooth PTT Button" bodyMedium label
       Row with Switch: "Enable Bluetooth PTT" toggle

       // When BT PTT enabled, show configured button info + detect button
       if (bluetoothPttEnabled) {
           Row showing current button: "Button: ${keyCodeToName(bluetoothPttButtonKeycode)}"
           TextButton "Detect Button" that calls onDetectBluetoothButton
       }

       Spacer(8.dp) + HorizontalDivider

       // Boot Auto-Start subsection
       "Startup" bodyMedium label
       Row with Switch: "Start on boot" toggle + description "Auto-start when device powers on"
       if (bootAutoStartEnabled) {
           Small text: "Android 15+ shows notification instead of auto-starting"
       }
       ```

       Add helper function `keyCodeToName(keyCode: Int): String` that maps common keycodes to friendly names:
       - 85 -> "Play/Pause"
       - 79 -> "Headset Hook"
       - 87 -> "Next Track"
       - 88 -> "Previous Track"
       - 126 -> "Play"
       - 127 -> "Pause"
       - else -> "Key $keyCode"

       Follow EXACT visual patterns from existing ProfileDrawer sections (same padding, typography, spacing, RadioButton+Row+selectable pattern).

    3. **Create ButtonDetectionScreen.kt** in presentation/settings/ package:

       A dialog/screen composable for the press-to-detect functionality:

       ```kotlin
       @Composable
       fun ButtonDetectionDialog(
           isOpen: Boolean,
           detectedKeyCode: Int?,
           detectedKeyName: String?,
           onDismiss: () -> Unit,
           onConfirm: (Int) -> Unit // Confirm detected keycode
       )
       ```

       UI structure:
       - AlertDialog with:
         - Title: "Detect Bluetooth Button"
         - Content:
           - If detectedKeyCode == null: "Press any button on your Bluetooth headset..."
           - If detectedKeyCode != null: "Detected: $detectedKeyName (code: $detectedKeyCode)"
           - Small helper text: "Try the play/pause or call button on your headset"
         - Dismiss button: "Cancel"
         - Confirm button (only enabled when detectedKeyCode != null): "Use This Button"
           - Calls onConfirm(detectedKeyCode!!)

       Import VolumeKeyPttConfig from domain/model package.
  </action>
  <verify>
    Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` — compilation passes. Verify ProfileDrawer has "Hardware Buttons" section with volume key radio buttons, BT PTT toggle, and boot auto-start toggle. Verify ButtonDetectionDialog exists with press-to-detect UI.
  </verify>
  <done>
    ProfileDrawer has dedicated "Hardware Buttons" section with volume key PTT config (4 radio buttons), Bluetooth PTT toggle with detected button display, and boot auto-start toggle. ButtonDetectionDialog shows press-to-detect UI for Bluetooth button learning.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add audio device icon to TopAppBar and wire hardware settings to ViewModel and Screen</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  </files>
  <action>
    1. **Extend ChannelListViewModel** with hardware settings state and actions:

       Add state flows:
       ```kotlin
       val volumeKeyPttConfig: StateFlow<VolumeKeyPttConfig> = settingsRepository.getVolumeKeyPttConfig()
           .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), VolumeKeyPttConfig.DISABLED)
       val bluetoothPttEnabled: StateFlow<Boolean> = settingsRepository.getBluetoothPttEnabled()
           .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)
       val bluetoothPttButtonKeycode: StateFlow<Int> = settingsRepository.getBluetoothPttButtonKeycode()
           .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), 85)
       val bootAutoStartEnabled: StateFlow<Boolean> = settingsRepository.getBootAutoStartEnabled()
           .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)
       ```

       Add current audio output device flow:
       ```kotlin
       val currentOutputDevice: StateFlow<AudioOutputDevice> = channelRepository.currentOutputDevice
       ```
       (ChannelRepository will need to expose AudioDeviceManager.currentOutputDevice — add `val currentOutputDevice: StateFlow<AudioOutputDevice>` to ChannelRepository that delegates to audioDeviceManager.currentOutputDevice. Default to SPEAKER if audioDeviceManager is not started.)

       Add setters:
       ```kotlin
       fun setVolumeKeyPttConfig(config: VolumeKeyPttConfig) = viewModelScope.launch {
           settingsRepository.setVolumeKeyPttConfig(config)
       }
       fun setBluetoothPttEnabled(enabled: Boolean) = viewModelScope.launch {
           settingsRepository.setBluetoothPttEnabled(enabled)
           // Also update MediaButtonHandler active state if channels are joined
           // (handled via SettingsRepository observer in ChannelRepository)
       }
       fun setBluetoothPttButtonKeycode(keyCode: Int) = viewModelScope.launch {
           settingsRepository.setBluetoothPttButtonKeycode(keyCode)
       }
       fun setBootAutoStartEnabled(enabled: Boolean) = viewModelScope.launch {
           settingsRepository.setBootAutoStartEnabled(enabled)
       }
       ```

       Add button detection state:
       ```kotlin
       private val _showButtonDetection = MutableStateFlow(false)
       val showButtonDetection: StateFlow<Boolean> = _showButtonDetection.asStateFlow()
       private val _detectedKeyCode = MutableStateFlow<Int?>(null)
       val detectedKeyCode: StateFlow<Int?> = _detectedKeyCode.asStateFlow()

       fun startButtonDetection() {
           _showButtonDetection.value = true
           _detectedKeyCode.value = null
           // Start detection mode in MediaButtonHandler
           channelRepository.startButtonDetection { keyCode ->
               _detectedKeyCode.value = keyCode
           }
       }

       fun confirmDetectedButton() {
           _detectedKeyCode.value?.let { keyCode ->
               setBluetoothPttButtonKeycode(keyCode)
           }
           stopButtonDetection()
       }

       fun stopButtonDetection() {
           _showButtonDetection.value = false
           _detectedKeyCode.value = null
           channelRepository.stopButtonDetection()
       }
       ```

       Add to init block — collect displayedChannelId and update ChannelRepository:
       ```kotlin
       viewModelScope.launch {
           displayedChannelId.collect { channelId ->
               channelRepository.currentDisplayedChannelId = channelId
           }
       }
       ```

    2. **Update ChannelListScreen** with hardware settings wiring and audio device icon:

       Collect new state:
       ```kotlin
       val volumeKeyPttConfig by viewModel.volumeKeyPttConfig.collectAsState()
       val bluetoothPttEnabled by viewModel.bluetoothPttEnabled.collectAsState()
       val bluetoothPttButtonKeycode by viewModel.bluetoothPttButtonKeycode.collectAsState()
       val bootAutoStartEnabled by viewModel.bootAutoStartEnabled.collectAsState()
       val currentOutputDevice by viewModel.currentOutputDevice.collectAsState()
       val showButtonDetection by viewModel.showButtonDetection.collectAsState()
       val detectedKeyCode by viewModel.detectedKeyCode.collectAsState()
       ```

       **Add audio device icon to TopAppBar actions** — position it BEFORE the connection status dot:
       ```kotlin
       // Audio output device icon
       Icon(
           imageVector = when (currentOutputDevice) {
               AudioOutputDevice.SPEAKER -> Icons.Default.VolumeUp
               AudioOutputDevice.EARPIECE -> Icons.Default.PhoneInTalk
               AudioOutputDevice.BLUETOOTH -> Icons.Default.Bluetooth
               AudioOutputDevice.WIRED_HEADSET -> Icons.Default.Headset
           },
           contentDescription = "Audio: ${currentOutputDevice.name}",
           modifier = Modifier.size(18.dp),
           tint = MaterialTheme.colorScheme.onSurfaceVariant
       )
       Spacer(modifier = Modifier.width(8.dp))
       ```

       **Wire ProfileDrawer hardware button settings:**
       Pass all new parameters and callbacks:
       ```kotlin
       volumeKeyPttConfig = volumeKeyPttConfig,
       bluetoothPttEnabled = bluetoothPttEnabled,
       bluetoothPttButtonKeycode = bluetoothPttButtonKeycode,
       bootAutoStartEnabled = bootAutoStartEnabled,
       onVolumeKeyPttConfigChanged = { viewModel.setVolumeKeyPttConfig(it) },
       onBluetoothPttEnabledChanged = { viewModel.setBluetoothPttEnabled(it) },
       onDetectBluetoothButton = { viewModel.startButtonDetection() },
       onBootAutoStartChanged = { viewModel.setBootAutoStartEnabled(it) },
       ```

       **Add ButtonDetectionDialog rendering:**
       ```kotlin
       if (showButtonDetection) {
           ButtonDetectionDialog(
               isOpen = true,
               detectedKeyCode = detectedKeyCode,
               detectedKeyName = detectedKeyCode?.let { keyCodeToName(it) },
               onDismiss = { viewModel.stopButtonDetection() },
               onConfirm = { viewModel.confirmDetectedButton() }
           )
       }
       ```

       Import keyCodeToName helper from ButtonDetectionScreen or create locally. Import AudioOutputDevice, VolumeKeyPttConfig, and ButtonDetectionDialog.
  </action>
  <verify>
    Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` — compilation passes. Verify:
    - TopAppBar has audio device icon before connection dot
    - ProfileDrawer has hardware button settings wired to ViewModel
    - ButtonDetectionDialog renders when showButtonDetection is true
    - ViewModel has all hardware settings flows and setters
  </verify>
  <done>
    TopAppBar shows audio output device icon (speaker/earpiece/BT/headset). ProfileDrawer Hardware Buttons section is fully wired to ViewModel and SettingsRepository. ButtonDetectionDialog enables Bluetooth button learning via press-to-detect. Boot auto-start toggle persists setting. All hardware settings persist across app restarts via DataStore.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew compileDebugKotlin` passes without errors
2. ProfileDrawer has "Hardware Buttons" section between "Audio Tones" and "Scan Mode"
3. Volume Key PTT shows 4 radio buttons (Disabled, Volume Up, Volume Down, Both)
4. Bluetooth PTT has enable toggle + detected button display + Detect Button action
5. Boot Auto-Start has toggle with Android 15 note
6. ButtonDetectionDialog shows "Press any button" prompt and detected button
7. TopAppBar shows audio device icon before connection dot
8. Icon changes based on currentOutputDevice (speaker/earpiece/BT/headset)
9. All settings persist via DataStore
10. ChannelListViewModel has all hardware settings state flows and setters
</verification>

<success_criteria>
Complete settings UI for hardware button configuration: users can configure volume key PTT, detect Bluetooth headset button, enable boot auto-start, and see current audio output device in the top bar. All settings persist and propagate through the architecture.
</success_criteria>

<output>
After completion, create `.planning/phases/09-hardware-ptt-bluetooth/09-04-SUMMARY.md`
</output>
