---
phase: 09-hardware-ptt-bluetooth
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/src/main/java/com/voiceping/android/data/audio/AudioDeviceManager.kt
  - android/app/src/main/java/com/voiceping/android/data/hardware/MediaButtonHandler.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
  - android/app/build.gradle.kts
autonomous: true

must_haves:
  truths:
    - "Audio automatically routes to Bluetooth headset when it connects (seamless, no prompt)"
    - "Audio falls back to previous output when Bluetooth disconnects"
    - "Last connected device wins priority (BT after wired -> BT gets audio)"
    - "Bluetooth headset media button events are intercepted via MediaSession"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/AudioDeviceManager.kt"
      provides: "Audio device detection, routing priority, current device state tracking"
      contains: "AudioDeviceCallback"
    - path: "android/app/src/main/java/com/voiceping/android/data/hardware/MediaButtonHandler.kt"
      provides: "MediaSession-based Bluetooth button interception"
      contains: "MediaSession"
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt"
      provides: "Extended audio routing with Bluetooth/wired headset support"
      contains: "setCommunicationDevice"
  key_links:
    - from: "AudioDeviceManager.kt"
      to: "AudioRouter.kt"
      via: "delegates actual audio routing to AudioRouter methods"
      pattern: "audioRouter\\.set.*Mode"
    - from: "MediaButtonHandler.kt"
      to: "PttManager.kt"
      via: "onPttPress/onPttRelease callbacks trigger PTT"
      pattern: "onPttPress|onPttRelease"
---

<objective>
Implement Bluetooth/wired audio device detection with automatic routing and MediaSession-based Bluetooth headset button interception.

Purpose: Enables seamless audio routing to connected Bluetooth headsets and allows users to trigger PTT from headset buttons. This is the core hardware integration that makes VoicePing work as a pocket radio.

Output: AudioDeviceManager for device detection/routing, MediaButtonHandler for BT button interception, and extended AudioRouter with modern audio routing APIs.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hardware-ptt-bluetooth/09-RESEARCH.md
@.planning/phases/09-hardware-ptt-bluetooth/09-CONTEXT.md
@android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
@android/app/src/main/java/com/voiceping/android/data/ptt/PttManager.kt
@android/app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AudioDeviceManager for Bluetooth and wired headset detection with automatic routing</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/audio/AudioDeviceManager.kt
    android/app/src/main/java/com/voiceping/android/data/audio/AudioRouter.kt
    android/app/build.gradle.kts
  </files>
  <action>
    1. **Add Media3 dependency to build.gradle.kts** (needed for MediaButtonHandler in Task 2):
       Add to dependencies block:
       ```
       implementation("androidx.media3:media3-session:1.5.1")
       implementation("androidx.media3:media3-exoplayer:1.5.1")
       ```
       Note: media3-exoplayer is needed because MediaSession requires a Player instance (we'll use a minimal ForwardingPlayer stub).

    2. **Extend AudioRouter** with new methods for Bluetooth and wired headset routing:
       - Add `fun setBluetoothMode(device: android.media.AudioDeviceInfo)`: Uses `audioManager.setCommunicationDevice(device)` on API 31+ (Android 12+), falls back to `audioManager.startBluetoothSco()` + `audioManager.isBluetoothScoOn = true` on older APIs. Sets `audioManager.mode = AudioManager.MODE_IN_COMMUNICATION`.
       - Add `fun setWiredHeadsetMode()`: Sets `audioManager.mode = AudioManager.MODE_IN_COMMUNICATION`, `audioManager.isSpeakerphoneOn = false` (routes to wired headset when connected).
       - Add `fun clearCommunicationDevice()`: On API 31+ calls `audioManager.clearCommunicationDevice()`. On older APIs, calls `audioManager.stopBluetoothSco()`, `audioManager.isBluetoothScoOn = false`.
       - Add `fun getAudioManager(): AudioManager` accessor so AudioDeviceManager can register callbacks on the same AudioManager instance.

    3. **Create AudioDeviceManager.kt** in data/audio/ package:

       ```kotlin
       @Singleton
       class AudioDeviceManager @Inject constructor(
           private val audioRouter: AudioRouter,
           @ApplicationContext private val context: Context
       )
       ```

       **State tracking:**
       - `private val _currentOutputDevice = MutableStateFlow(AudioOutputDevice.SPEAKER)` — current audio output device (for UI icon)
       - `val currentOutputDevice: StateFlow<AudioOutputDevice>` — exposed for UI
       - `private var previousDevice: AudioOutputDevice = AudioOutputDevice.SPEAKER` — device before BT/wired connected (for fallback)
       - `private var lastConnectedExternalDevice: android.media.AudioDeviceInfo? = null` — last connected BT/wired device

       **Callbacks:**
       - `var onBluetoothDisconnected: (() -> Unit)? = null` — called when BT disconnects while PTT active (triggers auto-release)

       **AudioDeviceCallback registration:**
       Register `AudioDeviceCallback` on the AudioManager from `audioRouter.getAudioManager()`:

       `onAudioDevicesAdded(addedDevices)`:
       - Filter for `isSink` (output) devices
       - Check device.type for: TYPE_BLUETOOTH_A2DP, TYPE_BLUETOOTH_SCO, TYPE_WIRED_HEADSET, TYPE_WIRED_HEADPHONES, TYPE_BLE_HEADSET
       - Per user decision "last connected device wins": update lastConnectedExternalDevice, save previousDevice
       - For Bluetooth types: call `audioRouter.setBluetoothMode(device)`, update _currentOutputDevice to BLUETOOTH
       - For wired types: call `audioRouter.setWiredHeadsetMode()`, update _currentOutputDevice to WIRED_HEADSET
       - Log device type and name

       `onAudioDevicesRemoved(removedDevices)`:
       - Check if removed device matches lastConnectedExternalDevice
       - If yes: fall back to previousDevice
         - Call appropriate AudioRouter method based on previousDevice (setSpeakerMode, setEarpieceMode)
         - Update _currentOutputDevice to previousDevice
         - Clear lastConnectedExternalDevice
         - If was Bluetooth type: invoke onBluetoothDisconnected callback (per user decision: auto-release PTT on BT disconnect)
       - Log device removal

       **Methods:**
       - `fun start()`: Register AudioDeviceCallback. Also scan currently connected devices (audioManager.getDevices(AudioManager.GET_DEVICES_OUTPUTS)) to detect already-connected BT/wired headsets.
       - `fun stop()`: Unregister AudioDeviceCallback, clear communication device.
       - `fun getCurrentDevice(): AudioOutputDevice` = _currentOutputDevice.value

       Use handler = null for callback registration (runs on main thread, which is fine for our quick routing calls).
  </action>
  <verify>
    Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` — compilation passes with AudioDeviceManager and updated AudioRouter.
  </verify>
  <done>
    AudioDeviceManager detects Bluetooth/wired device connections via AudioDeviceCallback, auto-routes audio to last connected device, tracks current output device for UI indicator, and provides fallback routing on device disconnect. AudioRouter extended with Bluetooth/wired routing methods using modern setCommunicationDevice API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MediaButtonHandler for Bluetooth headset button interception via MediaSession</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/hardware/MediaButtonHandler.kt
  </files>
  <action>
    Create `MediaButtonHandler.kt` in data/hardware/ package:

    ```kotlin
    @Singleton
    class MediaButtonHandler @Inject constructor(
        @ApplicationContext private val context: Context
    )
    ```

    **Purpose:** Intercept Bluetooth headset button presses via Media3 MediaSession and trigger PTT actions. Only active when ChannelMonitoringService is running (user joined a channel).

    **State:**
    - `private var mediaSession: androidx.media3.session.MediaSession? = null`
    - `private var player: androidx.media3.exoplayer.ExoPlayer? = null`
    - `private var isActive: Boolean = false`
    - `private var configuredKeyCode: Int = KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE` — the BT button keycode user configured via press-to-detect

    **Callbacks:**
    - `var onPttPress: (() -> Unit)? = null` — called when configured BT button is pressed
    - `var onPttRelease: (() -> Unit)? = null` — called when configured BT button is released
    - `var onButtonDetected: ((Int) -> Unit)? = null` — called during button detection mode with detected keyCode

    **Detection mode:**
    - `private var isDetectionMode: Boolean = false`
    - When detection mode is active, ANY media button press reports the keyCode via onButtonDetected callback instead of triggering PTT

    **Method: `fun initialize()`**
    - Create a minimal ExoPlayer instance: `ExoPlayer.Builder(context).build()` (needed because Media3 MediaSession requires a Player)
    - Create MediaSession with callback that overrides `onMediaButtonEvent`:
      ```kotlin
      MediaSession.Builder(context, player!!)
          .setCallback(object : MediaSession.Callback {
              override fun onMediaButtonEvent(
                  session: MediaSession,
                  controllerInfo: MediaSession.ControllerInfo,
                  intent: Intent
              ): Boolean {
                  val keyEvent = intent.getParcelableExtra<KeyEvent>(Intent.EXTRA_KEY_EVENT)
                  if (keyEvent != null) {
                      return handleMediaButton(keyEvent)
                  }
                  return false
              }
          })
          .build()
      ```
    - Note: Do NOT call player.play() or prepare() — we don't need actual playback, just the MediaSession for button events.

    **Method: `fun handleMediaButton(event: KeyEvent): Boolean`**
    - If isDetectionMode:
      - On ACTION_DOWN with repeatCount == 0: report event.keyCode via onButtonDetected callback
      - Return true (consume)
    - If not detection mode and event.keyCode matches configuredKeyCode:
      - ACTION_DOWN (repeatCount == 0): invoke onPttPress callback
      - ACTION_UP: invoke onPttRelease callback
      - Return true (consume)
    - Common headset button codes to handle: KEYCODE_MEDIA_PLAY_PAUSE (85), KEYCODE_HEADSETHOOK (79), KEYCODE_MEDIA_NEXT (87), KEYCODE_MEDIA_PREVIOUS (88), KEYCODE_MEDIA_PLAY (126), KEYCODE_MEDIA_PAUSE (127)
    - For any other keyCode: return false (don't consume)

    **Method: `fun setActive(active: Boolean)`**
    - Only activate MediaSession when service is running (avoids stealing media buttons from music apps per research pitfall 5)
    - If active && mediaSession == null: call initialize()
    - If !active && mediaSession != null: call release()
    - Update isActive flag

    **Method: `fun setConfiguredKeyCode(keyCode: Int)`**
    - Update configuredKeyCode (called when user changes setting or after press-to-detect)

    **Method: `fun startDetectionMode()`**
    - Set isDetectionMode = true
    - If not already initialized, call initialize()

    **Method: `fun stopDetectionMode()`**
    - Set isDetectionMode = false
    - If not isActive: call release() (clean up if only started for detection)

    **Method: `fun release()`**
    - Release MediaSession, release ExoPlayer, set both to null
    - Set isActive = false

    Add companion object with TAG = "MediaButtonHandler".
  </action>
  <verify>
    Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew compileDebugKotlin` — compilation passes. Verify MediaButtonHandler has initialize, handleMediaButton, setActive, startDetectionMode, stopDetectionMode, release methods.
  </verify>
  <done>
    MediaButtonHandler creates a Media3 MediaSession to intercept Bluetooth headset button events. Supports configurable button keycode (detected via press-to-detect screen), detection mode for button learning, and PTT press/release callbacks. Only active when service is running (avoids stealing media buttons from other apps).
  </done>
</task>

</tasks>

<verification>
1. `./gradlew compileDebugKotlin` passes without errors
2. Media3 dependencies added to build.gradle.kts
3. AudioRouter has setBluetoothMode, setWiredHeadsetMode, clearCommunicationDevice methods
4. AudioDeviceManager registers AudioDeviceCallback and detects BT/wired connections
5. AudioDeviceManager auto-routes audio to last connected device
6. AudioDeviceManager falls back to previous device on disconnect
7. AudioDeviceManager exposes currentOutputDevice StateFlow for UI
8. MediaButtonHandler creates MediaSession with onMediaButtonEvent callback
9. MediaButtonHandler supports configurable keyCode matching
10. MediaButtonHandler has detection mode for press-to-detect screen
</verification>

<success_criteria>
AudioDeviceManager and MediaButtonHandler compile, implement automatic audio routing with "last connected wins" priority, and provide Bluetooth button interception via MediaSession with configurable button mapping and detection mode.
</success_criteria>

<output>
After completion, create `.planning/phases/09-hardware-ptt-bluetooth/09-02-SUMMARY.md`
</output>
