---
phase: 10-network-resilience-ux-polish
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/domain/model/NetworkQuality.kt
  - android/app/src/main/java/com/voiceping/android/domain/model/TransmissionHistoryEntry.kt
  - android/app/src/main/java/com/voiceping/android/data/repository/TransmissionHistoryRepository.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/NetworkQualityIndicator.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/TransmissionHistorySheet.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
autonomous: true

must_haves:
  truths:
    - "User sees signal bars icon near connection status dot in top bar"
    - "Tapping signal bars reveals popup showing latency (ms), connection type, and server name"
    - "Signal bars update in real-time based on WebSocket ping latency"
    - "Long-press on channel row opens bottom sheet with last 20 transmissions"
    - "Transmission history shows speaker name, timestamp, and duration per entry"
    - "Transmission history is session-only (in-memory), clears on app restart"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/domain/model/NetworkQuality.kt"
      provides: "NetworkQuality enum mapping latency to signal bars (1-4)"
      contains: "fromLatency"
    - path: "android/app/src/main/java/com/voiceping/android/data/repository/TransmissionHistoryRepository.kt"
      provides: "In-memory circular buffer storing last 20 transmissions per channel"
      contains: "CircularBuffer"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/NetworkQualityIndicator.kt"
      provides: "Signal bars composable with tap-to-reveal quality popup"
      contains: "SignalCellular"
    - path: "android/app/src/main/java/com/voiceping/android/presentation/channels/components/TransmissionHistorySheet.kt"
      provides: "ModalBottomSheet with LazyColumn showing transmission history"
      contains: "ModalBottomSheet"
  key_links:
    - from: "NetworkQualityIndicator"
      to: "SignalingClient.latency"
      via: "ViewModel exposes latency StateFlow to UI"
      pattern: "latency"
    - from: "TransmissionHistorySheet"
      to: "TransmissionHistoryRepository"
      via: "ViewModel provides history list per channel"
      pattern: "getHistory"
    - from: "ChannelRow"
      to: "TransmissionHistorySheet"
      via: "Long-press on channel row opens bottom sheet"
      pattern: "onLongClick|onLongPress"
---

<objective>
Network quality indicator (signal bars with tap-to-reveal detail popup) and transmission history (bottom sheet with last 20 transmissions per channel via long-press on channel row).

Purpose: UX-02 (network quality indicator) gives users real-time visibility into connection quality. UX-03 (transmission history) lets users review recent channel activity. Both enhance situational awareness for field workers.

Output: NetworkQuality model, NetworkQualityIndicator composable, TransmissionHistoryRepository, TransmissionHistorySheet composable, ChannelRow long-press handler, ViewModel wiring.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-network-resilience-ux-polish/10-CONTEXT.md
@.planning/phases/10-network-resilience-ux-polish/10-RESEARCH.md
@.planning/phases/10-network-resilience-ux-polish/10-01-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/data/network/SignalingClient.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NetworkQuality model, TransmissionHistoryRepository, and domain models</name>
  <files>
    android/app/src/main/java/com/voiceping/android/domain/model/NetworkQuality.kt
    android/app/src/main/java/com/voiceping/android/domain/model/TransmissionHistoryEntry.kt
    android/app/src/main/java/com/voiceping/android/data/repository/TransmissionHistoryRepository.kt
  </files>
  <action>
    1. Create NetworkQuality enum in domain/model/NetworkQuality.kt:
       ```kotlin
       enum class NetworkQuality(val bars: Int) {
           EXCELLENT(4), // <100ms - LAN/WiFi optimal
           GOOD(3),      // 100-300ms - Normal WiFi/cellular
           FAIR(2),      // 300-600ms - Degraded connection
           POOR(1);      // >600ms or null - Unusable for PTT

           companion object {
               fun fromLatency(latencyMs: Long?): NetworkQuality {
                   return when {
                       latencyMs == null -> POOR
                       latencyMs < 100 -> EXCELLENT
                       latencyMs < 300 -> GOOD
                       latencyMs < 600 -> FAIR
                       else -> POOR
                   }
               }
           }
       }
       ```

    2. Create TransmissionHistoryEntry data class in domain/model/TransmissionHistoryEntry.kt:
       ```kotlin
       data class TransmissionHistoryEntry(
           val speakerName: String,
           val timestamp: Long,           // System.currentTimeMillis() when transmission ended
           val durationSeconds: Int,       // Duration in seconds
           val channelId: String,
           val isOwnTransmission: Boolean  // true if user was the speaker
       )
       ```

    3. Create TransmissionHistoryRepository in data/repository/TransmissionHistoryRepository.kt:
       @Singleton class with @Inject constructor.

       Internal storage:
       - `private val history = ConcurrentHashMap<String, MutableList<TransmissionHistoryEntry>>()`
       - `private val maxEntriesPerChannel = 20`
       - `private val _historyUpdated = MutableSharedFlow<String>()` (emit channelId on change for UI reactivity)

       Methods:
       - `addEntry(entry: TransmissionHistoryEntry)`:
         Get or create list for entry.channelId.
         If size >= maxEntriesPerChannel, removeFirst() (oldest).
         Add entry to list.
         Emit channelId on _historyUpdated SharedFlow.

       - `getHistory(channelId: String): List<TransmissionHistoryEntry>`:
         Return copy of list for channelId, or empty list.
         Return in reverse order (newest first).

       - `observeHistory(channelId: String): Flow<List<TransmissionHistoryEntry>>`:
         Return flow that emits history list whenever _historyUpdated emits matching channelId.
         Use _historyUpdated.filter { it == channelId }.map { getHistory(channelId) }.
         Start with current history using onStart { emit(getHistory(channelId)) }.

       - `clearAll()`: Clear all history (called on disconnect/logout).

       This is session-only (in-memory) per user decision. ConcurrentHashMap for thread safety.
  </action>
  <verify>
    cd android && ./gradlew compileDebugKotlin 2>&1 | tail -5
    Verify: NetworkQuality.fromLatency returns correct enum for threshold values
    Verify: TransmissionHistoryRepository stores last 20 per channel
    Verify: observeHistory returns reactive Flow
  </verify>
  <done>
    NetworkQuality maps latency thresholds to 1-4 signal bars. TransmissionHistoryRepository stores last 20 transmissions per channel in memory with reactive Flow observation. TransmissionHistoryEntry captures speaker name, timestamp, duration, and ownership.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NetworkQualityIndicator, TransmissionHistorySheet, and wire to ViewModel/Screen</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/NetworkQualityIndicator.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/TransmissionHistorySheet.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListViewModel.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/ChannelListScreen.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/ChannelRow.kt
  </files>
  <action>
    1. Create NetworkQualityIndicator composable in presentation/channels/components/NetworkQualityIndicator.kt:
       Per locked decisions:
       - Placement: Top bar, near existing connection status dot
       - Visual form: Signal bars icon (like cellular signal strength)
       - Tap action: Popup showing latency (ms), connection type (WiFi/cellular), and server name

       ```kotlin
       @Composable
       fun NetworkQualityIndicator(
           latency: Long?,
           networkType: NetworkType,
           serverUrl: String,
           modifier: Modifier = Modifier
       )
       ```

       Implementation:
       - Derive NetworkQuality from latency using NetworkQuality.fromLatency()
       - Signal bars icon: Use Material Icons. Map bars count to icon:
         - 4 bars: Icons.Default.SignalCellular4Bar
         - 3 bars: Icons.Default.NetworkCell (or SignalCellularAlt)
         - 2 bars: Icons.Default.SignalCellularAlt2Bar
         - 1 bar: Icons.Default.SignalCellularAlt1Bar
         - 0/null: Icons.Default.SignalCellularConnectedNoInternet0Bar
         Note: Some of these icons may not exist in material-icons-extended. Use available signal icons or fall back to custom Canvas drawing with 4 bars of increasing height. CHECK what's available first: SignalCellular4Bar, SignalCellularAlt, etc. If specific bar-count icons not available, use a Box with custom drawing: 4 vertical bars of increasing height, tinted based on quality (all bars = green/primary, fewer = yellow, poor = red).
       - Icon tint color: primary for EXCELLENT/GOOD, yellow for FAIR, error for POOR.
       - Wrap in IconButton for tap handling.
       - On tap: Show Popup/DropdownMenu composable:
         - Column with padding(16.dp):
           - Text("Latency: ${latency ?: "--"}ms", bodyMedium)
           - Text("Type: ${networkType.name}", bodySmall)
           - Text("Server: $serverUrl", bodySmall, onSurfaceVariant)
         - Dismiss on outside click.

    2. Create TransmissionHistorySheet composable in presentation/channels/components/TransmissionHistorySheet.kt:
       Per locked decisions:
       - Access: Long-press on channel row opens bottom sheet
       - Entry info: Speaker name + timestamp + duration per transmission
       - Last 20 transmissions per channel
       - Session only (in-memory)

       ```kotlin
       @OptIn(ExperimentalMaterial3Api::class)
       @Composable
       fun TransmissionHistorySheet(
           channelName: String,
           history: List<TransmissionHistoryEntry>,
           onDismiss: () -> Unit
       )
       ```

       Implementation:
       - ModalBottomSheet with rememberModalBottomSheetState().
       - Content:
         - Title row: Text("$channelName - History", titleMedium), padding 16.dp top and horizontal
         - If history is empty: Text("No transmissions yet", bodyMedium, center, 32.dp padding)
         - LazyColumn with items(history):
           - ListItem per entry:
             - headlineContent: Text(entry.speakerName)
             - supportingContent: formatted timestamp + duration string
               Format timestamp: use SimpleDateFormat("HH:mm:ss") or java.time.Instant.ofEpochMilli
               Display: "12:34:56 - 5s" (time + duration)
             - leadingContent: Small circle icon (primary for own transmission, onSurfaceVariant for others)
         - Bottom padding (32.dp) for navigation bar insets.

    3. Wire into ChannelListViewModel.kt:
       - Inject TransmissionHistoryRepository into constructor.
       - Inject NetworkMonitor into constructor (for networkType).
       - Add latency StateFlow: `val latency: StateFlow<Long?> = signalingClient.latency`
       - Add networkType StateFlow: `val networkType: StateFlow<NetworkType> = networkMonitor.networkType`
       - Add serverUrl property: `val serverUrl: String = BuildConfig.SERVER_URL`
       - Add _selectedHistoryChannelId MutableStateFlow<String?>(null) for tracking which channel's history is open.
       - Add selectedHistoryChannelId StateFlow.
       - Add transmissionHistory StateFlow: Combine _selectedHistoryChannelId with repository observation.
         When selectedHistoryChannelId is non-null, collect transmissionHistoryRepository.observeHistory(channelId).
         When null, emit empty list.
       - Add showTransmissionHistory(channelId: String) method: sets _selectedHistoryChannelId.
       - Add hideTransmissionHistory() method: sets _selectedHistoryChannelId to null.
       - Add manualRetry() method that delegates to signalingClient.manualRetry().
       - Start NetworkMonitor in init block: networkMonitor.start()

    4. Wire into ChannelListScreen.kt:
       - Add NetworkQualityIndicator in TopAppBar actions, between connection dot and profile icon:
         Collect latency, networkType from viewModel.
         Pass serverUrl from viewModel.
       - Add TransmissionHistorySheet:
         Observe selectedHistoryChannelId and transmissionHistory.
         When selectedHistoryChannelId is non-null, show TransmissionHistorySheet with channel name (look up from channels list) and history entries.
         On dismiss, call viewModel.hideTransmissionHistory().
       - Pass onRetry = { viewModel.manualRetry() } to ConnectionBanner.
       - Pass connectionState to BottomBar.

    5. Wire long-press into ChannelRow.kt:
       - Add `onLongPress: () -> Unit` callback parameter to ChannelRow.
       - Use Modifier.combinedClickable(onClick = ..., onLongClick = onLongPress) instead of just clickable.
       - Import androidx.compose.foundation.combinedClickable and ExperimentalFoundationApi.
       - In ChannelListScreen, pass onLongPress = { viewModel.showTransmissionHistory(channel.id) } to each ChannelRow.
  </action>
  <verify>
    cd android && ./gradlew compileDebugKotlin 2>&1 | tail -5
    Verify: NetworkQualityIndicator shows signal bars based on latency
    Verify: TransmissionHistorySheet displays entries with speaker name, time, duration
    Verify: ChannelRow has onLongPress callback
    Verify: ChannelListScreen wires NetworkQualityIndicator in TopAppBar
    Verify: ChannelListViewModel exposes latency, networkType, transmissionHistory
  </verify>
  <done>
    NetworkQualityIndicator displays real-time signal bars in top bar with tap-to-reveal quality popup showing latency, connection type, and server. TransmissionHistorySheet opens via long-press on channel row showing last 20 transmissions with speaker name, timestamp, and duration. All wired through ViewModel to ChannelListScreen.
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew compileDebugKotlin` compiles without errors
2. NetworkQuality enum maps latency thresholds to 4/3/2/1 bars
3. TransmissionHistoryRepository stores last 20 entries per channel in memory
4. NetworkQualityIndicator shows signal bars icon with tappable popup
5. TransmissionHistorySheet shows in ModalBottomSheet with LazyColumn
6. ChannelRow responds to long-press to open transmission history
7. ChannelListScreen has NetworkQualityIndicator in TopAppBar actions
8. ViewModel exposes latency, networkType, and transmissionHistory states
</verification>

<success_criteria>
Network quality indicator visible in top bar with real-time latency-based signal bars and detail popup. Transmission history accessible via long-press on any channel row, showing last 20 transmissions per channel in bottom sheet format.
</success_criteria>

<output>
After completion, create `.planning/phases/10-network-resilience-ux-polish/10-04-SUMMARY.md`
</output>
