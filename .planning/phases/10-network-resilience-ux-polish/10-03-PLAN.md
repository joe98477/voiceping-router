---
phase: 10-network-resilience-ux-polish
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt
  - android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt
  - android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt
  - android/app/src/main/java/com/voiceping/android/service/ChannelMonitoringService.kt
  - android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
autonomous: true

must_haves:
  truths:
    - "Reconnecting banner slides down from top bar showing 'Reconnecting...' during long disconnections (5+s)"
    - "Connection lost banner shows with Retry button after 5-minute timeout"
    - "Connection dot color changes to amber during RECONNECTING, red during FAILED"
    - "Subtle up tone plays on successful reconnection, down tone on disconnection"
    - "Connection tones respect existing tone toggle setting"
    - "Haptic feedback fires for incoming transmission start (light pulse) and channel busy (double tap)"
    - "Bottom bar shows offline badge when disconnected"
    - "Foreground notification shows 'Reconnecting...' subtitle during reconnection"
    - "PTT button stays interactive during reconnection, shows error on press while disconnected"
  artifacts:
    - path: "android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt"
      provides: "Enhanced banner with RECONNECTING and FAILED states, Retry button"
      contains: "Reconnecting"
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt"
      provides: "Connection/disconnection tones (DTMF 9 and DTMF 7)"
      contains: "playConnectionTone"
    - path: "android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt"
      provides: "Transmission start and busy vibration patterns"
      contains: "vibrateTransmissionStart"
  key_links:
    - from: "ConnectionBanner"
      to: "ConnectionState.RECONNECTING"
      via: "UI observes connectionState for banner visibility"
      pattern: "ConnectionState\\.RECONNECTING"
    - from: "ChannelRepository"
      to: "TonePlayer"
      via: "Connection state observer plays connection/disconnection tones"
      pattern: "playConnectionTone|playDisconnectionTone"
---

<objective>
Reconnection UI feedback, connection tones, and haptic feedback completion. ConnectionBanner enhanced for RECONNECTING/FAILED states with Retry button. Connection/disconnection tones added to TonePlayer. Transmission start and busy haptic patterns added to HapticFeedback. Notification and BottomBar updated for offline state.

Purpose: NET-04 (reconnecting indicator), UX-01 (haptic feedback), and locked decisions on connection tones, PTT during reconnection, and offline state display.

Output: Enhanced ConnectionBanner, TonePlayer with connection tones, HapticFeedback with transmission patterns, BottomBar offline badge, notification reconnecting subtitle.
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-network-resilience-ux-polish/10-CONTEXT.md
@.planning/phases/10-network-resilience-ux-polish/10-RESEARCH.md
@.planning/phases/10-network-resilience-ux-polish/10-01-SUMMARY.md
@android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt
@android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt
@android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt
@android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
@android/app/src/main/java/com/voiceping/android/service/ChannelMonitoringService.kt
@android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ConnectionBanner, BottomBar, and notification for reconnection states</name>
  <files>
    android/app/src/main/java/com/voiceping/android/presentation/shell/ConnectionBanner.kt
    android/app/src/main/java/com/voiceping/android/presentation/channels/components/BottomBar.kt
    android/app/src/main/java/com/voiceping/android/service/ChannelMonitoringService.kt
  </files>
  <action>
    1. Enhance ConnectionBanner.kt to handle RECONNECTING and FAILED states:
       Per locked decisions:
       - Long disconnection (5+s): "Reconnecting..." banner slides down from top bar
       - Max retry timeout: "Connection lost" with Retry button
       - Banner text: Just "Reconnecting..." no attempt count or elapsed time

       Update the ConnectionBanner composable:
       - Accept additional `onRetry: () -> Unit` callback parameter.
       - Show banner when connectionState is RECONNECTING or FAILED.
       - RECONNECTING state: amber/warning background (secondaryContainer), text "Reconnecting..."
       - FAILED state: red/error background (errorContainer), text "Connection lost" with TextButton "Retry" at right side.
       - Use AnimatedVisibility with slideInVertically(initialOffset = { -it }) for slide-down animation.
       - Keep existing CONNECTING state behavior.
       - Use Row layout: Text on left, Retry button on right (only for FAILED).
       - Add appropriate padding (horizontal = 16.dp, vertical = 8.dp).

    2. Enhance BottomBar.kt to show offline badge:
       Per locked decision: "Bottom bar shows primary channel name with offline badge"
       - Accept `connectionState: ConnectionState` parameter.
       - When connectionState is RECONNECTING or FAILED or DISCONNECTED (and channels exist), show small badge text "(Offline)" next to channel name in secondary color (onSurfaceVariant or errorContainer color).
       - PTT button remains interactive (per locked decision: do NOT gray out or disable PTT).

    3. Enhance ChannelMonitoringService.kt notification for reconnection:
       Per locked decision: "Foreground notification keeps channel name, adds 'Reconnecting...' as subtitle"
       - Add EXTRA_IS_RECONNECTING = "extra_is_reconnecting" constant.
       - In ACTION_UPDATE_CHANNEL handler, read boolean extra for reconnecting state.
       - When reconnecting, set notification content text to "Reconnecting..." instead of "Monitoring".
       - When not reconnecting, keep existing "Monitoring" text.
       - Add updateReconnectionState(isReconnecting: Boolean) intent helper or use existing ACTION_UPDATE_CHANNEL with the new boolean extra.
  </action>
  <verify>
    cd android && ./gradlew compileDebugKotlin 2>&1 | tail -5
    Verify: ConnectionBanner shows "Reconnecting..." for RECONNECTING, "Connection lost" + Retry for FAILED
    Verify: BottomBar accepts connectionState and shows offline badge
    Verify: ChannelMonitoringService supports EXTRA_IS_RECONNECTING in notification
  </verify>
  <done>
    ConnectionBanner shows "Reconnecting..." banner during reconnection and "Connection lost" with Retry button on failure. BottomBar shows offline badge when disconnected. Notification shows "Reconnecting..." subtitle during reconnection attempts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add connection tones and complete haptic feedback patterns</name>
  <files>
    android/app/src/main/java/com/voiceping/android/data/audio/TonePlayer.kt
    android/app/src/main/java/com/voiceping/android/data/audio/HapticFeedback.kt
    android/app/src/main/java/com/voiceping/android/data/repository/ChannelRepository.kt
  </files>
  <action>
    1. Add connection/disconnection tones to TonePlayer.kt:
       Per locked decisions:
       - Subtle up tone when connecting/reconnecting successfully
       - Down tone on disconnection
       - Respect existing tone toggle setting (silent if tones disabled)

       Add playConnectionTone() method:
       ```kotlin
       /**
        * Play connection established tone - subtle up chirp.
        * Tone: DTMF 9 (1477 Hz + 852 Hz) for 120ms
        * Configurable: Yes (respects PTT start tone toggle setting)
        */
       fun playConnectionTone() {
           try {
               if (settingsRepository.getCachedPttStartToneEnabled()) {
                   toneGenerator?.startTone(ToneGenerator.TONE_DTMF_9, 120)
                   Log.d(TAG, "Playing connection tone")
               }
           } catch (e: Exception) {
               Log.e(TAG, "Error playing connection tone", e)
           }
       }
       ```

       Add playDisconnectionTone() method:
       ```kotlin
       /**
        * Play disconnection tone - subtle down chirp.
        * Tone: DTMF 7 (1209 Hz + 852 Hz) for 150ms
        * Configurable: Yes (respects PTT start tone toggle setting)
        */
       fun playDisconnectionTone() {
           try {
               if (settingsRepository.getCachedPttStartToneEnabled()) {
                   toneGenerator?.startTone(ToneGenerator.TONE_DTMF_7, 150)
                   Log.d(TAG, "Playing disconnection tone")
               }
           } catch (e: Exception) {
               Log.e(TAG, "Error playing disconnection tone", e)
           }
       }
       ```

    2. Add transmission event haptic patterns to HapticFeedback.kt:
       Per locked decisions: "User feels haptic feedback for PTT press, release, busy, and transmission events"

       Existing patterns: vibratePttPress() (50ms firm click), vibrateError() (buzz-pause-buzz), vibrateRelease() (30ms subtle pulse).

       Add vibrateTransmissionStart() method:
       ```kotlin
       /**
        * Vibrate when incoming transmission starts - light pulse.
        * Pattern: Single pulse, 40ms duration, half amplitude
        * Purpose: Subtle tactile feedback someone started speaking
        */
       fun vibrateTransmissionStart() {
           try {
               if (vibrator?.hasVibrator() == true) {
                   val effect = VibrationEffect.createOneShot(40, VibrationEffect.DEFAULT_AMPLITUDE / 2)
                   vibrator.vibrate(effect)
                   Log.d(TAG, "Transmission start vibration triggered")
               }
           } catch (e: Exception) {
               Log.e(TAG, "Error vibrating on transmission start", e)
           }
       }
       ```

       Add vibrateBusy() method:
       ```kotlin
       /**
        * Vibrate when channel becomes busy - double tap pattern.
        * Pattern: Tap (30ms), pause (40ms), tap (30ms)
        * Purpose: Distinct "channel busy" feedback when user tries to PTT on occupied channel
        */
       fun vibrateBusy() {
           try {
               if (vibrator?.hasVibrator() == true) {
                   val timings = longArrayOf(0, 30, 40, 30)
                   val amplitudes = intArrayOf(0, 128, 0, 128)
                   val effect = VibrationEffect.createWaveform(timings, amplitudes, -1)
                   vibrator.vibrate(effect)
                   Log.d(TAG, "Channel busy vibration triggered")
               }
           } catch (e: Exception) {
               Log.e(TAG, "Error vibrating on busy channel", e)
           }
       }
       ```

    3. Wire connection tones and notification update in ChannelRepository.kt:
       Add connection state observation to ChannelRepository init block (or where appropriate):

       - Observe signalingClient.connectionState transitions:
         - When transitioning TO ConnectionState.CONNECTED from RECONNECTING or CONNECTING:
           Play tonePlayer.playConnectionTone()
         - When transitioning FROM CONNECTED to RECONNECTING or DISCONNECTED:
           Play tonePlayer.playDisconnectionTone()
         - Track previous state with a variable to detect transitions.

       - Add notification reconnecting state update:
         - When connectionState changes to RECONNECTING, send intent to ChannelMonitoringService with EXTRA_IS_RECONNECTING = true
         - When connectionState changes back to CONNECTED, send intent with EXTRA_IS_RECONNECTING = false

       - Wire vibrateTransmissionStart() into the existing speaker change observer:
         - When a new speaker starts on a monitored channel (currentSpeaker changes from null to non-null),
           call hapticFeedback.vibrateTransmissionStart() (only for incoming transmissions, not user's own).
         - This should be in the existing observeSpeakerChangesForChannel() method.

       **Important:** Ensure HapticFeedback and TonePlayer are already injected in ChannelRepository. Check constructor. If not present, add them.
  </action>
  <verify>
    cd android && ./gradlew compileDebugKotlin 2>&1 | tail -5
    Verify: TonePlayer has playConnectionTone() and playDisconnectionTone()
    Verify: HapticFeedback has vibrateTransmissionStart() and vibrateBusy()
    Verify: ChannelRepository observes connectionState and plays connection/disconnection tones
    Verify: ChannelRepository notifies ChannelMonitoringService of reconnecting state
  </verify>
  <done>
    Connection tones play on connect (DTMF 9) and disconnect (DTMF 7), respecting tone toggle. Haptic feedback complete: press, release, error, transmission start (40ms light), busy (double tap). ChannelRepository wires connection state changes to tones, haptics, and notification updates.
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew compileDebugKotlin` compiles without errors
2. ConnectionBanner shows "Reconnecting..." for RECONNECTING state with amber background
3. ConnectionBanner shows "Connection lost" with Retry button for FAILED state
4. BottomBar shows "(Offline)" badge when disconnected
5. TonePlayer has playConnectionTone() and playDisconnectionTone() methods
6. HapticFeedback has vibrateTransmissionStart() and vibrateBusy() methods
7. ChannelRepository observes connectionState and triggers tones on transitions
8. Notification shows "Reconnecting..." during reconnection attempts
</verification>

<success_criteria>
Reconnection UI fully functional: banner, connection dot color, notification subtitle all reflect reconnection state. Connection tones and haptic patterns complete for all transmission events. PTT stays interactive during reconnection with error feedback on press.
</success_criteria>

<output>
After completion, create `.planning/phases/10-network-resilience-ux-polish/10-03-SUMMARY.md`
</output>
