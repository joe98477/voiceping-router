---
phase: 04-dispatch-multi-channel-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/config.ts
  - src/server/signaling/handlers.ts
  - web-ui/src/components/DispatchChannelCard.jsx
  - web-ui/src/styles.css
autonomous: true

must_haves:
  truths:
    - "DISPATCH role users can join up to 50 channels simultaneously"
    - "ADMIN role users can join up to 50 channels simultaneously"
    - "General users remain limited to 10 simultaneous channels"
    - "Compact channel card shows channel name, status pill, mute toggle, PTT button, and speaker name"
    - "Muted cards appear dimmed but still show activity indicators"
    - "Active channels show pulsing dot and card border glow"
  artifacts:
    - path: "src/server/config.ts"
      provides: "dispatchSimultaneousChannelLimit config"
      contains: "dispatchSimultaneousChannelLimit"
    - path: "src/server/signaling/handlers.ts"
      provides: "Role-aware channel limit check"
      contains: "DISPATCH"
    - path: "web-ui/src/components/DispatchChannelCard.jsx"
      provides: "Compact dispatch channel card with mute toggle and activity indicator"
      min_lines: 80
    - path: "web-ui/src/styles.css"
      provides: "Dispatch card styles, mute dimming, pulsing dot, border glow"
      contains: "dispatch-card--compact"
  key_links:
    - from: "src/server/signaling/handlers.ts"
      to: "src/server/config.ts"
      via: "config.channels.dispatchSimultaneousChannelLimit"
      pattern: "dispatchSimultaneousChannelLimit"
    - from: "web-ui/src/components/DispatchChannelCard.jsx"
      to: "web-ui/src/hooks/useChannelConnection.js"
      via: "useChannelConnection hook"
      pattern: "useChannelConnection"
---

<objective>
Server-side dispatch channel limit bypass and compact DispatchChannelCard component with mute toggle, activity indicators, and PTT button.

Purpose: Enable DISPATCH/ADMIN roles to join 50 channels and provide the compact card UI building block for the monitoring grid.
Output: Modified server config/handlers + new DispatchChannelCard component + CSS for compact card, mute dimming, activity pulse, and border glow.
</objective>

<execution_context>
@C:\Users\jotha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jotha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dispatch-multi-channel-monitoring/04-CONTEXT.md
@.planning/phases/04-dispatch-multi-channel-monitoring/04-RESEARCH.md
@src/server/config.ts
@src/server/signaling/handlers.ts
@web-ui/src/components/ChannelCard.jsx
@web-ui/src/hooks/useChannelConnection.js
@web-ui/src/context/ChannelContext.jsx
@web-ui/src/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side dispatch channel limit bypass</name>
  <files>src/server/config.ts, src/server/signaling/handlers.ts</files>
  <action>
1. In `src/server/config.ts`, add `dispatchSimultaneousChannelLimit: 50` to the `channels` config section alongside the existing `defaultSimultaneousChannelLimit: 10`.

2. In `src/server/signaling/handlers.ts`, modify the `handleJoinChannel` method's simultaneous channel limit check (around line 142). Currently it bypasses only for `isAdmin`. Change the logic to:
   - Check if user role is DISPATCH or ADMIN (import UserRole if not already imported — it IS already imported)
   - For DISPATCH and ADMIN roles: use `config.channels.dispatchSimultaneousChannelLimit` (50)
   - For other roles: use `config.channels.defaultSimultaneousChannelLimit` (10)
   - The existing `isAdmin` bypass for permission checks should remain unchanged — only the channel LIMIT check changes

The specific code change in handleJoinChannel:
```typescript
// Replace the existing limit check block:
// Old: if (!isAdmin && ctx.channels.size >= config.channels.defaultSimultaneousChannelLimit)
// New:
const isDispatchOrAdmin = ctx.role === UserRole.DISPATCH || ctx.role === UserRole.ADMIN;
const channelLimit = isDispatchOrAdmin
  ? config.channels.dispatchSimultaneousChannelLimit
  : config.channels.defaultSimultaneousChannelLimit;

if (ctx.channels.size >= channelLimit) {
  // ... existing denial logic, but use channelLimit in error message and metadata
}
```

Note: The `isAdmin` variable used for permission bypass (line 119) should remain unchanged. Only the simultaneous channel limit logic changes.
  </action>
  <verify>Run `npx tsc --noEmit` from project root to confirm no TypeScript errors. Grep for `dispatchSimultaneousChannelLimit` in both files to confirm presence.</verify>
  <done>config.ts has dispatchSimultaneousChannelLimit: 50. handlers.ts uses role-aware limit: DISPATCH/ADMIN get 50, others get 10. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Compact DispatchChannelCard component with mute toggle, activity indicators, and PTT</name>
  <files>web-ui/src/components/DispatchChannelCard.jsx, web-ui/src/styles.css</files>
  <action>
Create a NEW component `web-ui/src/components/DispatchChannelCard.jsx` — a compact card designed for the dispatch monitoring grid. Do NOT modify the existing ChannelCard.jsx (general users still use it). The DispatchChannelCard is a separate, purpose-built component.

**Props:**
- `channel` — { id, name } object
- `wsUrl` — WebSocket URL string
- `token` — JWT token string
- `isMuted` — boolean, whether this channel's incoming audio is muted
- `onToggleMute` — function, called when mute toggle is clicked

**Component structure:**
1. Uses `useChannelConnection(channel.id, wsUrl, token)` for connection management (same pattern as ChannelCard)
2. Uses `useChannels()` from ChannelContext to read `channelStates[channel.id]`
3. Implements PTT hold-to-talk via mouse and touch event handlers (same pattern as ChannelCard)

**Layout (compact card — all elements visible, no hover reveals):**
```
+-----------------------------------------------+
| [Channel Name]     [status pill]  [mute btn]  |
| [pulsing dot] [Speaker Name]   (when active)  |
| [====== PTT Button (small, full width) ======] |
+-----------------------------------------------+
```

- Channel name: truncated with ellipsis if too long
- Status pill: connection state (connected/connecting/reconnecting/error/disconnected)
- Mute toggle button: small icon button, shows volume-high or volume-off icon (use simple unicode or text: "M" for muted, speaker icon for unmuted). Style differently when muted vs unmuted.
- Activity row: Only shown when `channelState.isBusy === true`. Shows a pulsing dot (CSS animation) and speaker name.
- PTT button: small, full-width button at bottom. Same hold-to-talk behavior as ChannelCard. Shows "PTT" when idle, "TX..." when transmitting, "Busy" when channel busy.
- PTT button is always visible (per LOCKED decision).
- PTT works even when channel is muted (per LOCKED decision — mute only affects incoming audio).

**Muting implementation:**
When `isMuted` prop is true, set `consumer.track.enabled = false` on all consumers from the ConnectionManager. When false, set `consumer.track.enabled = true`. Use a useEffect that watches `isMuted` and `connectionManager`:
```javascript
useEffect(() => {
  if (!connectionManager) return;
  const transportClient = connectionManager.getTransportClient();
  if (!transportClient) return;
  const consumers = transportClient.getAllConsumers();
  consumers.forEach(consumer => {
    if (consumer.track) {
      consumer.track.enabled = !isMuted;
    }
  });
}, [connectionManager, isMuted]);
```
Note: Using `consumer.track.enabled = false` silences audio instantly while keeping connection alive (per RESEARCH.md recommendation). This is preferable to HTMLAudioElement.muted because it works at the WebRTC transport level.

**Card styling when muted:**
Apply CSS class `dispatch-card--muted` which sets `opacity: 0.6` on the card. Activity indicators (pulsing dot + speaker name) remain visible even when muted (per LOCKED decision).

**Card styling when active (channel busy):**
Apply CSS class `dispatch-card--active` which adds a colored border glow. The pulsing dot uses a CSS animation. Both are visible even when muted.

**CSS additions to web-ui/src/styles.css:**

Add these styles at the end of the file (after the existing Phase 3 channel card styles):

```css
/* Dispatch Monitoring - Compact Channel Card */
.dispatch-card--compact {
  background: var(--surface);
  border-radius: 12px;
  padding: 10px 12px;
  border: 2px solid transparent;
  display: grid;
  gap: 6px;
  transition: border-color 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
  min-width: 0;
}

.dispatch-card--compact.dispatch-card--muted {
  opacity: 0.6;
}

.dispatch-card--compact.dispatch-card--active {
  border-color: #4caf50;
  box-shadow: 0 0 12px rgba(76, 175, 80, 0.35);
}

.dispatch-card--compact.dispatch-card--muted.dispatch-card--active {
  border-color: rgba(76, 175, 80, 0.5);
  box-shadow: 0 0 8px rgba(76, 175, 80, 0.2);
}

.dispatch-card__top-row {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
}

.dispatch-card__name {
  font-weight: 600;
  font-size: 0.85rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
  min-width: 0;
}

.dispatch-card__status {
  flex-shrink: 0;
  font-size: 0.65rem;
  padding: 2px 8px;
}

.dispatch-card__mute-btn {
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: white;
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: 0.75rem;
  transition: background 0.2s ease, color 0.2s ease;
}

.dispatch-card__mute-btn--muted {
  background: #f7c2b6;
  border-color: #f2b6ae;
  color: #7f2c20;
}

.dispatch-card__mute-btn--unmuted {
  background: #d5f1d3;
  border-color: #b6e2b2;
  color: #21612a;
}

.dispatch-card__activity {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  min-height: 20px;
}

.dispatch-card__pulse {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4caf50;
  animation: dispatch-pulse 1.2s ease-in-out infinite;
  flex-shrink: 0;
}

@keyframes dispatch-pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.85); }
}

.dispatch-card__speaker-name {
  font-weight: 600;
  color: var(--ink);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.dispatch-card__ptt {
  margin-top: 2px;
}

.dispatch-card__ptt-btn {
  width: 100%;
  padding: 6px 12px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 0.75rem;
  letter-spacing: 0.06em;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
  transition: background 0.15s ease;
}

.dispatch-card__ptt-btn--idle {
  background: linear-gradient(135deg, #6cd3ff 0%, #2a7dd2 100%);
  color: #071427;
}

.dispatch-card__ptt-btn--transmitting {
  background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

.dispatch-card__ptt-btn--busy {
  background: #f7c2b6;
  color: #7f2c20;
  cursor: not-allowed;
}

.dispatch-card__ptt-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.dispatch-card__error {
  color: var(--accent);
  font-size: 0.7rem;
  text-align: center;
}
```
  </action>
  <verify>Run `npx vite build` from web-ui/ directory to confirm the component compiles. Check that DispatchChannelCard.jsx exports a default component. Grep web-ui/src/styles.css for "dispatch-card--compact" and "dispatch-pulse" to confirm CSS was added.</verify>
  <done>DispatchChannelCard.jsx exists with mute toggle, activity pulse, compact PTT, and hold-to-talk. CSS includes dispatch-card--compact, dispatch-card--muted (opacity 0.6), dispatch-card--active (border glow), dispatch-pulse animation, and all compact card styling. Component builds without errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes from project root (server-side changes)
2. `npx vite build` passes from web-ui/ (client-side changes)
3. `src/server/config.ts` contains `dispatchSimultaneousChannelLimit: 50`
4. `src/server/signaling/handlers.ts` checks role for DISPATCH/ADMIN before applying channel limit
5. `web-ui/src/components/DispatchChannelCard.jsx` exists and exports a React component
6. `web-ui/src/styles.css` contains dispatch-card--compact, dispatch-card--muted, dispatch-card--active, dispatch-pulse
</verification>

<success_criteria>
- DISPATCH and ADMIN users can join 50 channels (server limit raised)
- General users remain limited to 10 channels
- DispatchChannelCard renders compact card with channel name, status, mute toggle, activity indicator, and PTT button
- Muted cards are dimmed (opacity 0.6) but still show activity indicators
- Active cards have green border glow and pulsing dot
- PTT works on muted channels (mute only affects incoming audio)
</success_criteria>

<output>
After completion, create `.planning/phases/04-dispatch-multi-channel-monitoring/04-01-SUMMARY.md`
</output>
