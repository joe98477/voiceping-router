---
phase: 04-dispatch-multi-channel-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/config.ts
  - src/server/signaling/handlers.ts
  - web-ui/src/components/ChannelCard.jsx
  - web-ui/src/styles.css
autonomous: true

must_haves:
  truths:
    - "DISPATCH users can join more than 10 channels simultaneously (up to 50)"
    - "ChannelCard renders a compact variant with mute toggle and activity indicator"
    - "Active channels show pulsing visual indicator with speaker name"
  artifacts:
    - path: "src/server/config.ts"
      provides: "dispatchSimultaneousChannelLimit config (50)"
      contains: "dispatchSimultaneousChannelLimit"
    - path: "src/server/signaling/handlers.ts"
      provides: "DISPATCH role bypass for channel limit"
      contains: "DISPATCH"
    - path: "web-ui/src/components/ChannelCard.jsx"
      provides: "Compact variant with mute toggle and activity indicator"
      contains: "compact"
    - path: "web-ui/src/styles.css"
      provides: "Compact card CSS, activity pulse animation"
      contains: "channel-card--compact"
  key_links:
    - from: "src/server/signaling/handlers.ts"
      to: "src/server/config.ts"
      via: "config.channels.dispatchSimultaneousChannelLimit"
      pattern: "dispatchSimultaneousChannelLimit"
    - from: "web-ui/src/components/ChannelCard.jsx"
      to: "web-ui/src/styles.css"
      via: "className channel-card--compact"
      pattern: "channel-card--compact"
---

<objective>
Server-side dispatch channel limit bypass and compact ChannelCard variant with mute toggle and activity indicator.

Purpose: Enable DISPATCH users to join up to 50 channels (bypassing the default 10-channel limit) and provide a compact card UI suitable for grid-based multi-channel monitoring with per-channel mute controls and visual activity indicators.

Output: Modified server config and handler for dispatch limit, extended ChannelCard component with compact variant, CSS for compact cards and activity indicators.
</objective>

<execution_context>
@C:\Users\jotha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jotha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dispatch-multi-channel-monitoring/04-RESEARCH.md
@src/server/config.ts
@src/server/signaling/handlers.ts
@web-ui/src/components/ChannelCard.jsx
@web-ui/src/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side dispatch channel limit bypass</name>
  <files>src/server/config.ts, src/server/signaling/handlers.ts</files>
  <action>
1. In `src/server/config.ts`, add `dispatchSimultaneousChannelLimit` to the `channels` config section:
   ```typescript
   channels: {
     defaultMaxUsersPerChannel: 100,
     defaultSimultaneousChannelLimit: 10,
     dispatchSimultaneousChannelLimit: 50,  // NEW: Higher limit for DISPATCH role
   },
   ```

2. In `src/server/signaling/handlers.ts`, modify the simultaneous channel limit enforcement (around line 141-162). Currently the code is:
   ```typescript
   // Enforce simultaneous channel limit (not applicable to Admin)
   if (!isAdmin && ctx.channels.size >= config.channels.defaultSimultaneousChannelLimit) {
   ```

   Change it to also check for DISPATCH role and use the higher dispatch limit:
   ```typescript
   // Enforce simultaneous channel limit (Admin bypasses entirely, DISPATCH gets higher limit)
   const isDispatch = ctx.role === UserRole.DISPATCH;
   const channelLimit = isDispatch
     ? config.channels.dispatchSimultaneousChannelLimit
     : config.channels.defaultSimultaneousChannelLimit;

   if (!isAdmin && ctx.channels.size >= channelLimit) {
   ```

   Also update the error message on the `sendError` line (around line 160) to use the dynamic `channelLimit` variable:
   ```typescript
   this.sendError(ctx, message.id, `Cannot join more than ${channelLimit} channels simultaneously`);
   ```

   And update the audit log metadata (around line 156) to use the dynamic limit:
   ```typescript
   limit: channelLimit,
   ```

   Make sure UserRole is imported at the top of handlers.ts. Check if it already is -- it should be since it's used elsewhere. If not, add: `import { UserRole } from '../../shared/types';`
  </action>
  <verify>
Run `npx tsc --noEmit` from project root to confirm TypeScript compilation succeeds with no errors.
Grep for `dispatchSimultaneousChannelLimit` in config.ts and handlers.ts to confirm both files updated.
  </verify>
  <done>
config.ts has `dispatchSimultaneousChannelLimit: 50` in channels section.
handlers.ts checks `ctx.role === UserRole.DISPATCH` and uses the higher limit (50) for DISPATCH users.
ADMIN still bypasses entirely. GENERAL users still limited to 10.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: ChannelCard compact variant with mute toggle and activity indicator</name>
  <files>web-ui/src/components/ChannelCard.jsx, web-ui/src/styles.css</files>
  <action>
1. Extend `web-ui/src/components/ChannelCard.jsx` to accept new props:
   - `variant` (string, optional): 'default' | 'compact'. Defaults to 'default'.
   - `isMuted` (boolean, optional): Whether this channel's audio output is muted. Defaults to false.
   - `onToggleMute` (function, optional): Callback when mute button is clicked.

   When `variant === 'compact'`, render a smaller card layout optimized for grid view:
   - Shorter card with condensed layout (no separate speaker section -- inline it)
   - Mute toggle button in the header row (next to channel name and status pill)
   - Activity indicator: When `channelState.isBusy`, show a pulsing dot and speaker name inline
   - Smaller PTT button with just "PTT" text (not "Push to Talk")
   - Keep ALL existing PTT logic (press/release handlers, optimistic UI) unchanged

   The compact variant rendering:
   ```jsx
   if (variant === 'compact') {
     return (
       <div className={`channel-card channel-card--compact ${channelState.isBusy ? 'channel-card--active' : ''}`}>
         <div className="channel-card__header">
           <h3 className="channel-card__name">{channel.name}</h3>
           <div className="channel-card__controls">
             {onToggleMute && (
               <button
                 className={`channel-card__mute-btn ${isMuted ? 'channel-card__mute-btn--muted' : ''}`}
                 onClick={onToggleMute}
                 aria-label={isMuted ? 'Unmute channel' : 'Mute channel'}
                 title={isMuted ? 'Unmute' : 'Mute'}
               >
                 {isMuted ? '\u{1F507}' : '\u{1F50A}'}
               </button>
             )}
             <span className={`channel-card__status pill pill--${getStatusClass()}`}>
               {connectionState}
             </span>
           </div>
         </div>

         {channelState.isBusy && (
           <div className="channel-card__activity">
             <span className="channel-card__activity-dot" />
             <span className="channel-card__activity-speaker">
               {channelState.speakerName || 'Unknown'}
             </span>
           </div>
         )}

         <div className="channel-card__ptt">
           <button
             className={getPttButtonClass()}
             disabled={isPttDisabled}
             onMouseDown={handleMouseDown}
             onMouseUp={handleMouseUp}
             onMouseLeave={handleMouseLeave}
             onTouchStart={handleTouchStart}
             onTouchEnd={handleTouchEnd}
             onTouchCancel={handleTouchEnd}
           >
             {isPressed ? 'TX' : channelState.isBusy && !isPressed ? 'Busy' : 'PTT'}
           </button>
         </div>

         {(error || pttError) && (
           <div className="channel-card__error">{pttError || error}</div>
         )}
       </div>
     );
   }
   ```

   IMPORTANT: Keep the default variant completely unchanged. The compact variant is additional rendering, not a replacement. Add the `variant = 'default'` default in the destructured props.

   Also, when `isMuted` prop is true, the ChannelCard needs to mute its audio output. In the useChannelConnection hook's ConnectionManager, audio is played via the TransportClient's consumer tracks. The simplest approach: add a `useEffect` that finds the audio element created by ConnectionManager and sets its `muted` property. However, ConnectionManager creates the audio element internally. Instead, use a simpler approach: keep a ref and after connection is established, access `connectionManager.getTransportClient()` to get consumers, and set track.enabled = false when muted. Actually, per research, we should use HTMLAudioElement.muted (keeps data flowing for fast unmute). But ConnectionManager manages audio internally.

   Simpler approach for MVP: Create a new `useEffect` in ChannelCard that handles muting by querying for audio elements. Actually the best approach is: the mute state simply controls whether we set `document.querySelectorAll('audio')` -- no, this is too broad.

   Best approach for the compact variant's mute: Let muting be handled by the DispatchMonitoring page that will render these cards. In this task, ChannelCard just passes through the `isMuted` prop visually (shows muted icon, dims the card). The actual audio muting will be handled in Plan 02 via the DispatchMonitoring page's audio management. For now, ChannelCard does visual-only mute indication via CSS class `channel-card--muted` when `isMuted` is true. Audio muting will be wired in Plan 02.

   Add `channel-card--muted` class to the card div when `isMuted` is true: `${isMuted ? 'channel-card--muted' : ''}`.

2. Add CSS to `web-ui/src/styles.css` for the compact variant. Append these styles:

   ```css
   /* === Compact Channel Card (Dispatch Grid) === */
   .channel-card--compact {
     min-height: auto;
     padding: 10px 12px;
   }

   .channel-card--compact .channel-card__name {
     font-size: 0.85rem;
   }

   .channel-card--compact .channel-card__controls {
     display: flex;
     align-items: center;
     gap: 6px;
   }

   .channel-card__mute-btn {
     background: none;
     border: 1px solid var(--border);
     border-radius: var(--radius-pill);
     cursor: pointer;
     font-size: 1rem;
     padding: 2px 6px;
     line-height: 1;
     transition: background 0.15s;
   }

   .channel-card__mute-btn:hover {
     background: var(--paper);
   }

   .channel-card__mute-btn--muted {
     opacity: 0.5;
   }

   /* Activity indicator */
   .channel-card__activity {
     display: flex;
     align-items: center;
     gap: 6px;
     padding: 4px 0;
     font-size: 0.8rem;
     color: var(--accent);
   }

   .channel-card__activity-dot {
     width: 8px;
     height: 8px;
     border-radius: 50%;
     background: var(--accent);
     animation: activity-pulse 1s ease-in-out infinite;
   }

   @keyframes activity-pulse {
     0%, 100% { opacity: 1; transform: scale(1); }
     50% { opacity: 0.5; transform: scale(0.8); }
   }

   .channel-card__activity-speaker {
     font-weight: 600;
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
   }

   /* Active channel highlight */
   .channel-card--active {
     border-left: 4px solid var(--accent);
     box-shadow: 0 0 8px rgba(228, 87, 46, 0.15);
   }

   /* Muted channel dim */
   .channel-card--muted {
     opacity: 0.6;
   }

   .channel-card--muted .channel-card__activity-dot {
     animation: none;
     opacity: 0.3;
   }

   /* Compact PTT button */
   .channel-card--compact .ptt-button {
     font-size: 0.8rem;
     padding: 6px 14px;
     min-height: 36px;
   }
   ```
  </action>
  <verify>
Run `npm run build` from `web-ui/` directory to confirm the build succeeds.
Check that ChannelCard.jsx exports the component and accepts `variant`, `isMuted`, `onToggleMute` props.
Verify existing default variant is unchanged by checking the default rendering path still exists.
  </verify>
  <done>
ChannelCard accepts `variant` ('default'|'compact'), `isMuted`, and `onToggleMute` props.
Compact variant renders condensed card with mute toggle button, activity indicator (pulsing dot + speaker name), and smaller PTT button.
Default variant is completely unchanged (backward compatible with Phase 3 Channels page).
CSS includes compact card styles, activity-pulse animation, muted state dimming.
Build passes.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (server-side TypeScript)
- `npm run build` passes in web-ui (client-side)
- ChannelCard compact variant renders with mute toggle and activity indicator
- Server config has dispatchSimultaneousChannelLimit: 50
- handlers.ts uses dynamic channel limit based on user role
</verification>

<success_criteria>
1. DISPATCH users can join up to 50 channels (server enforces higher limit)
2. GENERAL users still limited to 10 channels (unchanged behavior)
3. ADMIN users still bypass limit entirely (unchanged behavior)
4. ChannelCard compact variant shows condensed layout with mute toggle, activity indicator, and small PTT button
5. Existing default ChannelCard variant is unchanged (Phase 3 compatibility)
6. Both TypeScript and web-ui builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-dispatch-multi-channel-monitoring/04-01-SUMMARY.md`
</output>
