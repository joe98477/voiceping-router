---
phase: 04-dispatch-multi-channel-monitoring
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Application builds without errors (TypeScript + Vite)"
    - "Docker deployment works and all pages load"
    - "Dispatch user can see all channels in team-grouped grid"
    - "Dispatch user can mute/unmute channels and teams"
    - "Dispatch user can PTT on any channel"
    - "Activity indicators show on active channels"
    - "General users see channel names"
  artifacts: []
  key_links: []
---

<objective>
Build verification, integration fixes, and visual verification checkpoint for Phase 4.

Purpose: Ensure all Phase 4 work compiles, deploys, and functions correctly before marking the phase complete.
Output: Verified working dispatch console with all features functional.
</objective>

<execution_context>
@C:\Users\jotha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jotha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dispatch-multi-channel-monitoring/04-CONTEXT.md
@.planning/phases/04-dispatch-multi-channel-monitoring/04-01-SUMMARY.md
@.planning/phases/04-dispatch-multi-channel-monitoring/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification and integration fixes</name>
  <files></files>
  <action>
Run comprehensive build verification and fix any issues found:

1. **TypeScript compilation check:**
   ```bash
   npx tsc --noEmit
   ```
   Fix any TypeScript errors in server-side code (src/server/).

2. **Vite build check:**
   ```bash
   cd web-ui && npx vite build
   ```
   Fix any build errors in client-side code (web-ui/).

3. **Import verification:**
   - Verify DispatchConsole.jsx imports resolve correctly (ChannelGrid, AdminDrawer, DispatchChannelCard, useAuth, ChannelContext, usePermissionUpdates, apiGet, apiPost)
   - Verify App.jsx imports DispatchConsole correctly
   - Verify ChannelGrid.jsx imports DispatchChannelCard correctly
   - Verify AdminDrawer.jsx imports SettingsTabs components correctly

4. **Integration check:**
   - Verify the route `/event/:eventId/dispatch` points to DispatchConsole (not Console)
   - Verify Events.jsx has "Dispatch Console" link text
   - Verify config.ts has `dispatchSimultaneousChannelLimit: 50`
   - Verify handlers.ts uses role-aware channel limit

5. **Docker build (if docker-compose exists):**
   ```bash
   docker compose build
   ```
   Fix any Docker build issues.

6. **Fix any issues found.** Common problems:
   - Missing imports (check every import statement resolves)
   - CSS class name mismatches between JSX and CSS
   - Props not being passed correctly between components
   - ChannelContext provider not wrapping components that use useChannels()
   - Ensure DispatchConsole wraps its content in ChannelProvider

7. **Verify mute localStorage persistence:**
   - Check that the localStorage key pattern `cv.dispatch.muted.${eventId}` is used consistently
   - Verify read and write both use JSON.stringify/parse correctly
  </action>
  <verify>Both `npx tsc --noEmit` and `cd web-ui && npx vite build` pass with zero errors. Docker build succeeds if docker-compose exists.</verify>
  <done>All TypeScript and Vite builds pass. All imports resolve. Route wiring correct. Docker builds successfully.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual and functional verification</name>
  <what-built>
    Phase 4: Dispatch Multi-Channel Monitoring

    Features implemented:
    1. DISPATCH/ADMIN users can join up to 50 channels simultaneously (server limit bypass)
    2. Dispatch Console page at /event/:eventId/dispatch with team-grouped channel grid
    3. Compact channel cards with channel name, status pill, mute toggle, PTT button, and speaker info
    4. Collapsible team sections (all start expanded) with per-team mute toggles
    5. Activity indicators: pulsing dot + speaker name + card border glow on active channels
    6. Dimmed (opacity 0.6) cards when muted, activity indicators still visible
    7. PTT works on muted channels (mute only affects incoming audio)
    8. Stats bar: total channels, muted count, active speakers, event name, user info, uptime, connection health
    9. Admin side drawer (slides from right) with control-plane tabs
    10. Brand/logo links back to Events page
    11. Events page shows "Dispatch Console" instead of "Dispatch View"
    12. Mute preferences persist via localStorage
    13. General users see channel names (not IDs) on the Channels page
  </what-built>
  <how-to-verify>
    **Prerequisites:** Start the system with `docker compose up` (or dev server).
    Ensure you have a test event with multiple teams and channels, and at least one DISPATCH or ADMIN user.

    **Test 1: Navigate to Dispatch Console**
    1. Log in as an ADMIN or DISPATCH user
    2. Go to Events page
    3. Verify the link now says "Dispatch Console" (not "Dispatch View")
    4. Click "Dispatch Console" — should load the dispatch monitoring page

    **Test 2: Verify Grid Layout**
    1. Channels should be displayed in a compact grid, grouped by team
    2. Each team should have a header with team name and a mute toggle
    3. All team sections should start expanded
    4. Click a team header to collapse/expand — channels should hide/show

    **Test 3: Verify Mute/Unmute**
    1. Click the mute button on an individual channel card — card should dim (opacity ~0.6)
    2. Click the team mute toggle — all channels in that team should mute
    3. Click the team mute toggle again — all should unmute
    4. Refresh the page — mute preferences should persist (localStorage)

    **Test 4: Verify PTT**
    1. Press and hold the PTT button on any channel card
    2. Button should show "TX..." or transmitting state
    3. Verify PTT works on a muted channel (mute only affects incoming audio)
    4. Release button — should return to idle state

    **Test 5: Verify Activity Indicators**
    1. Have another user transmit PTT on a monitored channel
    2. Verify: pulsing green dot appears, speaker name shown, card border glows green
    3. Verify indicators are visible even on muted (dimmed) cards

    **Test 6: Verify Stats Bar**
    1. Check stats bar shows: event name, user info, total channels, muted count, active speakers, uptime, connection health
    2. Mute some channels — muted count should update
    3. Have someone talk — active speakers count should update

    **Test 7: Verify Admin Drawer**
    1. Click the gear/admin icon in the header
    2. A side drawer should slide in from the right
    3. Should contain admin tabs (Event, Teams, Channels, Users, Invites, System)
    4. Click overlay or Close button — drawer should close

    **Test 8: Verify Navigation**
    1. Click the "ConnectVoice" brand text in the header — should navigate to Events page
    2. Navigate back to dispatch console

    **Test 9: Verify General User Channel Names**
    1. Log in as a GENERAL user (not DISPATCH/ADMIN)
    2. Navigate to My Channels page
    3. Verify channels show names instead of channel IDs

    **If any test fails, describe the specific failure.**
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe the specific issues found.</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Vite builds without errors
- Docker deployment works
- Dispatch Console functional with all Phase 4 features
- Human verification confirms visual and functional correctness
</verification>

<success_criteria>
- All builds pass
- Human verifies: dispatch console loads, channels grouped by team, mute works, PTT works, activity indicators visible, stats bar updates, admin drawer works, navigation correct, channel names shown for general users
- Phase 4 success criteria from ROADMAP met:
  1. Dispatch user can subscribe to and monitor 10-50 channels simultaneously
  2. Dispatch user can selectively mute or unmute individual channels
  3. Dispatch user can transmit on any monitored channel using PTT
  4. Dispatch user sees visual indicators showing which channels have active speakers
  5. Dispatch user hears audio from all unmuted channels without audio mixing artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/04-dispatch-multi-channel-monitoring/04-03-SUMMARY.md`
</output>
