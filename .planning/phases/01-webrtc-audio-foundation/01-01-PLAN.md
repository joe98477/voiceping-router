---
phase: 01-webrtc-audio-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - .nvmrc
  - .env.example
  - src/server/index.ts
  - src/server/config.ts
  - src/shared/types.ts
  - src/shared/protocol.ts
autonomous: true

must_haves:
  truths:
    - "Node.js 20 LTS runtime is configured and all dependencies install cleanly"
    - "TypeScript 5 compiles the project without errors"
    - "mediasoup and mediasoup-client packages are installed and importable"
    - "Signaling protocol types are defined for all WebRTC negotiation messages"
  artifacts:
    - path: "package.json"
      provides: "Modern dependencies including mediasoup, mediasoup-client, ws, redis"
      contains: "mediasoup"
    - path: "tsconfig.json"
      provides: "TypeScript 5 configuration targeting ES2022"
      contains: "ES2022"
    - path: ".nvmrc"
      provides: "Node.js version pinning"
      contains: "20"
    - path: "src/shared/protocol.ts"
      provides: "Signaling message type definitions for client-server communication"
      exports: ["SignalingMessage", "SignalingType"]
    - path: "src/shared/types.ts"
      provides: "Shared type definitions for channel, user, transport"
      exports: ["ChannelState", "UserSession", "TransportOptions"]
    - path: "src/server/config.ts"
      provides: "Server configuration with mediasoup and STUN/TURN settings"
      exports: ["config"]
    - path: "src/server/index.ts"
      provides: "Server entry point placeholder"
  key_links:
    - from: "package.json"
      to: "tsconfig.json"
      via: "build script invokes tsc"
      pattern: "tsc"
    - from: "src/server/config.ts"
      to: ".env"
      via: "dotenv environment loading"
      pattern: "process\\.env"
---

<objective>
Modernize the Node.js runtime from v8.16.0 to v20 LTS, upgrade TypeScript to v5, install mediasoup/WebRTC dependencies, and scaffold the new project structure with shared type definitions and signaling protocol contract.

Purpose: mediasoup requires Node.js 18+ (C++ worker compilation). The existing Node 8 runtime, TypeScript 3.5, and outdated dependencies are incompatible with all modern WebRTC libraries. This plan creates the foundation that every subsequent plan builds upon.

Output: A compiling, modern Node.js project with mediasoup installed, shared types defined, and signaling protocol contract specified.
</objective>

<execution_context>
@C:\Users\jotha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jotha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-webrtc-audio-foundation/01-RESEARCH.md
@.planning/phases/01-webrtc-audio-foundation/01-CONTEXT.md
@.planning/codebase/STACK.md
@.planning/codebase/STRUCTURE.md
@package.json
@tsconfig.json
@.nvmrc
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Node.js, TypeScript, and dependencies</name>
  <files>
    package.json
    tsconfig.json
    .nvmrc
    .env.example
  </files>
  <action>
    1. Update `.nvmrc` to `20` (Node.js 20 LTS).

    2. Rewrite `package.json` with modern dependencies. Keep the existing metadata (name, version, description, keywords, repository, contributors, license). Update:
       - `engines`: `{ "node": ">=20.0.0" }`
       - `main`: `"./dist/server/index.js"`
       - Dependencies (REPLACE existing, not merge):
         - `mediasoup`: `^3.19.16`
         - `mediasoup-client`: `^3.18.6` (client-side, but server tests may import types)
         - `ws`: `^8.16.0`
         - `redis`: `^4.6.0` (modern async client)
         - `dotenv`: `^16.4.0`
         - `winston`: `^3.11.0`
         - `jsonwebtoken`: `^9.0.2` (replacing jwt-simple)
       - DevDependencies:
         - `typescript`: `^5.4.0`
         - `@types/node`: `^20.0.0`
         - `@types/ws`: `^8.5.0`
         - `eslint`: `^8.56.0`
         - `@typescript-eslint/parser`: `^7.0.0`
         - `@typescript-eslint/eslint-plugin`: `^7.0.0`
         - `vitest`: `^1.3.0` (replacing mocha+chai)
         - `tsx`: `^4.7.0` (for running TS directly in dev)
       - Scripts:
         - `"dev"`: `"tsx watch src/server/index.ts"`
         - `"build"`: `"tsc"`
         - `"start"`: `"node dist/server/index.js"`
         - `"test"`: `"vitest run"`
         - `"test:watch"`: `"vitest"`
         - `"lint"`: `"eslint src/ --ext .ts"`
       - Remove: `notepack`, `q`, `lodash`, `jwt-simple`, `tslint`, `tsc-watch`, `babel-eslint`, `eslint-config-airbnb-es5`, `eslint-plugin-react`, `mocha`, `chai`

    3. Rewrite `tsconfig.json` for TypeScript 5:
       ```json
       {
         "compilerOptions": {
           "target": "ES2022",
           "module": "Node16",
           "moduleResolution": "Node16",
           "lib": ["ES2022"],
           "outDir": "./dist",
           "rootDir": "./src",
           "strict": true,
           "esModuleInterop": true,
           "skipLibCheck": true,
           "forceConsistentCasingInFileNames": true,
           "resolveJsonModule": true,
           "declaration": true,
           "declarationMap": true,
           "sourceMap": true
         },
         "include": ["src/**/*"],
         "exclude": ["node_modules", "dist", "test"]
       }
       ```

    4. Add new env vars to `.env.example` (append to existing, keep all current vars):
       ```
       # mediasoup
       MEDIASOUP_MIN_PORT=40000
       MEDIASOUP_MAX_PORT=49999
       MEDIASOUP_LISTEN_IP=0.0.0.0
       MEDIASOUP_ANNOUNCED_IP=
       MEDIASOUP_LOG_LEVEL=warn

       # STUN/TURN
       STUN_SERVER=stun:stun.l.google.com:19302
       TURN_SERVER=
       TURN_USERNAME=
       TURN_PASSWORD=
       ```
       Note: Google STUN is only for development. Production deployments should use self-hosted Coturn (per research anti-patterns).

    5. Run `npm install` to verify all dependencies resolve. Fix any peer dependency conflicts.

    6. Run `npx tsc --noEmit` to verify TypeScript compiles (will have errors until source files exist, but config should be valid).

    IMPORTANT: Do NOT delete the existing `src/lib/` directory or `src/app.ts`. Those remain as the legacy router code. The new audio stack lives in `src/server/` and `src/shared/`. Per user decision, this is a clean replacement of the vp-router container, but we preserve the old code during development for reference.
  </action>
  <verify>
    - `node --version` shows v20.x
    - `npm install` completes without errors
    - `npx tsc --version` shows v5.x
    - `npm run lint` runs (may show warnings, but no config errors)
  </verify>
  <done>
    Node.js 20 LTS configured, TypeScript 5 compiles, all mediasoup/WebRTC dependencies installed, build scripts work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared types, signaling protocol, and server scaffold</name>
  <files>
    src/shared/types.ts
    src/shared/protocol.ts
    src/server/config.ts
    src/server/index.ts
  </files>
  <action>
    1. Create `src/shared/types.ts` with shared type definitions used by both server and client:
       - `ChannelState`: `{ channelId: string; currentSpeaker: string | null; speakerName: string | null; isBusy: boolean; lockTimestamp: number | null; }`
       - `UserSession`: `{ userId: string; userName: string; deviceId: string; connectedAt: number; channels: string[]; }`
       - `TransportOptions`: `{ id: string; iceParameters: object; iceCandidates: object[]; dtlsParameters: object; }`
       - `ProducerInfo`: `{ id: string; kind: string; userId: string; channelId: string; }`
       - `PttMode`: enum with `HOLD_TO_TALK = 'hold'` and `TOGGLE = 'toggle'`
       - `PttState`: enum with `IDLE = 'idle'`, `TRANSMITTING = 'transmitting'`, `BLOCKED = 'blocked'`
       - `SpeakerLockResult`: `{ acquired: boolean; currentSpeaker?: string; currentSpeakerName?: string; }`

    2. Create `src/shared/protocol.ts` defining the signaling message contract between client and server. This is the API contract that Plans 02 (server) and 04 (client) both implement against:
       - `SignalingType` enum with values:
         - `JOIN_CHANNEL = 'join-channel'`
         - `LEAVE_CHANNEL = 'leave-channel'`
         - `GET_ROUTER_CAPABILITIES = 'get-router-capabilities'`
         - `CREATE_TRANSPORT = 'create-transport'`
         - `CONNECT_TRANSPORT = 'connect-transport'`
         - `PRODUCE = 'produce'`
         - `CONSUME = 'consume'`
         - `PTT_START = 'ptt-start'`
         - `PTT_STOP = 'ptt-stop'`
         - `PTT_DENIED = 'ptt-denied'`
         - `SPEAKER_CHANGED = 'speaker-changed'`
         - `CHANNEL_STATE = 'channel-state'`
         - `ERROR = 'error'`
         - `PING = 'ping'`
         - `PONG = 'pong'`
       - `SignalingMessage` type: `{ type: SignalingType; id?: string; data?: Record<string, unknown>; error?: string; }`
       - `SignalingRequest` and `SignalingResponse` types that extend SignalingMessage with required `id` field for request-response correlation
       - Export helper function `createMessage(type, data?, id?)` that creates a properly typed SignalingMessage

    3. Create `src/server/config.ts` for server configuration:
       - Load dotenv at import time
       - Export `config` object with sections:
         - `server`: `{ port, host }` from env
         - `mediasoup`: `{ numWorkers: os.cpus().length, worker: { logLevel, rtcMinPort, rtcMaxPort }, router: { mediaCodecs }` with Opus configured per research: `audio/opus`, 48000 clockRate, 1 channel, `usedtx: 0`, `ptime: 20` (start with 20ms per research recommendation, optimize to 10ms if needed)
         - `webrtc`: `{ listenIps, enableUdp: true, enableTcp: true, preferUdp: true }`
         - `redis`: `{ url }` constructed from REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
         - `stun`: parsed from STUN_SERVER env
         - `turn`: parsed from TURN_SERVER, TURN_USERNAME, TURN_PASSWORD env (optional)
         - `auth`: `{ jwtSecret: ROUTER_JWT_SECRET }`
         - `ptt`: `{ lockTtlSeconds: 30, busyTimeoutMs: 30000 }`

    4. Create `src/server/index.ts` as a minimal entry point:
       - Import config
       - Import http module
       - Create HTTP server
       - Log startup message with port using Winston
       - Start listening
       - This is a placeholder that subsequent plans will expand with mediasoup workers and WebSocket server
       - Include a `/health` endpoint that returns `{ status: 'ok', uptime: process.uptime() }`

    5. Verify `npx tsc --noEmit` compiles without errors on the new files.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `src/shared/protocol.ts` exports SignalingType enum with all 15 message types
    - `src/shared/types.ts` exports all shared types
    - `src/server/config.ts` exports config object with mediasoup settings
    - `tsx src/server/index.ts` starts and responds to GET /health with 200
  </verify>
  <done>
    Shared types and signaling protocol contract are defined. Server scaffold starts, compiles, and serves /health endpoint. All subsequent plans can import from shared types without modification.
  </done>
</task>

</tasks>

<verification>
1. `node --version` returns v20.x
2. `npm install` completes cleanly
3. `npx tsc` compiles all source files to `dist/`
4. `npm run dev` starts the server
5. `curl http://localhost:3000/health` returns `{ "status": "ok" }`
6. Import `SignalingType` from `src/shared/protocol.ts` resolves in any TypeScript file
</verification>

<success_criteria>
- Node.js 20 LTS runtime active
- TypeScript 5.4+ compiles cleanly with strict mode
- mediasoup 3.19.x installed (verify with `node -e "require('mediasoup')"`)
- All shared types importable from `src/shared/`
- Server starts and serves /health
- No legacy dependency remains in node_modules that blocks modern code
</success_criteria>

<output>
After completion, create `.planning/phases/01-webrtc-audio-foundation/01-01-SUMMARY.md`
</output>
