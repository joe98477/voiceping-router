---
phase: 15-release-build-validation-device-testing
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Release APK installs and launches on physical Android device without JNI crashes"
    - "End-to-end audio works: user can transmit via PTT and receive remote audio"
    - "Battery drain is under 10%/hour with screen off and channel monitoring active"
  artifacts: []
  key_links: []
---

<objective>
Verify end-to-end audio functionality on a physical Android device and profile battery consumption during background channel monitoring.

Purpose: VALID-02 and VALID-03 require physical device testing that cannot be automated. This plan provides the structured testing protocol and verification checkpoints for the user to execute on real hardware.

Output: Verified release APK on physical device, battery profiling results
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-release-build-validation-device-testing/15-RESEARCH.md
@.planning/phases/15-release-build-validation-device-testing/15-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Install release APK on physical device and verify end-to-end audio</name>
  <what-built>
Release APK built in Plan 15-01 with comprehensive ProGuard/R8 rules preserving JNI classes for WebRTC and mediasoup. The APK is unsigned but installable via adb.
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Physical Android device (SDK 26+ / Android 8.0+) connected via USB
- USB debugging enabled on device
- Server running at the configured SERVER_URL
- At least one other client connected (web browser or second device) for audio testing

**Install the release APK:**
```bash
cd /home/earthworm/Github-repos/voiceping-router/android
adb install -r app/build/outputs/apk/release/app-release-unsigned.apk
```

If install fails with "INSTALL_PARSE_FAILED_NO_CERTIFICATES", sign the APK first:
```bash
# Create a debug keystore for testing (one-time)
keytool -genkey -v -keystore debug-release.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Test"

# Sign the APK
apksigner sign --ks debug-release.keystore --ks-pass pass:android app/build/outputs/apk/release/app-release-unsigned.apk

# Install
adb install -r app/build/outputs/apk/release/app-release-unsigned.apk
```

**Test checklist (monitor logcat in separate terminal):**
```bash
adb logcat | grep -E "(VoicePing|MediasoupClient|WebRTC|FATAL|AndroidRuntime|UnsatisfiedLinkError|NoSuchMethodError)"
```

1. **Login** — Enter credentials, tap Login. Expect: Login succeeds, event picker shows.
2. **Select event** — Pick an event. Expect: Channel list loads.
3. **Join channel** — Tap a channel to join. Expect: Channel joined, RecvTransport created (check logcat for "createRecvTransport" log).
4. **Receive audio** — Have another client transmit on the same channel. Expect: Audio plays from device speaker. No crashes.
5. **Transmit audio (PTT)** — Press and hold the PTT button, speak. Expect: SendTransport and Producer created (check logcat), remote client hears audio.
6. **Release PTT** — Release button. Expect: Producer closed cleanly, no errors in logcat.
7. **Monitor channels** — Join additional channels. Expect: Multiple RecvTransports created, audio from any active channel plays.
8. **Background operation** — Press home button, verify foreground service notification appears. PTT should still work via notification or hardware buttons.

**Critical failure signals (any of these = FAIL):**
- `UnsatisfiedLinkError` in logcat → ProGuard rules missing a JNI class
- `NoSuchMethodError` in logcat → ProGuard stripped a method called by JNI
- App crash on channel join → Transport creation failure
- No audio playback → Consumer creation or AudioTrack issue
- No audio transmission → Producer creation or AudioSource issue
  </how-to-verify>
  <resume-signal>Type "approved" if all 8 test steps pass. If any failures, describe the error and paste relevant logcat output.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Profile battery consumption during background channel monitoring</name>
  <what-built>
The app runs as a foreground service with WebRTC audio threads during screen-off operation. This test measures real-world battery drain to verify the 10%/hour threshold from VALID-03.
  </what-built>
  <how-to-verify>
**Setup battery profiling:**
```bash
# Reset battery stats
adb shell dumpsys batterystats --reset
adb shell dumpsys batterystats --enable full-wake-history

# Note starting battery percentage
adb shell dumpsys battery | grep level
```

**Run the test:**
1. Open VoicePing app on device
2. Login and join a channel (ensure channel is being monitored)
3. Turn off screen (lock the device)
4. Leave device idle for at least 30 minutes (longer is better — 1-2 hours ideal)
5. Periodically check if foreground service notification is still active
6. After test period, unlock device

**Collect results:**
```bash
# Note ending battery percentage
adb shell dumpsys battery | grep level

# Collect battery stats
adb shell dumpsys batterystats > /home/earthworm/Github-repos/voiceping-router/batterystats.txt

# Optional: generate bugreport for Battery Historian analysis
adb bugreport /home/earthworm/Github-repos/voiceping-router/bugreport.zip
```

**Calculate drain rate:**
- Drain rate = (start_level - end_level) / hours_elapsed
- Success criterion: under 10%/hour

**What to look for in batterystats:**
```bash
# Check wake locks held by VoicePing
grep -A 5 "com.voiceping.android" batterystats.txt | grep -i "wake"
```

**Optional: Battery Historian analysis:**
Upload bugreport.zip to https://bathist.ef.lc/ for visual timeline of wake locks, CPU usage, and per-app power consumption.

**Acceptable results:**
- Under 5%/hour: Excellent — no optimization needed
- 5-10%/hour: Acceptable — meets VALID-03 threshold
- Over 10%/hour: Needs investigation — check wake lock durations, WebRTC thread activity
  </how-to-verify>
  <resume-signal>Type "approved" with the measured drain rate (e.g., "approved - 6%/hour over 2 hours"). If drain exceeds 10%/hour, describe findings and paste wake lock info.</resume-signal>
</task>

</tasks>

<verification>
1. Release APK installs on physical Android device via adb
2. Login, event selection, and channel join work without crashes
3. PTT transmission creates Producer and remote client receives audio
4. Audio reception from remote client plays through device speaker
5. No UnsatisfiedLinkError or NoSuchMethodError in logcat
6. Background foreground service remains active with screen off
7. Battery drain is under 10%/hour during screen-off channel monitoring
</verification>

<success_criteria>
- VALID-02 satisfied: Release APK tested on physical Android device with end-to-end audio (transmit and receive)
- VALID-03 satisfied: Battery profiling shows under 10%/hour drain with screen off
- No JNI class stripping errors encountered at runtime
</success_criteria>

<output>
After completion, create `.planning/phases/15-release-build-validation-device-testing/15-02-SUMMARY.md`
</output>
