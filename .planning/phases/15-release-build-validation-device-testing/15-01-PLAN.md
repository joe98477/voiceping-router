---
phase: 15-release-build-validation-device-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/proguard-rules.pro
autonomous: true

must_haves:
  truths:
    - "Release APK builds successfully with R8 minification enabled"
    - "ProGuard rules preserve all JNI classes from WebRTC and crow-misia mediasoup libraries"
    - "ProGuard rules preserve native method signatures and CalledByNative annotations"
    - "Hilt DI generated classes are preserved in release build"
  artifacts:
    - path: "android/app/proguard-rules.pro"
      provides: "Comprehensive R8 keep rules for JNI, WebRTC, mediasoup, Hilt"
      contains: "io.github.crow_misia.mediasoup"
  key_links:
    - from: "android/app/proguard-rules.pro"
      to: "io.github.crow_misia.mediasoup"
      via: "-keep class rule"
      pattern: "keep class io\\.github\\.crow_misia\\.mediasoup"
    - from: "android/app/proguard-rules.pro"
      to: "native methods"
      via: "-keepclasseswithmembernames rule"
      pattern: "native <methods>"
---

<objective>
Update ProGuard/R8 rules to preserve JNI classes from WebRTC and crow-misia mediasoup libraries, then verify the release APK builds successfully.

Purpose: The existing proguard-rules.pro is missing keep rules for the `io.github.crow_misia.mediasoup` package (the actual library used in imports), native method preservation, `@CalledByNative` annotation preservation, and Hilt DI rules. Without these, R8 will strip JNI classes in release builds, causing UnsatisfiedLinkError or NoSuchMethodError at runtime.

Output: Updated proguard-rules.pro with comprehensive rules, successful `assembleRelease` build
</objective>

<execution_context>
@/home/earthworm/.claude/get-shit-done/workflows/execute-plan.md
@/home/earthworm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-release-build-validation-device-testing/15-RESEARCH.md
@android/app/proguard-rules.pro
@android/app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ProGuard/R8 rules with comprehensive JNI and library preservation</name>
  <files>android/app/proguard-rules.pro</files>
  <action>
Replace the entire contents of `android/app/proguard-rules.pro` with comprehensive rules. The current file has baseline rules but is missing critical entries.

**Rules to ADD (missing from current file):**

1. **crow-misia mediasoup package** — The actual library package is `io.github.crow_misia.mediasoup`, not just `org.mediasoup`. The app imports `Device`, `Consumer`, `Producer`, `RecvTransport`, `SendTransport`, `Transport` from this package. Add:
   ```proguard
   -keep class io.github.crow_misia.mediasoup.** { *; }
   -keepclassmembers class io.github.crow_misia.mediasoup.** { *; }
   ```

2. **WebRTC interfaces** — Add interface preservation alongside class preservation:
   ```proguard
   -keep interface org.webrtc.** { *; }
   ```

3. **Native method signatures** — JNI methods called from Java/Kotlin to C++:
   ```proguard
   -keepclasseswithmembernames,includedescriptorclasses class * {
       native <methods>;
   }
   ```

4. **@CalledByNative annotation** — WebRTC marks JNI upcall targets with this annotation:
   ```proguard
   -keepclassmembers class * {
       @org.webrtc.CalledByNative <methods>;
   }
   ```

5. **Hilt DI** — Hilt uses code generation that R8 may strip:
   ```proguard
   -keep class dagger.hilt.** { *; }
   -keep class javax.inject.** { *; }
   -keep class * extends dagger.hilt.android.internal.managers.ViewComponentManager$FragmentContextWrapper { *; }
   ```

**Rules to KEEP (already correct in current file):**
- `org.mediasoup.**` keep rules (alternative package name, keep for safety)
- `org.webrtc.**` keep rules
- Gson/serialization attribute preservation
- `com.voiceping.android.data.model.**` and `com.voiceping.android.domain.model.**` keep rules
- OkHttp/Okio `-dontwarn` rules
- Retrofit annotation and method preservation

**Structure the file with clear section headers** (see 15-RESEARCH.md "Verified ProGuard Rules" code example for reference). Include a comment header noting the file was updated for Phase 15 validation and listing the library versions (libmediasoup-android 0.21.0, AGP 9.0.0).

Do NOT add `-dontobfuscate` — we want full R8 optimization. Do NOT add a temporary debugging section.
  </action>
  <verify>
Read the updated file and confirm it contains:
1. `io.github.crow_misia.mediasoup` keep rules
2. `native <methods>` preservation
3. `@org.webrtc.CalledByNative` preservation
4. Hilt/Dagger keep rules
5. All original rules still present
  </verify>
  <done>proguard-rules.pro contains comprehensive R8 keep rules for all JNI libraries (WebRTC, crow-misia mediasoup, org.mediasoup), native methods, CalledByNative annotations, Hilt DI, and app model classes</done>
</task>

<task type="auto">
  <name>Task 2: Build release APK and verify no R8 errors</name>
  <files>android/app/proguard-rules.pro</files>
  <action>
Run the release build to verify the updated ProGuard rules work correctly with R8:

```bash
cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew assembleRelease
```

**Expected output:** BUILD SUCCESSFUL with `app-release-unsigned.apk` produced at `android/app/build/outputs/apk/release/app-release-unsigned.apk`.

**What to check in build output:**
1. No "can't find referenced class" warnings for `org.webrtc`, `io.github.crow_misia.mediasoup`, or `org.mediasoup` packages
2. No "unresolved references" errors related to JNI classes
3. Build completes without R8-related errors
4. The APK file exists at the expected output path

**If build fails with R8 errors:**
- If "can't find referenced class" for a mediasoup/webrtc class: add the missing class to proguard-rules.pro
- If "duplicate class" errors: check for conflicting keep rules
- If signing-related errors: this is expected (no signing config), the APK will be unsigned — that is fine for VALID-01

The release build type already has `isMinifyEnabled = true` in build.gradle.kts, which enables R8 code shrinking and obfuscation.

Note: The build may produce an unsigned APK since there's no signing configuration — this is expected and acceptable for VALID-01 (ProGuard rule verification). Physical device installation (VALID-02) is handled in plan 15-02.
  </action>
  <verify>
Run `cd /home/earthworm/Github-repos/voiceping-router/android && ./gradlew assembleRelease` and confirm:
1. Build exits with "BUILD SUCCESSFUL"
2. APK file exists: `ls -la android/app/build/outputs/apk/release/`
3. No R8 warnings about missing WebRTC or mediasoup classes in build log
  </verify>
  <done>Release APK builds successfully with R8 minification enabled and updated ProGuard rules, no JNI class stripping warnings</done>
</task>

</tasks>

<verification>
1. `android/app/proguard-rules.pro` contains `-keep class io.github.crow_misia.mediasoup.** { *; }` rule
2. `android/app/proguard-rules.pro` contains `-keepclasseswithmembernames` rule for `native <methods>`
3. `android/app/proguard-rules.pro` contains `@org.webrtc.CalledByNative` preservation
4. `cd android && ./gradlew assembleRelease` completes with BUILD SUCCESSFUL
5. Release APK exists at `android/app/build/outputs/apk/release/`
</verification>

<success_criteria>
- ProGuard rules updated with all missing JNI, native method, and Hilt preservation rules
- Release APK builds successfully with R8 minification enabled (no class stripping errors)
- VALID-01 requirement satisfied: ProGuard/R8 rules verified, release build doesn't strip JNI classes
</success_criteria>

<output>
After completion, create `.planning/phases/15-release-build-validation-device-testing/15-01-SUMMARY.md`
</output>
